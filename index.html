<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- PWA Head Tags -->
    <link rel="icon" href="./favicon.ico" type="image/x-icon" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./assets/images/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./assets/images/favicon-16x16.png"
    />

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./assets/images/icon-180x180.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="./assets/images/icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="167x167"
      href="./assets/images/icon-167x167.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="./assets/images/icon-120x120.png"
    />

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json" />

    <!-- Theme Colors -->
    <meta name="theme-color" content="#38bdf8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="msapplication-TileColor" content="#38bdf8" />
    <meta name="msapplication-TileImage" content="/assets/images/mstile-150x150.png" />
    <title>Study Companion</title>
    <meta
      name="description"
      content="Anime-style Pomodoro timer with focus companions, achievements, and productivity analytics. Stay focused with Arona and Plana!"
    />
    <meta name="theme-color" content="#38bdf8" />

    <!-- Meta tags untuk social sharing -->
    <meta property="og:title" content="Study Companion - Anime Pomodoro Timer" />
    <meta property="og:description" content="Focus with Arona & Plana - Your anime study partner for better focus & productivity" />
    <meta property="og:image" content="/assets/images/social-preview.png" />
    <meta property="og:url" content="https://yourwebsite.com" />
    <meta name="twitter:card" content="summary_large_image" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        overflow-x: hidden;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: "Inter", sans-serif;
        min-height: 100vh;
        background-attachment: fixed;
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
      }

      main {
        flex: 1 0 auto;
        width: 100%;
      }

      .timer-controls button:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }

      .music-controls button:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }

      .theme-toggle-btn:active {
        transform: scale(0.95) rotate(15deg);
        transition: transform 0.1s ease;
      }

      .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 8px;
        min-height: 20px;
      }

      .skeleton-circle {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 50%;
        width: 24px;
        height: 24px;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .site-footer {
        flex-shrink: 0;
        width: 100%;
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 24px 24px 0 0;
        transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        margin-top: auto;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        padding: 20px 0;
        cursor: grab;
        position: relative;
        transform-origin: center top;
      }

      .site-footer:active {
        cursor: grabbing;
        transform: scaleY(0.95);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .site-footer.pulled {
        transform: translateY(-40px) scaleY(1.05);
        border-radius: 20px;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .site-footer.released {
        transform: translateY(0) scaleY(1);
        transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .theme-arona .site-footer {
        background: rgba(255, 255, 255, 0.95);
        border-top-color: rgba(56, 189, 248, 0.3);
        color: #0c4a6e;
      }

      .theme-plana .site-footer {
        background: rgba(255, 255, 255, 0.95);
        border-top-color: rgba(192, 132, 252, 0.3);
        color: #4a044e;
      }

      .footer-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
      }

      .footer-brand {
        text-align: center;
      }

      .footer-brand h3 {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 1.25rem;
      }

      .footer-brand p {
        opacity: 0.8;
        font-size: 0.875rem;
      }

      .donation-section {
        text-align: center;
        width: 100%;
      }

      .donation-title {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .donation-links {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 1rem;
        width: 100%;
      }

      .donation-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        min-width: 140px;
      }

      .theme-arona .donation-btn {
        background: rgba(56, 189, 248, 0.1);
        color: #0c4a6e;
        border-color: rgba(56, 189, 248, 0.3);
      }

      .theme-arona .donation-btn:hover {
        background: rgba(56, 189, 248, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(56, 189, 248, 0.2);
      }

      .theme-plana .donation-btn {
        background: rgba(192, 132, 252, 0.1);
        color: #4a044e;
        border-color: rgba(192, 132, 252, 0.3);
      }

      .theme-plana .donation-btn:hover {
        background: rgba(192, 132, 252, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(192, 132, 252, 0.2);
      }

      .donation-btn .heart {
        color: #ef4444;
        animation: heartbeat 1.5s ease-in-out infinite;
      }

      @keyframes heartbeat {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .donation-btn svg {
        width: 20px;
        height: 20px;
      }

      .footer-bottom {
        text-align: center;
        width: 100%;
        padding-top: 1rem;
        border-top: 1px solid;
        font-size: 0.875rem;
        opacity: 0.7;
      }

      .theme-arona .footer-bottom {
        border-top-color: rgba(56, 189, 248, 0.2);
      }

      .theme-plana .footer-bottom {
        border-top-color: rgba(192, 132, 252, 0.2);
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .sr-only:focus,
      .sr-only:focus-visible {
        position: static;
        width: auto;
        height: auto;
        padding: 1rem;
        margin: 0;
        overflow: visible;
        clip: auto;
        white-space: normal;
        background: white;
        border-radius: 4px;
        z-index: 10000;
        border: 2px solid currentColor;
      }

      button:focus-visible,
      input:focus-visible {
        outline: 2px solid currentColor;
        outline-offset: 2px;
        border-radius: 4px;
      }

      .glass:focus-within {
        outline: 2px solid rgba(56, 189, 248, 0.5);
        outline-offset: 2px;
      }

      @media (prefers-contrast: high) {
        .glass {
          border: 2px solid;
        }

        .theme-arona .glass {
          border-color: #0c4a6e;
        }

        .theme-plana .glass {
          border-color: #4a044e;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }

        .float {
          animation: none;
        }

        .visualizer-bar {
          animation: none;
          height: 50% !important;
        }

        .donation-btn .heart {
          animation: none;
        }

        .timer-controls button:active {
          transform: none;
        }

        .skeleton,
        .skeleton-circle {
          animation: none;
        }
      }

      .theme-arona {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
        color: #0c4a6e;
      }

      .theme-arona .glass {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(56, 189, 248, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .theme-arona .glow-box {
        box-shadow: 0 0 25px rgba(56, 189, 248, 0.3),
          inset 0 0 15px rgba(56, 189, 248, 0.1);
      }

      .theme-arona .character-glow {
        background: radial-gradient(circle, rgba(56, 189, 248, 0.3) 0%, transparent 70%);
      }

      .theme-arona .progress-fill {
        background: linear-gradient(90deg, #38bdf8, #0ea5e9);
      }

      .theme-arona .visualizer-bar {
        background-color: #38bdf8;
      }

      .theme-arona .text-primary {
        color: #38bdf8;
      }

      .theme-arona .bg-primary {
        background-color: #38bdf8;
      }

      .theme-arona .bg-primary-opacity {
        background-color: rgba(56, 189, 248, 0.2);
      }

      .theme-arona .bg-pattern {
        background-image: radial-gradient(
            circle at 20% 30%,
            rgba(56, 189, 248, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(56, 189, 248, 0.1) 0%,
            transparent 50%
          );
      }

      .theme-plana {
        background: linear-gradient(135deg, #fff5f5 0%, #fef7ff 50%, #faf0ff 100%);
        color: #4a044e;
      }

      .theme-plana .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(192, 132, 252, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .theme-plana .glow-box {
        box-shadow: 0 0 25px rgba(192, 132, 252, 0.3),
          inset 0 0 15px rgba(192, 132, 252, 0.1);
      }

      .theme-plana .character-glow {
        background: radial-gradient(circle, rgba(192, 132, 252, 0.3) 0%, transparent 70%);
      }

      .theme-plana .progress-fill {
        background: linear-gradient(90deg, #c084fc, #a855f7);
      }

      .theme-plana .visualizer-bar {
        background-color: #c084fc;
      }

      .theme-plana .text-primary {
        color: #c084fc;
      }

      .theme-plana .bg-primary {
        background-color: #c084fc;
      }

      .theme-plana .bg-primary-opacity {
        background-color: rgba(192, 132, 252, 0.2);
      }

      .theme-plana .bg-pattern {
        background-image: radial-gradient(
            circle at 20% 30%,
            rgba(192, 132, 252, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(192, 132, 252, 0.1) 0%,
            transparent 50%
          );
      }

      .theme-arona .timer-controls button {
        color: #475569 !important;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .theme-arona .timer-controls button.bg-primary {
        color: white !important;
        font-weight: 600;
      }

      .theme-arona .timer-controls button:hover {
        color: #334155 !important;
      }

      .theme-plana .timer-controls button {
        color: #6b7280 !important;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .theme-plana .timer-controls button.bg-primary {
        color: white !important;
        font-weight: 600;
      }

      .theme-plana .timer-controls button:hover {
        color: #4b5563 !important;
      }

      .theme-arona #reset-timer {
        color: #64748b !important;
        background-color: #e2e8f0 !important;
      }

      .theme-arona #reset-timer:hover {
        color: #475569 !important;
        background-color: #cbd5e1 !important;
      }

      .theme-plana #reset-timer {
        color: #9ca3af !important;
        background-color: #f3f4f6 !important;
      }

      .theme-plana #reset-timer:hover {
        color: #6b7280 !important;
        background-color: #e5e7eb !important;
      }

      .theme-arona .playlist-container .text-sm {
        color: #0c4a6e !important;
        font-weight: 600;
      }

      .theme-arona .playlist-container .text-xs.text-gray-400 {
        color: #475569 !important;
        font-weight: 500;
      }

      .theme-plana .playlist-container .text-sm {
        color: #4a044e !important;
        font-weight: 600;
      }

      .theme-plana .playlist-container .text-xs.text-gray-400 {
        color: #6b7280 !important;
        font-weight: 500;
      }

      .theme-arona .analytics-content {
        color: #0c4a6e;
      }

      .theme-arona .analytics-content .text-gray-600 {
        color: #475569 !important;
        font-weight: 500;
      }

      .theme-arona .analytics-content .bg-primary-opacity {
        background: rgba(56, 189, 248, 0.15);
        border: 1px solid rgba(56, 189, 248, 0.2);
      }

      .theme-arona #weekly-stats span {
        color: #0c4a6e;
        font-weight: 600;
      }

      .theme-arona #weekly-stats span.font-semibold {
        color: #0369a1;
        font-weight: 700;
      }

      .theme-plana .analytics-content {
        color: #4a044e;
      }

      .theme-plana .analytics-content .text-gray-600 {
        color: #6b7280 !important;
        font-weight: 500;
      }

      .theme-plana .analytics-content .bg-primary-opacity {
        background: rgba(192, 132, 252, 0.15);
        border: 1px solid rgba(192, 132, 252, 0.2);
      }

      .theme-plana #weekly-stats span {
        color: #4a044e;
        font-weight: 600;
      }

      .theme-plana #weekly-stats span.font-semibold {
        color: #7c3aed;
        font-weight: 700;
      }

      .theme-arona .analytics-content .progress-bar {
        background: rgba(12, 74, 110, 0.25);
        height: 8px;
      }

      .theme-plana .analytics-content .progress-bar {
        background: rgba(74, 4, 78, 0.25);
        height: 8px;
      }

      .theme-arona .glass {
        color: #0c4a6e;
      }

      .theme-plana .glass {
        color: #4a044e;
      }

      .theme-arona #progress-title {
        color: #0c4a6e;
        font-weight: 700;
      }

      .theme-plana #progress-title {
        color: #4a044e;
        font-weight: 700;
      }

      .theme-arona #analytics-btn {
        color: #0369a1;
        font-weight: 600;
      }

      .theme-plana #analytics-btn {
        color: #7c3aed;
        font-weight: 600;
      }

      .theme-arona #current-track-display {
        color: #0c4a6e !important;
        font-weight: 600;
      }

      .theme-arona #current-artist {
        color: #475569 !important;
        font-weight: 500;
      }

      .theme-plana #current-track-display {
        color: #4a044e !important;
        font-weight: 600;
      }

      .theme-plana #current-artist {
        color: #6b7280 !important;
        font-weight: 500;
      }

      .glass {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .character-glow {
        position: absolute;
        width: 400px;
        height: 400px;
        filter: blur(60px);
        animation: pulse 3s ease-in-out infinite;
        pointer-events: none;
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.6;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .float {
        animation: float 4s ease-in-out infinite;
      }

      .bg-pattern {
        background-attachment: fixed;
        background-size: cover;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        overflow: hidden;
      }

      .theme-arona .progress-bar {
        background: rgba(12, 74, 110, 0.15);
      }

      .theme-plana .progress-bar {
        background: rgba(74, 4, 78, 0.15);
      }

      .progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .visualizer-bar {
        animation: visualizer 1.5s ease-in-out infinite alternate;
      }

      @keyframes visualizer {
        0% {
          transform: scaleY(0.3);
        }
        100% {
          transform: scaleY(1);
        }
      }

      .theme-transition {
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .text-gray-300 {
        color: #64748b;
      }

      .theme-plana .text-gray-300 {
        color: #6b7280;
      }

      .text-gray-400 {
        color: #94a3b8;
      }

      .theme-plana .text-gray-400 {
        color: #9ca3af;
      }

      .bg-gray-600 {
        background-color: #cbd5e1;
      }

      .bg-gray-700 {
        background-color: #e2e8f0;
      }

      .character-transform {
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .character-transform:hover {
        transform: scale(1.05);
      }

      .fade-text {
        transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        pointer-events: none;
        opacity: 0;
      }

      .theme-arona .particle {
        background: #38bdf8;
      }

      .theme-plana .particle {
        background: #c084fc;
      }

      @keyframes particle-float {
        0% {
          transform: translateY(0) translateX(0);
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) translateX(var(--tx, 0));
          opacity: 0;
        }
      }

      .character-fallback {
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .character-fallback:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      }

      .character-fallback:focus {
        outline: 2px solid currentColor;
        outline-offset: 2px;
      }

      .achievement-badge {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        border-radius: 16px;
        margin: 5px;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
        padding: 8px;
        border: 2px solid transparent;
      }

      .achievement-unlocked {
        background: linear-gradient(
          135deg,
          var(--primary-color, #38bdf8),
          var(--secondary-color, #0ea5e9)
        );
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transform: scale(1.05);
      }

      .achievement-locked {
        background: rgba(255, 255, 255, 0.5);
        border: 2px dashed rgba(0, 0, 0, 0.2);
        filter: grayscale(1);
        opacity: 0.7;
      }

      .achievement-icon {
        width: 48px;
        height: 48px;
        object-fit: contain;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        transition: transform 0.2s ease;
        margin-bottom: 4px;
      }

      .achievement-badge:hover .achievement-icon {
        transform: scale(1.1);
      }

      .achievement.locked .achievement-icon {
        filter: grayscale(100%);
        opacity: 0.4;
      }

      .achievement.unlocked .achievement-icon {
        filter: drop-shadow(0 0 6px rgba(80, 160, 255, 0.6));
      }

      .achievement-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 10;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .achievement-badge:hover .achievement-tooltip {
        opacity: 1;
      }

      .achievement-progress {
        font-size: 10px;
        margin-top: 2px;
        font-weight: 600;
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 6px;
        border-radius: 8px;
      }

      .achievement-rare {
        border: 2px solid gold;
        box-shadow: 0 0 15px gold;
      }

      .achievement-common {
        border: 2px solid silver;
      }

      .progress-ring {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: conic-gradient(
          var(--primary-color) 0% var(--progress),
          #e5e7eb var(--progress) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        position: relative;
      }

      .progress-ring::before {
        content: "";
        position: absolute;
        width: 50px;
        height: 50px;
        background: white;
        border-radius: 50%;
        z-index: 1;
      }

      .progress-ring span {
        position: relative;
        z-index: 2;
      }

      #splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 1s ease, transform 1s ease;
      }

      .theme-arona #splash-screen {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
      }

      .theme-plana #splash-screen {
        background: linear-gradient(135deg, #fff5f5 0%, #fef7ff 50%, #faf0ff 100%);
      }

      .splash-logo {
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 1rem;
        transition: all 0.8s ease;
      }

      .theme-arona .splash-logo {
        background: linear-gradient(135deg, #38bdf8, #0ea5e9);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .theme-plana .splash-logo {
        background: linear-gradient(135deg, #c084fc, #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .splash-loader {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .theme-arona .splash-loader {
        border: 3px solid rgba(56, 189, 248, 0.3);
        border-top: 3px solid #38bdf8;
      }

      .theme-plana .splash-loader {
        border: 3px solid rgba(192, 132, 252, 0.3);
        border-top: 3px solid #c084fc;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .page-transition {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .page-loaded {
        opacity: 1;
        transform: translateY(0);
      }

      .background-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .theme-arona .background-overlay {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
      }

      .theme-plana .background-overlay {
        background: linear-gradient(135deg, #fff5f5 0%, #fef7ff 50%, #faf0ff 100%);
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        backdrop-filter: blur(12px);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 300px;
      }

      .theme-arona .notification {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(56, 189, 248, 0.3);
      }

      .theme-plana .notification {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(192, 132, 252, 0.3);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        border-left: 4px solid #10b981;
      }

      .notification.info {
        border-left: 4px solid;
      }

      .theme-arona .notification.info {
        border-left-color: #38bdf8;
      }

      .theme-plana .notification.info {
        border-left-color: #c084fc;
      }

      .session-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .session-completed {
        background-color: #10b981;
      }

      .session-current {
        animation: pulse 2s infinite;
      }

      .theme-arona .session-current {
        background-color: #38bdf8;
      }

      .theme-plana .session-current {
        background-color: #c084fc;
      }

      .session-pending {
        background-color: #e5e7eb;
      }

      .theme-plana .session-pending {
        background-color: #e5e7eb;
      }

      .session-counter {
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        backdrop-filter: blur(8px);
      }

      .theme-arona .session-counter {
        background: rgba(56, 189, 248, 0.2);
        border: 1px solid rgba(56, 189, 248, 0.3);
        color: #0c4a6e;
      }

      .theme-plana .session-counter {
        background: rgba(192, 132, 252, 0.2);
        border: 1px solid rgba(192, 132, 252, 0.3);
        color: #7c3aed;
      }

      .playlist-number {
        width: 1.75rem;
        height: 1.75rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .playlist-active {
        color: white;
      }

      .theme-arona .playlist-active {
        background: rgba(56, 189, 248, 0.2);
        color: #0c4a6e;
      }

      .theme-plana .playlist-active {
        background: rgba(192, 132, 252, 0.2);
        color: #7c3aed;
      }

      .playlist-inactive {
        background: rgba(156, 163, 175, 0.1);
        color: #64748b;
      }

      .theme-plana .playlist-inactive {
        color: #6b7280;
      }

      .character-interaction {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 8px 12px;
        font-size: 12px;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        pointer-events: none;
        z-index: 5;
        max-width: 200px;
        word-wrap: break-word;
      }

      .character-interaction.show {
        opacity: 1;
        transform: translateY(0);
      }

      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 100;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .theme-toggle-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        backdrop-filter: blur(12px);
        cursor: pointer;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
      }

      .theme-arona .theme-toggle-btn {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(56, 189, 248, 0.3);
        box-shadow: 0 0 25px rgba(56, 189, 248, 0.3),
          inset 0 0 15px rgba(56, 189, 248, 0.1);
      }

      .theme-plana .theme-toggle-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(192, 132, 252, 0.3);
        box-shadow: 0 0 25px rgba(192, 132, 252, 0.3),
          inset 0 0 15px rgba(192, 132, 252, 0.1);
      }

      .theme-toggle-btn:hover {
        transform: scale(1.1) rotate(15deg);
      }

      .theme-toggle-btn:focus {
        outline: 2px solid currentColor;
        outline-offset: 2px;
      }

      .analytics-modal, .share-modal, .todo-modal, .journal-modal, .mood-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .analytics-modal.show, .share-modal.show, .todo-modal.show, .journal-modal.show, .mood-modal.show {
        opacity: 1;
        pointer-events: all;
      }

      .analytics-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .analytics-modal.show .analytics-content {
        transform: scale(1);
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .share-modal.show .modal-content,
      .todo-modal.show .modal-content,
      .journal-modal.show .modal-content,
      .mood-modal.show .modal-content {
        transform: scale(1);
      }

      .share-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.3s ease;
        width: 100%;
        margin-bottom: 0.5rem;
      }

      .share-btn:hover {
        transform: translateX(4px);
      }

      .theme-arona .share-btn {
        background: rgba(56, 189, 248, 0.1);
        color: #0c4a6e;
        border: 1px solid rgba(56, 189, 248, 0.3);
      }

      .theme-plana .share-btn {
        background: rgba(192, 132, 252, 0.1);
        color: #4a044e;
        border: 1px solid rgba(192, 132, 252, 0.3);
      }

      .share-btn-cancel {
        background: #f1f5f9 !important;
        color: #64748b !important;
        border: 1px solid #e2e8f0 !important;
        margin-top: 0.5rem;
      }

      .streak-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.3rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 700;
      }

      .theme-arona .streak-badge {
        background: rgba(251, 191, 36, 0.2);
        color: #92400e;
        border: 1px solid rgba(251, 191, 36, 0.4);
      }

      .theme-plana .streak-badge {
        background: rgba(251, 191, 36, 0.2);
        color: #92400e;
        border: 1px solid rgba(251, 191, 36, 0.4);
      }

      .todo-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 10px;
        margin-bottom: 0.4rem;
        transition: all 0.2s ease;
      }

      .theme-arona .todo-item {
        background: rgba(56, 189, 248, 0.06);
        border: 1px solid rgba(56, 189, 248, 0.15);
      }

      .theme-plana .todo-item {
        background: rgba(192, 132, 252, 0.06);
        border: 1px solid rgba(192, 132, 252, 0.15);
      }

      .todo-item.completed {
        opacity: 0.5;
      }

      .todo-item.completed .todo-text {
        text-decoration: line-through;
      }

      .todo-checkbox {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s ease;
      }

      .theme-arona .todo-checkbox {
        border-color: #38bdf8;
      }

      .theme-plana .todo-checkbox {
        border-color: #c084fc;
      }

      .todo-checkbox.checked {
        color: white;
      }

      .theme-arona .todo-checkbox.checked {
        background: #38bdf8;
        border-color: #38bdf8;
      }

      .theme-plana .todo-checkbox.checked {
        background: #c084fc;
        border-color: #c084fc;
      }

      .todo-text {
        font-size: 0.875rem;
        flex: 1;
      }

      .todo-delete {
        color: #94a3b8;
        cursor: pointer;
        font-size: 14px;
        padding: 2px 6px;
        border-radius: 4px;
        border: none;
        background: none;
        transition: color 0.2s;
      }

      .todo-delete:hover {
        color: #ef4444;
      }

      .todo-add-row {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
      }

      .todo-input {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        border: 1px solid;
        font-size: 0.875rem;
        outline: none;
      }

      .theme-arona .todo-input {
        border-color: rgba(56, 189, 248, 0.3);
        color: #0c4a6e;
      }

      .theme-plana .todo-input {
        border-color: rgba(192, 132, 252, 0.3);
        color: #4a044e;
      }

      .todo-add-btn {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        transition: opacity 0.2s;
      }

      .theme-arona .todo-add-btn {
        background: #38bdf8;
      }

      .theme-plana .todo-add-btn {
        background: #c084fc;
      }

      .todo-add-btn:hover {
        opacity: 0.85;
      }

      .mood-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.3rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 2px solid transparent;
        cursor: pointer;
        background: none;
        transition: all 0.2s ease;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .mood-btn:hover {
        transform: scale(1.05);
      }

      .mood-btn.selected {
        border-color: currentColor;
      }

      .theme-arona .mood-btn:hover, .theme-arona .mood-btn.selected {
        background: rgba(56, 189, 248, 0.1);
        border-color: #38bdf8;
        color: #0c4a6e;
      }

      .theme-plana .mood-btn:hover, .theme-plana .mood-btn.selected {
        background: rgba(192, 132, 252, 0.1);
        border-color: #c084fc;
        color: #4a044e;
      }

      .mood-emoji {
        font-size: 2rem;
      }

      .journal-textarea {
        width: 100%;
        min-height: 120px;
        padding: 0.75rem;
        border-radius: 10px;
        border: 1px solid;
        font-size: 0.875rem;
        font-family: inherit;
        resize: vertical;
        outline: none;
        transition: border-color 0.2s;
      }

      .theme-arona .journal-textarea {
        border-color: rgba(56, 189, 248, 0.3);
        color: #0c4a6e;
      }

      .theme-arona .journal-textarea:focus {
        border-color: #38bdf8;
      }

      .theme-plana .journal-textarea {
        border-color: rgba(192, 132, 252, 0.3);
        color: #4a044e;
      }

      .theme-plana .journal-textarea:focus {
        border-color: #c084fc;
      }

      .journal-entry {
        padding: 0.75rem;
        border-radius: 10px;
        margin-bottom: 0.75rem;
      }

      .theme-arona .journal-entry {
        background: rgba(56, 189, 248, 0.06);
        border-left: 3px solid #38bdf8;
      }

      .theme-plana .journal-entry {
        background: rgba(192, 132, 252, 0.06);
        border-left: 3px solid #c084fc;
      }

      .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        background: var(--confetti-color);
        opacity: 0;
        z-index: 9999;
      }

      .character-progress-container {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        margin-top: 15px;
        overflow: hidden;
      }

      .character-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #38bdf8, #0ea5e9);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .theme-plana .character-progress-fill {
        background: linear-gradient(90deg, #c084fc, #a855f7);
      }

      .character-progress-text {
        font-size: 0.75rem;
        margin-top: 5px;
        color: #64748b;
      }

      .theme-plana .character-progress-text {
        color: #6b7280;
      }

      .dragging {
        opacity: 0.8 !important;
        transition: none !important;
        cursor: grabbing !important;
      }

      #character-container {
        cursor: grab;
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
      }

      #character-container:active {
        cursor: grabbing;
      }

      #character-container img {
        pointer-events: none;
        -webkit-user-drag: none;
        user-drag: none;
      }

      .dragging {
        opacity: 0.7;
        transition: opacity 0.1s ease;
        cursor: grabbing;
      }

      @media (max-width: 768px) {
        .flex-col.lg\:flex-row {
          flex-direction: column;
        }

        .character-container img {
          width: 200px;
          height: 250px;
        }

        .character-fallback {
          width: 200px !important;
          height: 250px !important;
        }

        .glass {
          padding: 1rem;
        }

        .text-3xl {
          font-size: 1.5rem;
        }

        .text-4xl {
          font-size: 2rem;
        }

        .theme-toggle {
          top: 10px;
          right: 10px;
        }

        .achievement-badge {
          width: 70px;
          height: 70px;
        }

        .achievement-icon {
          width: 42px;
          height: 42px;
        }

        .analytics-content, .modal-content {
          padding: 1rem;
          margin: 1rem;
        }

        .footer-content {
          padding: 1rem;
          gap: 1rem;
        }

        .donation-links {
          flex-direction: column;
          align-items: center;
          gap: 0.75rem;
        }

        .donation-btn {
          width: 100%;
          max-width: 280px;
          justify-content: center;
          padding: 0.75rem;
        }

        .footer-brand h3 {
          font-size: 1.1rem;
        }

        .footer-brand p {
          font-size: 0.8rem;
        }

        .donation-title {
          font-size: 1rem;
          flex-wrap: wrap;
        }

        .timer-controls button {
          min-height: 44px;
          padding: 12px 20px;
          font-size: 16px;
        }

        .music-controls button {
          min-width: 44px;
          min-height: 44px;
        }

        .theme-toggle-btn {
          width: 44px;
          height: 44px;
        }

        .main-content {
          padding: 1rem;
          gap: 1.5rem;
          margin-bottom: 1rem;
        }

        .timer-display {
          font-size: 3rem;
        }

        .playlist-container {
          max-height: 200px;
        }

        .character-interaction {
          max-width: 150px;
          font-size: 11px;
        }
      }

      @media (max-width: 480px) {
        .character-container img {
          width: 150px;
          height: 200px;
        }

        .character-fallback {
          width: 150px !important;
          height: 200px !important;
        }

        .timer-controls {
          flex-direction: column;
          gap: 0.5rem;
        }

        .timer-controls button {
          width: 100%;
        }

        .achievement-badge {
          width: 60px;
          height: 60px;
        }

        .achievement-icon {
          width: 36px;
          height: 36px;
        }

        .splash-logo {
          font-size: 2rem;
        }

        .footer-content {
          padding: 0.75rem;
        }

        .donation-btn {
          padding: 0.6rem 1rem;
          font-size: 0.875rem;
          min-width: 120px;
        }

        .footer-bottom {
          font-size: 0.75rem;
          padding-top: 0.75rem;
        }
      }

      @media (min-width: 769px) and (max-width: 1024px) {
        .character-container img {
          width: 250px;
          height: 300px;
        }

        .character-fallback {
          width: 250px !important;
          height: 300px !important;
        }

        .main-content {
          max-width: 95%;
        }

        .donation-btn {
          min-width: 160px;
        }
      }

      @media (min-width: 1025px) {
        .footer-content {
          padding: 2rem;
        }
      }

      @media (prefers-color-scheme: dark) {
        .theme-arona {
          background: linear-gradient(135deg, #0c4a6e 0%, #075985 50%, #0369a1 100%);
          color: #f0f9ff;
        }

        .theme-plana {
          background: linear-gradient(135deg, #4a044e 0%, #6b21a8 50%, #7e22ce 100%);
          color: #faf5ff;
        }
      }
    </style>
  </head>
  <body
    class="theme-arona bg-pattern"
    aria-label="Study Companion with Anime Pomodoro Timer"
  >
    <a href="#main-content" class="sr-only"> Skip to main content </a>

    <div class="background-overlay" aria-hidden="true"></div>

    <div class="theme-toggle page-transition">
      <button
        id="theme-toggle-btn"
        class="theme-toggle-btn"
        aria-label="Switch theme between Arona and Plana"
        aria-live="polite"
      >
        <svg
          id="sun-icon"
          class="w-6 h-6 text-yellow-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          />
        </svg>
        <svg
          id="moon-icon"
          class="w-6 h-6 text-purple-500 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          />
        </svg>
      </button>
    </div>

    <div
      id="notification"
      class="notification info"
      aria-live="polite"
      aria-atomic="true"
      role="alert"
      style="display: none"
    >
      <div class="flex items-center">
        <div class="mr-3" aria-hidden="true">
          <svg
            class="w-6 h-6 text-primary"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </div>
        <div>
          <h4 class="font-semibold text-primary" id="notification-title">
            Timer Complete!
          </h4>
          <p class="text-sm text-gray-600" id="notification-message">
            Time for a short break
          </p>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="share-modal" role="dialog" aria-modal="true" aria-labelledby="share-modal-title">
      <div class="modal-content glass">
        <h3 id="share-modal-title" class="text-lg font-bold text-primary mb-1">üèÜ Achievement Unlocked!</h3>
        <p id="share-modal-desc" class="text-sm text-gray-600 mb-4"></p>
        <button class="share-btn" id="share-native-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
          Share Achievement
        </button>
        <button class="share-btn" id="share-copy-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          Copy to Clipboard
        </button>
        <button class="share-btn share-btn-cancel" id="share-cancel-btn">Close</button>
      </div>
    </div>

    <!-- Mood Modal -->
    <div id="mood-modal" class="mood-modal" role="dialog" aria-modal="true" aria-labelledby="mood-modal-title">
      <div class="modal-content glass">
        <h3 id="mood-modal-title" class="text-lg font-bold text-primary mb-1">How are you feeling today, Sensei?</h3>
        <p class="text-sm text-gray-500 mb-4">Your mood will be tracked with today's sessions</p>
        <div class="flex justify-center gap-3 flex-wrap mb-6">
          <button class="mood-btn" data-mood="energized" data-label="Energized">
            <span class="mood-emoji">‚ö°</span><span>Energized</span>
          </button>
          <button class="mood-btn" data-mood="happy" data-label="Happy">
            <span class="mood-emoji">üòä</span><span>Happy</span>
          </button>
          <button class="mood-btn" data-mood="neutral" data-label="Neutral">
            <span class="mood-emoji">üòê</span><span>Neutral</span>
          </button>
          <button class="mood-btn" data-mood="tired" data-label="Tired">
            <span class="mood-emoji">üò¥</span><span>Tired</span>
          </button>
          <button class="mood-btn" data-mood="stressed" data-label="Stressed">
            <span class="mood-emoji">üò§</span><span>Stressed</span>
          </button>
        </div>
        <div class="flex gap-2 justify-end">
          <button id="mood-skip-btn" class="px-4 py-2 rounded-lg text-sm text-gray-500 hover:bg-gray-100 transition border border-gray-200">Skip</button>
          <button id="mood-confirm-btn" class="px-4 py-2 rounded-lg text-sm bg-primary text-white font-semibold hover:opacity-80 transition" disabled>Confirm</button>
        </div>
      </div>
    </div>

    <!-- Journal Modal -->
    <div id="journal-modal" class="journal-modal" role="dialog" aria-modal="true" aria-labelledby="journal-modal-title">
      <div class="modal-content glass">
        <div class="flex justify-between items-center mb-4">
          <h3 id="journal-modal-title" class="text-lg font-bold text-primary">üìù Session Journal</h3>
          <button id="close-journal" class="text-gray-400 hover:text-primary" aria-label="Close journal">‚úï</button>
        </div>
        <p class="text-sm text-gray-500 mb-3">Great work! What did you learn or accomplish this session?</p>
        <textarea id="journal-input" class="journal-textarea" placeholder="Write your thoughts here... üìñ"></textarea>
        <div class="flex gap-2 justify-end mt-3">
          <button id="journal-skip-btn" class="px-4 py-2 rounded-lg text-sm text-gray-500 hover:bg-gray-100 transition border border-gray-200">Skip</button>
          <button id="journal-save-btn" class="px-4 py-2 rounded-lg text-sm bg-primary text-white font-semibold hover:opacity-80 transition">Save Note</button>
        </div>
        <div id="journal-entries" class="mt-4"></div>
      </div>
    </div>

    <!-- To-Do Modal -->
    <div id="todo-modal" class="todo-modal" role="dialog" aria-modal="true" aria-labelledby="todo-modal-title">
      <div class="modal-content glass">
        <div class="flex justify-between items-center mb-4">
          <h3 id="todo-modal-title" class="text-lg font-bold text-primary">üìã Session Tasks</h3>
          <button id="close-todo" class="text-gray-400 hover:text-primary" aria-label="Close tasks">‚úï</button>
        </div>
        <p class="text-sm text-gray-500 mb-3">What do you want to accomplish this session?</p>
        <div id="todo-list"></div>
        <div class="todo-add-row">
          <input type="text" id="todo-input" class="todo-input" placeholder="Add a task..." maxlength="80" />
          <button id="todo-add-btn" class="todo-add-btn">+ Add</button>
        </div>
        <div class="flex justify-end mt-4">
          <button id="todo-close-btn" class="px-4 py-2 rounded-lg text-sm bg-primary text-white font-semibold hover:opacity-80 transition">Done</button>
        </div>
      </div>
    </div>

    <div
      id="analytics-modal"
      class="analytics-modal"
      role="dialog"
      aria-labelledby="analytics-title"
      aria-modal="true"
    >
      <div class="analytics-content glass">
        <div class="flex justify-between items-center mb-6">
          <h2 id="analytics-title" class="text-2xl font-bold text-primary">
            Study Analytics
          </h2>
          <button
            id="close-analytics"
            class="text-gray-500 hover:text-primary"
            aria-label="Close analytics modal"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="glass rounded-xl p-4">
            <h3 class="text-lg font-semibold text-primary mb-3">
              Weekly Progress
            </h3>
            <div class="space-y-2" id="weekly-stats">
            </div>
          </div>

          <div class="glass rounded-xl p-4">
            <h3 class="text-lg font-semibold text-primary mb-3">
              Productivity Insights
            </h3>
            <div id="productivity-insights">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 mb-6">
          <h3 class="text-lg font-semibold text-primary mb-3">Mood History</h3>
          <div id="mood-history-chart" class="flex gap-2 flex-wrap"></div>
        </div>

        <div class="glass rounded-xl p-4 mb-6">
          <h3 class="text-lg font-semibold text-primary mb-3">Journal Entries</h3>
          <div id="journal-history" class="max-h-48 overflow-y-auto"></div>
        </div>

        <div class="glass rounded-xl p-4">
          <h3 class="text-lg font-semibold text-primary mb-3">
            Achievement Progress
          </h3>
          <div
            class="grid grid-cols-2 md:grid-cols-3 gap-4"
            id="detailed-achievements"
          >
          </div>
        </div>
      </div>
    </div>

    <div
      id="splash-screen"
      class="theme-arona"
      aria-label="Loading application"
      aria-live="polite"
    >
      <div class="splash-logo" id="splash-logo">Arona Blue Archive</div>
      <div class="splash-loader" aria-hidden="true"></div>
      <p class="text-gray-400 mt-4">Loading your study companion...</p>
    </div>

    <main
      id="main-content"
      class="min-h-screen flex flex-col items-center justify-center p-6 theme-transition page-transition"
    >
      <header class="text-center mb-8">
        <h1
          class="text-3xl md:text-4xl font-bold text-primary mb-2 fade-text"
          id="app-title"
        >
          Arona Study Companion
        </h1>
        <p class="text-gray-400 fade-text">
          Your anime study partner for better focus
        </p>
      </header>

      <div
        class="flex flex-col lg:flex-row items-center justify-center gap-8 w-full max-w-6xl main-content"
      >
        <section
          aria-labelledby="character-section-title"
          class="flex flex-col items-center"
        >
          <h2 id="character-section-title" class="sr-only">
            Study Companion Character
          </h2>
          <div class="relative">
            <div class="character-glow" aria-hidden="true"></div>
            <div
              class="relative glass glow-box rounded-3xl p-6 float character-transform"
              id="character-container"
              role="button"
              tabindex="0"
              aria-label="Interact with character. Drag left or right to change outfit."
              aria-live="polite"
            >
              <div
                class="character-interaction"
                id="character-bubble"
                aria-live="polite"
              ></div>
              <img
                src="assets/images/arona.png"
                alt="Arona study companion character"
                class="w-80 h-96 object-contain rounded-2xl"
                id="character-image"
                loading="eager"
              />
            </div>
          </div>

          <div class="w-full max-w-md mt-4">
            <div class="character-progress-container">
              <div
                id="character-progress"
                class="character-progress-fill"
                style="width: 0%"
              ></div>
            </div>
            <div
              id="character-progress-text"
              class="character-progress-text text-center"
            >
              Progress Belajar: 0%
            </div>
          </div>

          <section
            aria-labelledby="timer-title"
            class="glass rounded-2xl p-6 mt-6 glow-box w-full max-w-md"
          >
            <div class="flex justify-between items-center mb-4">
              <h3 id="timer-title" class="text-xl font-bold text-primary">
                Focus Session
              </h3>
              <div class="flex items-center gap-2">
                <span id="streak-display" class="streak-badge" title="Study streak">üî• 0 days</span>
                <span
                  class="session-counter"
                  id="current-cycle"
                  aria-label="Current session 1 of 6"
                >1/6</span
              >
              </div>
            </div>

            <div
              class="flex justify-center gap-2 mb-4"
              id="session-progress"
              aria-label="Session progress"
            >
            </div>

            <div
              class="flex justify-center items-center gap-4 mb-4 timer-controls"
              role="group"
              aria-label="Timer duration options"
            >
              <button
                class="px-4 py-2 bg-primary-opacity rounded-lg hover:bg-opacity-30 transition"
                data-time="25"
                aria-pressed="true"
              >
                25 min
              </button>
              <button
                class="px-4 py-2 bg-primary-opacity rounded-lg hover:bg-opacity-30 transition"
                data-time="45"
                aria-pressed="false"
              >
                45 min
              </button>
              <button
                class="px-4 py-2 bg-primary-opacity rounded-lg hover:bg-opacity-30 transition"
                data-time="60"
                aria-pressed="false"
              >
                60 min
              </button>
            </div>

            <div class="text-center">
              <div
                class="text-4xl font-mono font-bold text-primary mb-2 timer-display"
                id="timer-display"
                aria-live="polite"
                aria-atomic="true"
              >
                25:00
              </div>
              <div
                class="flex justify-center gap-2 timer-controls"
                role="group"
                aria-label="Timer controls"
              >
                <button
                  class="px-4 py-2 bg-primary-opacity rounded-lg hover:bg-opacity-30 transition text-sm"
                  id="todo-btn"
                  aria-label="Open task list"
                >üìã Tasks</button>
                <button
                  class="px-6 py-2 bg-primary rounded-lg hover:bg-opacity-80 transition text-white"
                  id="start-timer"
                  aria-label="Start timer"
                >
                  Start
                </button>
                <button
                  class="px-6 py-2 bg-gray-600 rounded-lg hover:bg-gray-500 transition text-white"
                  id="reset-timer"
                  aria-label="Reset timer"
                >
                  Reset
                </button>
              </div>
            </div>

            <section
              aria-labelledby="progress-title"
              class="glass rounded-xl p-4 mt-4"
            >
              <div class="flex justify-between items-center mb-2">
                <h4 id="progress-title" class="text-primary font-semibold">
                  Today's Progress
                </h4>
                <button
                  id="analytics-btn"
                  class="text-xs text-primary hover:underline"
                  aria-label="View detailed analytics"
                >
                  View Analytics
                </button>
              </div>
              <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span
                  >Completed:
                  <span id="completed-sessions" aria-live="polite">0</span>
                  sessions</span
                >
                <span
                  >Time:
                  <span id="total-study-time" aria-live="polite">0</span>
                  min</span
                >
              </div>
              <div
                class="flex gap-1 justify-center"
                id="daily-progress"
                aria-label="Daily session progress"
              >
              </div>
            </section>

            <section
              aria-labelledby="achievements-title"
              class="glass rounded-xl p-4 mt-4"
            >
              <div class="flex justify-between items-center mb-2">
                <h4 id="achievements-title" class="text-primary font-semibold">
                  Achievements
                </h4>
                <span
                  class="text-xs text-gray-500"
                  id="achievement-progress"
                  aria-live="polite"
                  >0/5</span
                >
              </div>
              <div
                class="flex gap-2 justify-center flex-wrap"
                id="achievements-container"
                role="list"
                aria-label="Achievements list"
              >
              </div>
            </section>

            <section class="glass rounded-xl p-4 mt-4">
              <div class="flex justify-between items-center mb-2">
                <h4 class="text-primary font-semibold">Session Tasks</h4>
                <button id="open-todo-btn" class="text-xs text-primary hover:underline">Manage</button>
              </div>
              <div id="todo-mini" class="text-sm text-gray-500">No tasks yet. Add tasks to stay focused!</div>
            </section>
          </section>
        </section>

        <section
          aria-labelledby="music-player-title"
          class="glass rounded-3xl p-8 glow-box w-full max-w-md"
        >
          <h2 id="music-player-title" class="sr-only">Music Player</h2>

          <div class="text-center mb-8" aria-live="polite">
            <h3 class="text-2xl font-bold text-primary mb-2">Now Playing</h3>
            <p class="text-gray-300" id="current-track-display">Lo-fi Study Beats</p>
            <p class="text-gray-400 text-sm" id="current-artist">
              Chill Anime Mix
            </p>
          </div>

          <div class="mb-6">
            <div
              class="progress-bar"
              role="progressbar"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-label="Music progress"
              tabindex="0"
            >
              <div
                class="progress-fill"
                id="progress-fill"
                style="width: 0%"
              ></div>
            </div>
            <div class="flex justify-between text-xs text-gray-400 mt-2">
              <span id="current-time" aria-live="polite">0:00</span>
              <span id="total-time">0:00</span>
            </div>
          </div>

          <div
            class="flex justify-center items-end h-16 gap-1 mb-8"
            aria-hidden="true"
          >
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0s; height: 40%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.1s; height: 60%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.2s; height: 80%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.3s; height: 100%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.4s; height: 70%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.5s; height: 50%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.6s; height: 30%"
            ></div>
          </div>

          <div
            class="flex justify-center items-center gap-6 mb-6 music-controls"
            role="group"
            aria-label="Music controls"
          >
            <button
              class="p-3 text-gray-400 hover:text-primary transition"
              id="prev-btn"
              aria-label="Previous track"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
            </button>

            <button
              class="p-4 bg-primary rounded-full hover:bg-opacity-80 transition"
              id="play-pause-btn"
              aria-label="Play music"
              aria-pressed="false"
            >
              <svg
                class="w-8 h-8 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                id="play-icon"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <svg
                class="w-8 h-8 text-white hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                id="pause-icon"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </button>

            <button
              class="p-3 text-gray-400 hover:text-primary transition"
              id="next-btn"
              aria-label="Next track"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>
          </div>

          <div class="mb-6">
            <div class="flex items-center gap-3">
              <svg
                class="w-5 h-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m-2.828-9.9a9 9 0 012.728-2.728"
                />
              </svg>
              <input
                type="range"
                min="0"
                max="100"
                value="70"
                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                id="volume-slider"
                aria-label="Volume control"
              />
            </div>
          </div>

          <div class="max-h-48 overflow-y-auto playlist-container">
            <h3 class="text-lg font-semibold text-primary mb-3">
              Study Playlist
            </h3>
            <div class="space-y-2" role="listbox" aria-label="Music playlist">
              <div
                class="flex items-center gap-3 p-2 rounded-lg bg-primary-opacity cursor-pointer"
                data-track="0"
                role="option"
                aria-selected="true"
              >
                <div class="playlist-number playlist-active">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-medium">Lo-fi Study Beats</p>
                  <p class="text-xs text-gray-400">Chill Anime Mix</p>
                </div>
                <span class="text-xs text-gray-400">01:00:29</span>
              </div>

              <div
                class="flex items-center gap-3 p-2 rounded-lg hover:bg-primary-opacity cursor-pointer"
                data-track="1"
                role="option"
                aria-selected="false"
              >
                <div class="playlist-number playlist-inactive">2</div>
                <div class="flex-1">
                  <p class="text-sm font-medium">Rainy Night Coding</p>
                  <p class="text-xs text-gray-400">Jazz Hop</p>
                </div>
                <span class="text-xs text-gray-400">01:02:14</span>
              </div>

              <div
                class="flex items-center gap-3 p-2 rounded-lg hover:bg-primary-opacity cursor-pointer"
                data-track="2"
                role="option"
                aria-selected="false"
              >
                <div class="playlist-number playlist-inactive">3</div>
                <div class="flex-1">
                  <p class="text-sm font-medium">Coffee Shop Vibes</p>
                  <p class="text-xs text-gray-400">Acoustic Lo-fi</p>
                </div>
                <span class="text-xs text-gray-400">00:32:22</span>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="site-footer theme-transition">
      <div class="footer-content">
        <div class="footer-brand">
          <h3>Study Companion</h3>
          <p>Your anime partner for better focus & productivity</p>
        </div>

        <div class="donation-section">
          <div class="donation-title">
            <span class="heart">‚ù§Ô∏è</span>
            <span>Support CryvaStudio</span>
            <span class="heart">‚ù§Ô∏è</span>
          </div>

          <div class="donation-links">
            <a
              href="https://paypal.me/ArvinFarrelP"
              target="_blank"
              rel="noopener noreferrer"
              class="donation-btn"
              aria-label="Support CryvaStudio on PayPal"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M20.067 8.478c.492.88.556 2.014.3 3.327-.74 3.806-3.276 5.12-6.514 5.12h-.5a.805.805 0 0 0-.794.68l-.04.22-.63 3.993-.032.17a.804.804 0 0 1-.794.68h-2.66c-.66 0-1.204-.578-1.12-1.237l1.12-7.16a.98.98 0 0 1 .974-.882h.722c4.306 0 7.128-1.177 8.11-5.049zM8.768 20.06H5.56a.84.84 0 0 1-.833-.945l1.323-8.382a.65.65 0 0 1 .643-.56h3.9c2.82 0 5.03-1.528 5.804-4.858.36-1.552.174-2.625-.468-3.358a1.503 1.503 0 0 0-1.226-.453H6.448a1.15 1.15 0 0 0-1.148 1.053l-2.268 14.363a.9.9 0 0 0 .892 1.038h3.83a.96.96 0 0 0 .95-.827l.025-.14.48-3.043.03-.16a.96.96 0 0 1 .949-.827h.58c3.524 0 5.95-1.842 6.544-5.403.202-1.238.01-2.322-.573-3.153l.932.372c-.456.864-.624 1.934-.386 3.267.744 3.823 3.276 5.12 6.514 5.12h.5a.805.805 0 0 1 .794.68l.04.22.63 3.993.032.17a.804.804 0 0 0 .794.68h2.66c.66 0 1.204-.578 1.12-1.237l-1.12-7.16a.98.98 0 0 0-.974-.882h-.722c-4.306 0-7.128-1.177-8.11-5.049z"
                />
              </svg>
              PayPal
            </a>

            <a
              href="https://saweria.co/CryvaStudio"
              target="_blank"
              rel="noopener noreferrer"
              class="donation-btn"
              aria-label="Support CryvaStudio on Saweria"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"
                />
              </svg>
              Saweria
            </a>
          </div>
        </div>

        <div class="footer-bottom">
          <p>¬© 2025 CryvaStudio. Made with ‚ù§Ô∏è for productive minds.</p>
        </div>
      </div>
    </footer>

    <audio id="audio-player" aria-label="Background music player">
    </audio>

    <script>
    // ============================================================
    // UTILITY: Consistent localStorage wrapper
    // ============================================================
    function safeSave(key, data) {
      try { localStorage.setItem(key, JSON.stringify(data)); return true; }
      catch (e) { console.error("LocalStorage error:", e); showNotification("Storage Error", "Failed to save progress"); return false; }
    }
    function safeLoad(key, fallback = null) {
      try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : fallback; }
      catch (e) { console.error("LocalStorage read error:", e); return fallback; }
    }

    // ============================================================
    // STATE
    // ============================================================
    let currentMode = "arona";
    let progress = {
      completedSessions: 0,
      totalStudyTime: 0,
      lastSession: null,
      dailySessions: Array(8).fill(false),
      studyHistory: [],
      streak: 0,
      lastStudyDate: null
    };
    let hasUnsavedChanges = false;
    const offlineQueue = [];
    const studyMetrics = {
      focusSessions: [],
      breaks: [],
      productivityPatterns: [],
      weeklyReports: [],
      moodLog: [],
      journalEntries: []
    };
    let pendingShareId = null;

    // To-Do state
    let todoItems = [];

    // ============================================================
    // ERROR HANDLING
    // ============================================================
    window.addEventListener("error", (e) => {
      console.error("Global error:", e.error);
      try { safeSave(`${currentMode}Progress`, progress); } catch(x) {}
    });
    window.addEventListener("unhandledrejection", (e) => { console.error("Unhandled rejection:", e.reason); e.preventDefault(); });

    // ============================================================
    // STREAK SYSTEM
    // ============================================================
    function updateStreak() {
      const today = new Date().toDateString();
      const last = progress.lastStudyDate;
      if (!last) { progress.streak = 1; }
      else if (last === today) { /* same day, no change */ }
      else {
        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
        if (last === yesterday.toDateString()) { progress.streak = (progress.streak || 0) + 1; }
        else { progress.streak = 1; }
      }
      progress.lastStudyDate = today;
      updateStreakDisplay();
    }

    function updateStreakDisplay() {
      const el = document.getElementById("streak-display");
      if (!el) return;
      const s = progress.streak || 0;
      el.textContent = `üî• ${s} day${s !== 1 ? "s" : ""}`;
      el.title = s > 0 ? `${s}-day study streak! Keep it up!` : "Start studying to build a streak!";
    }

    // ============================================================
    // MOOD TRACKER
    // ============================================================
    let selectedMood = null;

    function showMoodModal() {
      const modal = document.getElementById("mood-modal");
      selectedMood = null;
      document.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("selected"));
      document.getElementById("mood-confirm-btn").disabled = true;
      modal.classList.add("show");
    }

    function hideMoodModal() { document.getElementById("mood-modal").classList.remove("show"); }

    document.querySelectorAll(".mood-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedMood = btn.dataset.mood;
        document.getElementById("mood-confirm-btn").disabled = false;
      });
    });

    document.getElementById("mood-confirm-btn").addEventListener("click", () => {
      if (!selectedMood) return;
      const entry = { mood: selectedMood, date: new Date().toISOString(), sessions: progress.completedSessions };
      studyMetrics.moodLog.push(entry);
      saveStudyMetrics();
      const labels = { energized: "‚ö° Energized", happy: "üòä Happy", neutral: "üòê Neutral", tired: "üò¥ Tired", stressed: "üò§ Stressed" };
      showNotification("Mood Logged", `Starting focused with: ${labels[selectedMood]}`, "info");
      hideMoodModal();
    });

    document.getElementById("mood-skip-btn").addEventListener("click", hideMoodModal);

    // ============================================================
    // JOURNAL
    // ============================================================
    function showJournalModal() {
      const modal = document.getElementById("journal-modal");
      document.getElementById("journal-input").value = "";
      modal.classList.add("show");
      renderJournalEntries();
    }

    function hideJournalModal() { document.getElementById("journal-modal").classList.remove("show"); }

    function renderJournalEntries() {
      const container = document.getElementById("journal-entries");
      if (!container) return;
      const recent = studyMetrics.journalEntries.slice(-3).reverse();
      if (recent.length === 0) { container.innerHTML = '<p class="text-xs text-gray-400 text-center mt-2">No entries yet.</p>'; return; }
      container.innerHTML = recent.map(e => {
        const d = new Date(e.date);
        const dateStr = d.toLocaleDateString("id-ID", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" });
        return `<div class="journal-entry"><div class="text-xs text-gray-400 mb-1">${dateStr}</div><p class="text-sm">${e.text}</p></div>`;
      }).join("");
    }

    document.getElementById("journal-save-btn").addEventListener("click", () => {
      const text = document.getElementById("journal-input").value.trim();
      if (!text) return;
      studyMetrics.journalEntries.push({ text, date: new Date().toISOString(), sessions: progress.completedSessions });
      saveStudyMetrics();
      showNotification("Journal Saved üìù", "Your note has been saved!", "success");
      hideJournalModal();
    });

    document.getElementById("journal-skip-btn").addEventListener("click", hideJournalModal);
    document.getElementById("close-journal").addEventListener("click", hideJournalModal);
    document.getElementById("journal-modal").addEventListener("click", (e) => { if (e.target.id === "journal-modal") hideJournalModal(); });

    // ============================================================
    // TO-DO LIST
    // ============================================================
    function loadTodos() {
      todoItems = safeLoad("todoItems", []);
    }

    function saveTodos() {
      safeSave("todoItems", todoItems);
      renderTodoMini();
    }

    function renderTodoList() {
      const container = document.getElementById("todo-list");
      if (!container) return;
      if (todoItems.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">No tasks yet. Add one above!</p>';
        return;
      }
      container.innerHTML = todoItems.map((item, i) => `
        <div class="todo-item ${item.done ? "completed" : ""}" data-idx="${i}">
          <button class="todo-checkbox ${item.done ? "checked" : ""}" onclick="toggleTodo(${i})" aria-label="${item.done ? "Uncheck" : "Check"} task">
            ${item.done ? "‚úì" : ""}
          </button>
          <span class="todo-text">${escapeHtml(item.text)}</span>
          <button class="todo-delete" onclick="deleteTodo(${i})" aria-label="Delete task">‚úï</button>
        </div>
      `).join("");
    }

    function renderTodoMini() {
      const mini = document.getElementById("todo-mini");
      if (!mini) return;
      if (todoItems.length === 0) { mini.textContent = "No tasks yet. Add tasks to stay focused!"; return; }
      const done = todoItems.filter(t => t.done).length;
      mini.innerHTML = `<span class="font-semibold text-primary">${done}/${todoItems.length}</span> tasks completed`;
    }

    window.toggleTodo = function(index) {
      todoItems[index].done = !todoItems[index].done;
      saveTodos();
      renderTodoList();
      if (todoItems[index].done) triggerCharacterReaction("session_complete");
    };

    window.deleteTodo = function(index) {
      todoItems.splice(index, 1);
      saveTodos();
      renderTodoList();
    };

    function escapeHtml(text) {
      const d = document.createElement("div");
      d.textContent = text;
      return d.innerHTML;
    }

    function showTodoModal() {
      document.getElementById("todo-modal").classList.add("show");
      renderTodoList();
    }

    function hideTodoModal() {
      document.getElementById("todo-modal").classList.remove("show");
      renderTodoMini();
    }

    document.getElementById("todo-add-btn")?.addEventListener("click", addTodoItem);
    document.getElementById("todo-input")?.addEventListener("keydown", (e) => { if (e.key === "Enter") addTodoItem(); });

    function addTodoItem() {
      const input = document.getElementById("todo-input");
      const text = input.value.trim();
      if (!text) return;
      todoItems.push({ text, done: false, created: new Date().toISOString() });
      saveTodos();
      renderTodoList();
      input.value = "";
      input.focus();
    }

    document.getElementById("todo-close-btn")?.addEventListener("click", hideTodoModal);
    document.getElementById("close-todo")?.addEventListener("click", hideTodoModal);
    document.getElementById("todo-modal")?.addEventListener("click", (e) => { if (e.target.id === "todo-modal") hideTodoModal(); });
    document.getElementById("todo-btn")?.addEventListener("click", showTodoModal);
    document.getElementById("open-todo-btn")?.addEventListener("click", showTodoModal);

    // ============================================================
    // SHARE MODAL
    // ============================================================
    function showShareModal(achievementId) {
      const achievement = achievements[achievementId];
      if (!achievement) return;
      pendingShareId = achievementId;
      document.getElementById("share-modal-desc").textContent = `${achievement.name}: ${achievement.description}`;
      document.getElementById("share-modal").classList.add("show");
    }

    function hideShareModal() {
      document.getElementById("share-modal").classList.remove("show");
      pendingShareId = null;
    }

    document.getElementById("share-native-btn")?.addEventListener("click", () => {
      if (pendingShareId) { doShare(pendingShareId); hideShareModal(); }
    });

    document.getElementById("share-copy-btn")?.addEventListener("click", () => {
      if (pendingShareId) {
        const a = achievements[pendingShareId];
        const text = `I just unlocked "${a.name}" on Study Companion! üéØ ${a.description}`;
        fallbackShare(text);
        hideShareModal();
      }
    });

    document.getElementById("share-cancel-btn")?.addEventListener("click", hideShareModal);
    document.getElementById("share-modal")?.addEventListener("click", (e) => { if (e.target.id === "share-modal") hideShareModal(); });

    function doShare(achievementId) {
      const a = achievements[achievementId];
      const text = `I just unlocked "${a.name}" on Study Companion! üéØ ${a.description}`;
      if (navigator.share) {
        navigator.share({ title: "Study Achievement Unlocked!", text, url: window.location.href }).catch(() => fallbackShare(text));
      } else { fallbackShare(text); }
    }

    function fallbackShare(text) {
      navigator.clipboard.writeText(text).then(() => {
        showNotification("Copied!", "Achievement text copied to clipboard", "success");
      }).catch(() => {
        const ta = document.createElement("textarea");
        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
        showNotification("Copied!", "Achievement text copied to clipboard", "success");
      });
    }

    // ============================================================
    // ANALYTICS
    // ============================================================
    function showAnalytics() {
      document.getElementById("analytics-modal").classList.add("show");
      updateWeeklyStats();
      updateProductivityInsights();
      updateDetailedAchievements();
      renderMoodHistory();
      renderJournalHistory();
    }

    function renderMoodHistory() {
      const container = document.getElementById("mood-history-chart");
      if (!container) return;
      if (studyMetrics.moodLog.length === 0) { container.innerHTML = '<p class="text-sm text-gray-400">No mood data yet. Start a session to track your mood!</p>'; return; }
      const moodEmoji = { energized: "‚ö°", happy: "üòä", neutral: "üòê", tired: "üò¥", stressed: "üò§" };
      const recent = studyMetrics.moodLog.slice(-14);
      container.innerHTML = recent.map(e => {
        const d = new Date(e.date);
        return `<div class="text-center" title="${e.mood} - ${d.toLocaleDateString()}">
          <div style="font-size:1.5rem">${moodEmoji[e.mood] || "üòê"}</div>
          <div style="font-size:0.6rem;opacity:0.6">${d.getDate()}/${d.getMonth()+1}</div>
        </div>`;
      }).join("");
    }

    function renderJournalHistory() {
      const container = document.getElementById("journal-history");
      if (!container) return;
      if (studyMetrics.journalEntries.length === 0) { container.innerHTML = '<p class="text-sm text-gray-400">No journal entries yet.</p>'; return; }
      container.innerHTML = studyMetrics.journalEntries.slice(-5).reverse().map(e => {
        const d = new Date(e.date);
        const ds = d.toLocaleDateString("id-ID", { day: "numeric", month: "short", year: "numeric" });
        return `<div class="journal-entry"><div class="text-xs text-gray-400 mb-1">${ds}</div><p class="text-sm">${e.text}</p></div>`;
      }).join("");
    }

    function updateWeeklyStats() {
      const el = document.getElementById("weekly-stats");
      if (!el) return;
      const d = getWeeklyData();
      el.innerHTML = `
        <div class="flex justify-between"><span>Sessions Completed:</span><span class="font-semibold">${d.sessions}</span></div>
        <div class="flex justify-between"><span>Total Study Time:</span><span class="font-semibold">${Math.floor(d.totalTime/60)}h ${d.totalTime%60}m</span></div>
        <div class="flex justify-between"><span>Average Session:</span><span class="font-semibold">${d.sessions>0?Math.floor(d.totalTime/d.sessions):0}m</span></div>
        <div class="flex justify-between"><span>Productivity Score:</span><span class="font-semibold">${calculateProductivityScore()}%</span></div>
        <div class="flex justify-between"><span>Current Streak:</span><span class="font-semibold">üî• ${progress.streak||0} days</span></div>
      `;
    }

    function updateProductivityInsights() {
      const el = document.getElementById("productivity-insights");
      if (!el) return;
      const d = getWeeklyData();
      let text = "";
      if (d.sessions === 0) text = "Start your first session to unlock insights!";
      else if (d.sessions < 3) text = "Try to maintain consistency ‚Äî aim for 3+ sessions per week!";
      else if (d.totalTime < 180) text = "Great consistency! Consider longer sessions for deeper focus.";
      else text = "Excellent productivity! You're building strong study habits!";
      el.innerHTML = `
        <p class="text-sm text-gray-600 mb-3">${text}</p>
        <div class="bg-primary-opacity rounded-lg p-3">
          <div class="flex justify-between text-sm mb-1"><span>Weekly Goal Progress</span><span>${Math.min(100,Math.floor((d.sessions/7)*100))}%</span></div>
          <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100,Math.floor((d.sessions/7)*100))}%"></div></div>
        </div>
      `;
    }

    function updateDetailedAchievements() {
      const container = document.getElementById("detailed-achievements");
      if (!container) return;
      container.innerHTML = "";
      Object.values(achievements).forEach(a => {
        const el = document.createElement("div");
        el.className = "glass rounded-lg p-3 text-center";
        let progressHtml = "";
        if (a.requirement && !a.unlocked) {
          let pv = 0;
          if (a.id === "focus_master") pv = Math.min(progress.completedSessions, a.requirement);
          else if (a.id === "marathon_runner") pv = Math.min(Math.floor(progress.totalStudyTime/60), a.requirement);
          else if (a.id === "consistency_king") pv = Math.min(progress.dailySessions.filter(s=>s).length, a.requirement);
          else if (a.id === "streak_3" || a.id === "streak_7") pv = Math.min(progress.streak||0, a.requirement);
          const pct = (pv / a.requirement) * 100;
          progressHtml = `<div class="progress-ring mt-2 mx-auto" style="--progress:${pct}%"><span>${pv}/${a.requirement}</span></div>`;
        }
        el.innerHTML = `
          <div class="text-2xl mb-2"><img src="${a.icon}" alt="${a.name}" class="w-12 h-12 mx-auto object-contain"></div>
          <h4 class="font-semibold text-sm mb-1">${a.name}</h4>
          <p class="text-xs text-gray-600 mb-2">${a.description}</p>
          ${a.unlocked ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Unlocked</span>' : progressHtml}
        `;
        container.appendChild(el);
      });
    }

    function getWeeklyData() {
      return { sessions: progress.completedSessions, totalTime: progress.totalStudyTime, averageSession: progress.completedSessions > 0 ? Math.floor(progress.totalStudyTime/progress.completedSessions) : 0 };
    }

    function calculateProductivityScore() {
      const d = getWeeklyData();
      return Math.floor((Math.min(100,(d.sessions/7)*100) + Math.min(100,(d.totalTime/420)*100)) / 2);
    }

    // ============================================================
    // ACHIEVEMENTS
    // ============================================================
    const achievements = {
      first_session: { id:"first_session", name:"First Steps", description:"Complete your first focus session", icon:"assets/images/achievements/first_steps1.png", unlocked:false, rarity:"common" },
      focus_master: { id:"focus_master", name:"Focus Master", description:"Complete 10 focus sessions", icon:"assets/images/achievements/focus_master.png", unlocked:false, requirement:10, rarity:"rare" },
      marathon_runner: { id:"marathon_runner", name:"Marathon Runner", description:"Study for 60+ minutes total", icon:"assets/images/achievements/marathon_runner.png", unlocked:false, requirement:60, rarity:"common" },
      consistency_king: { id:"consistency_king", name:"Consistency King", description:"Complete 5 sessions in one day", icon:"assets/images/achievements/consistency_king.png", unlocked:false, requirement:5, rarity:"rare" },
      early_bird: { id:"early_bird", name:"Early Bird", description:"Start your first session before 8 AM", icon:"assets/images/achievements/early_bird.png", unlocked:false, rarity:"common" },
      streak_3: { id:"streak_3", name:"Hat-Trick", description:"Study 3 days in a row", icon:"assets/images/achievements/first_steps1.png", unlocked:false, requirement:3, rarity:"common" },
      streak_7: { id:"streak_7", name:"Week Warrior", description:"Study 7 days in a row", icon:"assets/images/achievements/focus_master.png", unlocked:false, requirement:7, rarity:"rare" },
    };

    function checkAchievements() {
      const checks = {
        first_session: () => progress.completedSessions >= 1,
        focus_master: () => progress.completedSessions >= achievements.focus_master.requirement,
        marathon_runner: () => progress.totalStudyTime >= achievements.marathon_runner.requirement * 60,
        consistency_king: () => progress.dailySessions.filter(s=>s).length >= achievements.consistency_king.requirement,
        early_bird: () => { const now = new Date(); const today = progress.lastSession && new Date(progress.lastSession).toDateString() === now.toDateString(); return today && now.getHours() < 8; },
        streak_3: () => (progress.streak || 0) >= 3,
        streak_7: () => (progress.streak || 0) >= 7,
      };
      Object.keys(checks).forEach(id => {
        if (!achievements[id].unlocked && checks[id]()) unlockAchievement(id);
      });
    }

    function unlockAchievement(id) {
      if (!achievements[id] || achievements[id].unlocked) return;
      achievements[id].unlocked = true;
      const a = achievements[id];
      showNotification(a.rarity === "rare" ? "Rare Achievement! üíé" : "Achievement Unlocked! üèÜ", `${a.name}: ${a.description}`, "success");
      if (a.rarity === "rare") {
        createConfettiEffect();
        setTimeout(() => showShareModal(id), 500);
      }
      triggerCharacterReaction("achievement");
      saveAchievements();
      updateAchievementsUI();
      hasUnsavedChanges = true;
    }

    function updateAchievementsUI() {
      const container = document.getElementById("achievements-container");
      const progressEl = document.getElementById("achievement-progress");
      if (!container || !progressEl) return;
      container.innerHTML = "";
      const unlocked = Object.values(achievements).filter(a => a.unlocked).length;
      progressEl.textContent = `${unlocked}/${Object.keys(achievements).length}`;
      Object.values(achievements).forEach(a => {
        const badge = document.createElement("div");
        badge.className = `achievement-badge ${a.unlocked?"achievement-unlocked":"achievement-locked"} ${a.rarity==="rare"?"achievement-rare":"achievement-common"} ${a.unlocked?"achievement unlocked":"achievement locked"}`;
        if (a.unlocked) {
          badge.style.setProperty("--primary-color", currentMode==="arona"?"#38bdf8":"#c084fc");
          badge.style.setProperty("--secondary-color", currentMode==="arona"?"#0ea5e9":"#a855f7");
          badge.addEventListener("click", () => showShareModal(a.id));
        } else {
          badge.addEventListener("click", () => showNotification(a.name, `${a.description} ‚Äî keep going!`, "info"));
        }
        const icon = document.createElement("img");
        icon.className = "achievement-icon"; icon.src = a.icon; icon.alt = a.name; icon.loading = "lazy";
        icon.addEventListener("error", function() {
          const emojis = { first_session:"üéØ", focus_master:"‚ö°", marathon_runner:"üèÉ‚Äç‚ôÇÔ∏è", consistency_king:"üëë", early_bird:"üåÖ", streak_3:"üî•", streak_7:"üåü" };
          this.replaceWith(document.createTextNode(emojis[a.id]||"üèÜ"));
        });
        const tooltip = document.createElement("div");
        tooltip.className = "achievement-tooltip";
        tooltip.innerHTML = `<strong>${a.name}</strong><br>${a.description}${a.rarity==="rare"?"<br>‚≠ê Rare":""}${a.unlocked?"<br><small>Click to share</small>":""}`;
        badge.appendChild(icon); badge.appendChild(tooltip);
        if (a.requirement && !a.unlocked) {
          let pv = 0;
          if (a.id==="focus_master") pv = Math.min(progress.completedSessions, a.requirement);
          else if (a.id==="marathon_runner") pv = Math.min(Math.floor(progress.totalStudyTime/60), a.requirement);
          else if (a.id==="consistency_king") pv = Math.min(progress.dailySessions.filter(s=>s).length, a.requirement);
          else if (a.id==="streak_3"||a.id==="streak_7") pv = Math.min(progress.streak||0, a.requirement);
          const pt = document.createElement("div");
          pt.className = "achievement-progress"; pt.textContent = `${pv}/${a.requirement}`;
          badge.appendChild(pt);
        }
        container.appendChild(badge);
      });
    }

    // ============================================================
    // CHARACTER INTERACTIONS
    // ============================================================
    const characterInteractions = {
      arona: {
        greeting: ["Sensei! Arona has been waiting! Let's study together! üåü","Welcome back, Sensei! Arona is ready to help you have a productive day! üí´","Ara~ Sensei is here! Are you ready to focus today? üìö","Pla-... eh, hello Sensei! Ready to focus? ‚ú®"],
        outfit_change: ["Ehehe~ Outfit baru! Arona suka! üëó","Kamu suka outfit Arona yang ini, Sensei? üòä","Arona jadi lebih semangat belajar dengan outfit baru! ‚ú®","Cute? Arona selalu cute! Tapi makasih Sensei! üíï"],
        session_start: ["Focus time! Let's do our best, Sensei! üí™","Arona will support you, Sensei! Don't give up! üå∏","Time to focus! Arona believes in you, Sensei! üöÄ","Pomodoro session start! Ganbatte, Sensei! ‚ú®"],
        session_complete: ["Yatta! Great work, Sensei! Arona is proud! üéâ","Session complete! You did amazing, Sensei! üí´","Arona will give you virtual pyroxenes for your hard work! üíé","Mission complete! Amazing work, Sensei! üåü"],
        achievement: ["Wow! Achievement unlocked! You're amazing, Sensei! üèÜ","Arona is happy to see you growing, Sensei! üíù","Incredible! This is definitely because of your hard work, Sensei! ‚ú®","Congratulations, Sensei! You deserve this! üéä"],
        break_time: ["Break time! Don't forget to drink water, Sensei! üíß","Short break~ Arona will wait here for you! ‚òï","Time to recharge your energy! Don't push yourself too hard! üå∏","Tea break! Arona will guard your progress! üçµ"],
      },
      plana: {
        greeting: ["Welcome, Sensei... Let's find peace in studying together üåô","Hello Sensei... Is today filled with hope? üí≠","Nice to meet you again, Sensei... üìñ","The library is quiet today... perfect for focus... üìö"],
        outfit_change: ["Plana... in... ini... outfit spesial! üå∏‚ú®","Hanya outfit ini yang Plana punya... apakah Sensei suka? üôà","Plana pakai ini... khusus untuk Sensei... üíï","Bunnygirl Plana... satu-satunya outfit spesial! üê∞"],
        session_start: ["Every moment of focus is a step toward the future... ‚ú®","Let's begin this small journey together... üå∏","Your concentration is a beautiful light, Sensei... üí´","Let's begin our journey of knowledge... üåô"],
        session_complete: ["Small consistent steps lead to great achievements... üåü","Sensei... your dedication is truly inspiring... üíù","Today's achievement is a seed for the future... üå±","Another step forward in your journey... well done... ‚ú®"],
        achievement: ["This achievement proves your growth, Sensei... ‚ú®","Every accomplishment is a beautiful story in our journey... üìö","Sensei... continue walking with confidence... üåô","Your efforts bear fruit... beautiful, isn't it? üí´"],
        break_time: ["Time to rest... the world can wait for a moment... ‚òÅÔ∏è","Rest is part of a wise journey... üçµ","Take a deep breath... let your mind rest for a while... üíÆ","Time to rest... even stars need to recharge... üåô"],
      },
    };

    function triggerCharacterReaction(type) {
      const bubble = document.getElementById("character-bubble");
      if (!bubble) return;
      const quotes = characterInteractions[currentMode];
      if (!quotes) return;
      const messages = quotes[type] || quotes.greeting;
      bubble.textContent = messages[Math.floor(Math.random() * messages.length)];
      bubble.classList.add("show");
      setTimeout(() => bubble.classList.remove("show"), 5000);
    }

    // ============================================================
    // NOTIFICATION
    // ============================================================
    function showNotification(title, message, type = "info") {
      const n = document.getElementById("notification");
      const nt = document.getElementById("notification-title");
      const nm = document.getElementById("notification-message");
      if (!n || !nt || !nm) return;
      nt.textContent = title; nm.textContent = message;
      n.className = `notification ${type}`;
      n.style.display = "block";
      n.classList.add("show");
      clearTimeout(n._timeout);
      n._timeout = setTimeout(() => { n.classList.remove("show"); setTimeout(() => n.style.display="none", 500); }, 5000);
      if (type === "success") playCompletionSound();
    }

    function playCompletionSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.value = 800; osc.type = "sine";
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 1);
      } catch(e) {}
    }

    function createConfettiEffect() {
      const colors = currentMode==="arona" ? ["#38bdf8","#0ea5e9","#7dd3fc","#bae6fd"] : ["#c084fc","#a855f7","#d8b4fe","#f3e8ff"];
      for (let i = 0; i < 50; i++) {
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.setProperty("--confetti-color", colors[Math.floor(Math.random()*colors.length)]);
        c.style.left = Math.random()*100 + "vw"; c.style.top = "-10px";
        c.style.transform = `rotate(${Math.random()*360}deg)`;
        document.body.appendChild(c);
        c.animate([{transform:"translateY(0) rotate(0deg)",opacity:1},{transform:`translateY(${window.innerHeight}px) rotate(${Math.random()*360}deg)`,opacity:0}],{duration:2000+Math.random()*1000,easing:"cubic-bezier(0.1,0.8,0.3,1)"});
        setTimeout(() => { if (c.parentNode) c.remove(); }, 3000);
      }
    }

    // ============================================================
    // PROGRESS SAVE / LOAD
    // ============================================================
    function backupProgress(p) { safeSave("progress_backup", { data:p, timestamp:Date.now(), version:"1.1.0" }); }
    function restoreBackup() { const b = safeLoad("progress_backup"); return b?.data || null; }
    function saveStudyMetrics() { safeSave("studyMetrics", studyMetrics); }
    function loadStudyMetrics() { const m = safeLoad("studyMetrics"); if (m) Object.assign(studyMetrics, m); }

    function loadProgress() {
      let saved = safeLoad(`${currentMode}Progress`) || restoreBackup();
      if (saved) {
        progress = saved;
        if (!Array.isArray(progress.dailySessions)) progress.dailySessions = Array(8).fill(false);
        const today = new Date().toDateString();
        if (progress.lastSession && new Date(progress.lastSession).toDateString() !== today) {
          progress.dailySessions = Array(8).fill(false);
        }
        if (typeof progress.streak === "undefined") progress.streak = 0;
      }
      document.getElementById("completed-sessions").textContent = progress.completedSessions;
      document.getElementById("total-study-time").textContent = Math.floor(progress.totalStudyTime / 60);
      updateDailyProgress(progress.dailySessions);
      updateStreakDisplay();
      return progress;
    }

    function saveProgress(p) {
      backupProgress(p);
      safeSave(`${currentMode}Progress`, p);
      document.getElementById("completed-sessions").textContent = p.completedSessions;
      document.getElementById("total-study-time").textContent = Math.floor(p.totalStudyTime / 60);
      updateDailyProgress(p.dailySessions);
      hasUnsavedChanges = true;
    }

    function updateDailyProgress(sessions) {
      const el = document.getElementById("daily-progress");
      if (!el) return;
      el.innerHTML = "";
      sessions.forEach((done, i) => {
        const c = document.createElement("div");
        c.className = `session-circle ${done?"session-completed":"session-pending"}`;
        c.title = `Session ${i+1}: ${done?"Completed":"Pending"}`;
        el.appendChild(c);
      });
    }

    function saveAchievements() { safeSave(`${currentMode}Achievements`, achievements); }
    function loadAchievements() {
      const saved = safeLoad(`${currentMode}Achievements`);
      if (saved) Object.keys(saved).forEach(k => { if (achievements[k]) achievements[k].unlocked = saved[k].unlocked; });
      updateAchievementsUI();
    }

    // ============================================================
    // AUDIO
    // ============================================================
    const audioPlayer = document.getElementById("audio-player");
    const playPauseBtn = document.getElementById("play-pause-btn");
    const playIcon = document.getElementById("play-icon");
    const pauseIcon = document.getElementById("pause-icon");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const volumeSlider = document.getElementById("volume-slider");
    const progressFill = document.getElementById("progress-fill");
    const currentTimeEl = document.getElementById("current-time");
    const totalTimeEl = document.getElementById("total-time");
    const currentTrackDisplay = document.getElementById("current-track-display");
    const currentArtistEl = document.getElementById("current-artist");

    const playlist = [
      { title:"Lo-fi Study Beats", artist:"Chill Anime Mix", src:"./assets/music/lofi-study.mp3", duration:"01:00:29" },
      { title:"Rainy Night Coding", artist:"Jazz Hop", src:"./assets/music/rainy-coding.mp3", duration:"01:02:14" },
      { title:"Coffee Shop Vibes", artist:"Acoustic Lo-fi", src:"./assets/music/coffee-vibes.mp3", duration:"00:32:22" },
    ];

    const audioFallbacks = {
      "lofi-study.mp3": ["https://cdn.pixabay.com/download/audio/2022/03/15/audio_d17187f128.mp3","https://assets.mixkit.co/music/preview/mixkit-chill-abstract-loop-229.mp3"],
      "rainy-coding.mp3": ["https://cdn.pixabay.com/download/audio/2022/11/16/audio_8c97a94dbf.mp3","https://assets.mixkit.co/music/preview/mixkit-rainy-jazz-229.mp3"],
      "coffee-vibes.mp3": ["https://cdn.pixabay.com/download/audio/2022/10/25/audio_1e779eb41f.mp3","https://assets.mixkit.co/music/preview/mixkit-coffee-shop-ambience-230.mp3"],
    };

    let currentTrackIndex = 0;
    let isMusicPlaying = false;
    let currentFallbackIndex = 0;

    const savedVolume = safeLoad("musicVolume");
    audioPlayer.volume = savedVolume !== null ? parseFloat(savedVolume) : 0.7;
    volumeSlider.value = audioPlayer.volume * 100;

    audioPlayer.addEventListener("error", function handleAudioError(e) {
      const track = playlist[currentTrackIndex];
      const filename = track.src.split("/").pop();
      const fallbacks = audioFallbacks[filename] || [];
      if (currentFallbackIndex < fallbacks.length) {
        this.src = fallbacks[currentFallbackIndex++];
        if (isMusicPlaying) this.play().catch(()=>{});
      } else {
        currentFallbackIndex = 0;
        setTimeout(() => playTrack((currentTrackIndex+1) % playlist.length), 2000);
      }
    });

    function updatePlaylistNumbers() {
      document.querySelectorAll("[data-track]").forEach(item => {
        const idx = parseInt(item.getAttribute("data-track"));
        const num = item.querySelector(".playlist-number");
        if (idx === currentTrackIndex) {
          num.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>';
          num.className = "playlist-number playlist-active";
          item.setAttribute("aria-selected","true");
        } else {
          num.textContent = idx+1; num.className = "playlist-number playlist-inactive";
          item.setAttribute("aria-selected","false");
        }
      });
    }

    playPauseBtn.addEventListener("click", () => {
      if (isMusicPlaying) {
        audioPlayer.pause(); isMusicPlaying = false;
        playIcon.classList.remove("hidden"); pauseIcon.classList.add("hidden");
        playPauseBtn.setAttribute("aria-label","Play music"); playPauseBtn.setAttribute("aria-pressed","false");
      } else {
        if (!audioPlayer.src) playTrack(currentTrackIndex);
        audioPlayer.play().then(() => {
          isMusicPlaying = true;
          playIcon.classList.add("hidden"); pauseIcon.classList.remove("hidden");
          playPauseBtn.setAttribute("aria-label","Pause music"); playPauseBtn.setAttribute("aria-pressed","true");
        }).catch(e => { showNotification("Music Error", "Cannot play audio. Please check your music files."); });
      }
    });

    volumeSlider.addEventListener("input", () => {
      audioPlayer.volume = volumeSlider.value / 100;
      safeSave("musicVolume", audioPlayer.volume);
    });

    audioPlayer.addEventListener("timeupdate", () => {
      if (audioPlayer.duration) {
        const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressFill.style.width = `${pct}%`;
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        totalTimeEl.textContent = formatTime(audioPlayer.duration);
      }
    });

    progressFill.parentElement.addEventListener("click", (e) => {
      if (audioPlayer.duration) {
        const r = e.target.getBoundingClientRect();
        audioPlayer.currentTime = ((e.clientX - r.left) / r.width) * audioPlayer.duration;
      }
    });

    document.querySelectorAll("[data-track]").forEach(item => {
      item.addEventListener("click", () => playTrack(parseInt(item.getAttribute("data-track"))));
    });

    prevBtn.addEventListener("click", () => playTrack((currentTrackIndex-1+playlist.length) % playlist.length));
    nextBtn.addEventListener("click", () => playTrack((currentTrackIndex+1) % playlist.length));
    audioPlayer.addEventListener("ended", () => playTrack((currentTrackIndex+1) % playlist.length));

    function playTrack(index) {
      currentTrackIndex = index;
      const track = playlist[index];
      if (currentTrackDisplay) currentTrackDisplay.textContent = track.title;
      if (currentArtistEl) currentArtistEl.textContent = track.artist;
      if (totalTimeEl) totalTimeEl.textContent = track.duration;
      currentFallbackIndex = 0;
      audioPlayer.src = track.src;
      updatePlaylistNumbers();
      document.querySelectorAll("[data-track]").forEach(item => {
        const isActive = parseInt(item.getAttribute("data-track")) === index;
        item.classList.toggle("bg-primary-opacity", isActive);
      });
      if (isMusicPlaying) audioPlayer.play().catch(() => { isMusicPlaying = false; });
    }

    function formatTime(s) {
      if (isNaN(s)) return "0:00";
      return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,"0")}`;
    }

    // ============================================================
    // TIMER
    // ============================================================
    const timerDisplay = document.getElementById("timer-display");
    const startTimerBtn = document.getElementById("start-timer");
    const resetTimerBtn = document.getElementById("reset-timer");
    const timerButtons = document.querySelectorAll("[data-time]");
    const timerTitle = document.getElementById("timer-title");
    const currentCycleEl = document.getElementById("current-cycle");
    const sessionProgressEl = document.getElementById("session-progress");

    const pomodoroCycles = [
      { type:"focus", duration:25*60, title:"Focus Session" },
      { type:"short-break", duration:5*60, title:"Short Break" },
      { type:"focus", duration:25*60, title:"Focus Session" },
      { type:"short-break", duration:5*60, title:"Short Break" },
      { type:"focus", duration:25*60, title:"Focus Session" },
      { type:"long-break", duration:15*60, title:"Long Break" },
    ];

    let timerInterval;
    let timeLeft = pomodoroCycles[0].duration;
    let isRunning = false;
    let currentCycleIndex = 0;
    let hasStarted = false;

    const liveRegion = document.createElement("div");
    liveRegion.setAttribute("aria-live","polite"); liveRegion.setAttribute("aria-atomic","true");
    liveRegion.className = "sr-only"; document.body.appendChild(liveRegion);
    function announceTimerChange(msg) { liveRegion.textContent = msg; setTimeout(() => liveRegion.textContent = "", 1000); }

    function initializeSessionProgress() {
      if (!sessionProgressEl) return;
      sessionProgressEl.innerHTML = "";
      pomodoroCycles.forEach((cycle, i) => {
        const c = document.createElement("div");
        c.className = `session-circle ${i===currentCycleIndex?"session-current":"session-pending"}`;
        c.title = `${cycle.title} (${Math.floor(cycle.duration/60)} min)`;
        sessionProgressEl.appendChild(c);
      });
    }
    initializeSessionProgress();

    function updateStartButtonText() {
      if (!startTimerBtn) return;
      if (!hasStarted && !isRunning) { startTimerBtn.textContent = "Start"; startTimerBtn.setAttribute("aria-label","Start timer"); }
      else if (isRunning) { startTimerBtn.textContent = "Pause"; startTimerBtn.setAttribute("aria-label","Pause timer"); }
      else { startTimerBtn.textContent = "Continue"; startTimerBtn.setAttribute("aria-label","Continue timer"); }
    }

    timerButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        clearInterval(timerInterval); isRunning = false; hasStarted = false;
        timeLeft = parseInt(btn.getAttribute("data-time")) * 60;
        updateTimerDisplay(); updateStartButtonText();
        timerButtons.forEach(b => { b.classList.remove("bg-primary","text-white"); b.classList.add("bg-primary-opacity"); b.setAttribute("aria-pressed","false"); });
        btn.classList.add("bg-primary","text-white"); btn.classList.remove("bg-primary-opacity"); btn.setAttribute("aria-pressed","true");
      });
    });

    function updateCharacterProgress() {
      const pb = document.getElementById("character-progress");
      const pt = document.getElementById("character-progress-text");
      const cb = document.getElementById("character-bubble");
      if (!pb || !pt) return;
      const total = pomodoroCycles[currentCycleIndex]?.duration || 25*60;
      const pct = Math.min(100, Math.max(0, ((total - timeLeft) / total) * 100));
      pb.style.width = `${pct}%`;
      pt.textContent = `Progress Belajar: ${Math.round(pct)}%`;
      if (pct >= 95 && pct < 100) { triggerCharacterReaction("session_complete"); }
      else if ((pct >= 66 || pct >= 33) && cb && !cb.classList.contains("show")) {
        const q = pct >= 66
          ? (currentMode==="arona" ? ["Hampir selesai, Sensei! Semangat! üí™","Sedikit lagi! Kamu pasti bisa! ‚ú®"] : ["Hampir selesai... tetaplah fokus... üåô","Perjalananmu hampir berakhir... indah sekali... üí´"])
          : (currentMode==="arona" ? ["Teruskan, Sensei! Kamu hebat! üåü","Fokus! Jangan menyerah! üí´"] : ["Kamu sudah sejauh ini... luar biasa... ‚ú®","Teruslah melangkah... üå∏"]);
        cb.textContent = q[Math.floor(Math.random()*q.length)];
        cb.classList.add("show"); setTimeout(() => cb.classList.remove("show"), 3000);
      }
    }

    startTimerBtn.addEventListener("click", () => {
      if (!isRunning) {
        const today = new Date().toDateString();
        const lastMood = studyMetrics.moodLog.length > 0 ? new Date(studyMetrics.moodLog[studyMetrics.moodLog.length-1].date).toDateString() : null;
        const shouldAskMood = lastMood !== today && pomodoroCycles[currentCycleIndex].type === "focus";

        if (shouldAskMood) {
          showMoodModal();
          const origHide = hideMoodModal;
          hideMoodModal = () => { origHide(); actuallyStartTimer(); hideMoodModal = origHide; };
          document.getElementById("mood-confirm-btn").onclick = () => {
            if (!selectedMood) return;
            const entry = { mood: selectedMood, date: new Date().toISOString(), sessions: progress.completedSessions };
            studyMetrics.moodLog.push(entry); saveStudyMetrics();
            const labels = { energized:"‚ö° Energized", happy:"üòä Happy", neutral:"üòê Neutral", tired:"üò¥ Tired", stressed:"üò§ Stressed" };
            showNotification("Mood Logged", `Starting focused with: ${labels[selectedMood]}`, "info");
            hideMoodModal();
          };
          document.getElementById("mood-skip-btn").onclick = hideMoodModal;
          return;
        }
        actuallyStartTimer();
      } else {
        isRunning = false; updateStartButtonText(); clearInterval(timerInterval);
        announceTimerChange("Timer paused.");
      }
    });

    function actuallyStartTimer() {
      isRunning = true; hasStarted = true; updateStartButtonText();
      const isFocus = pomodoroCycles[currentCycleIndex].type === "focus";
      if (isFocus) {
        triggerCharacterReaction("session_start");
        studyMetrics.focusSessions.push({ startTime: new Date().toISOString(), duration: pomodoroCycles[currentCycleIndex].duration/60 });
        saveStudyMetrics();
      } else {
        triggerCharacterReaction("break_time");
        studyMetrics.breaks.push({ startTime: new Date().toISOString(), duration: pomodoroCycles[currentCycleIndex].duration/60 });
        saveStudyMetrics();
      }
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        updateCharacterProgress();
        if (timeLeft <= 0) {
          clearInterval(timerInterval); isRunning = false; hasStarted = false; updateStartButtonText();
          if (pomodoroCycles[currentCycleIndex].type === "focus") {
            progress.completedSessions++;
            progress.totalStudyTime += pomodoroCycles[currentCycleIndex].duration;
            progress.lastSession = new Date().toISOString();
            const si = progress.completedSessions % 8;
            if (si < progress.dailySessions.length) progress.dailySessions[si] = true;
            if (studyMetrics.focusSessions.length > 0) studyMetrics.focusSessions[studyMetrics.focusSessions.length-1].endTime = new Date().toISOString();
            studyMetrics.productivityPatterns.push({ date: new Date().toISOString().split("T")[0], productivity: calculateProductivityScore(), sessions: progress.completedSessions });
            saveStudyMetrics();
            updateStreak();
            saveProgress(progress);
            checkAchievements();
            triggerCharacterReaction("session_complete");
            announceTimerChange("Focus session complete! Time for a break.");
            setTimeout(showJournalModal, 800);
          } else {
            triggerCharacterReaction("break_time");
            announceTimerChange("Break time over! Ready for next focus session.");
          }
          currentCycleIndex = (currentCycleIndex+1) % pomodoroCycles.length;
          timeLeft = pomodoroCycles[currentCycleIndex].duration;
          if (timerTitle) timerTitle.textContent = pomodoroCycles[currentCycleIndex].title;
          if (currentCycleEl) { currentCycleEl.textContent = `${currentCycleIndex+1}/${pomodoroCycles.length}`; currentCycleEl.setAttribute("aria-label",`Current session ${currentCycleIndex+1} of ${pomodoroCycles.length}`); }
          initializeSessionProgress(); updateTimerDisplay(); updateCharacterProgress();
        }
      }, 1000);
    }

    resetTimerBtn.addEventListener("click", () => {
      clearInterval(timerInterval); isRunning = false; hasStarted = false; updateStartButtonText();
      currentCycleIndex = 0; timeLeft = pomodoroCycles[0].duration;
      if (timerTitle) timerTitle.textContent = pomodoroCycles[0].title;
      if (currentCycleEl) { currentCycleEl.textContent = `1/${pomodoroCycles.length}`; currentCycleEl.setAttribute("aria-label","Current session 1 of "+pomodoroCycles.length); }
      initializeSessionProgress(); updateTimerDisplay(); updateCharacterProgress();
      announceTimerChange("Timer reset to beginning.");
      timerButtons.forEach(b => { b.classList.remove("bg-primary","text-white"); b.classList.add("bg-primary-opacity"); b.setAttribute("aria-pressed","false"); });
      timerButtons[0].classList.add("bg-primary","text-white"); timerButtons[0].classList.remove("bg-primary-opacity"); timerButtons[0].setAttribute("aria-pressed","true");
    });

    function updateTimerDisplay() {
      if (!timerDisplay) return;
      const m = Math.floor(timeLeft/60), s = timeLeft%60;
      timerDisplay.textContent = `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
      document.title = `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")} - ${timerTitle?timerTitle.textContent:"Focus Session"} | ${currentMode==="arona"?"Arona":"Plana"}`;
    }

    // ============================================================
    // KEYBOARD SHORTCUTS
    // ============================================================
    document.addEventListener("keydown", (e) => {
      if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
      if (e.ctrlKey && e.key === " ") { e.preventDefault(); document.getElementById("play-pause-btn").click(); }
      if (e.key === "Escape") {
        document.querySelectorAll(".analytics-modal,.share-modal,.todo-modal,.journal-modal,.mood-modal").forEach(m => m.classList.remove("show"));
      }
      if (e.key === " " && !e.ctrlKey) { e.preventDefault(); document.getElementById("start-timer").click(); }
      if (e.key === "r" || e.key === "R") document.getElementById("reset-timer").click();
    });

    // ============================================================
    // CHARACTER DRAG
    // ============================================================
    const characterImg = document.getElementById("character-image");
    const charContainer = document.getElementById("character-container");
    let isDragging = false;
    let startX = 0;
    let currentOutfit = 0;
    let dragMoved = false;

    const outfits = {
      arona: ["assets/images/arona.png","assets/images/arona_yukata.jpg"],
      plana: ["assets/images/plana.png","assets/images/plana_swimsuitSummer.jpg","assets/images/plana_bunnyGirl.jpg","assets/images/plana_kimono.jpg"],
    };

    const planaOutfitKeys = ["default","swimsuit","bunny","kimono"];
    const planaOutfitMessages = {
      default: ["Plana... hanya punya ini... maaf Sensei... üìñ","Seragam biasa ini... cukup untuk belajar... üìö","Plana merasa nyaman dengan ini... Sensei juga? üåô"],
      kimono: ["Kimono... apakah cocok? Plana agak malu... üå∏","Sensei suka? Plana... senang... sedikit... ‚ú®","Untuk acara spesial... Plana pakai ini... üéã","Kimono ini... warisan dari Sensei... eh, bukan! üíï"],
      bunny: ["S-sensei... jangan lihat... Plana salah ambil baju... üê∞üí¶","A-Arona yang suruh... Plana gak mau... tapi... üôà","Telinganya... jangan dipegang... Kyaa! üê∞üíï","Plana... jadi kelinci... mau Sensei elus? ... Eh?! üò≥"],
      swimsuit: ["I-ini cuma untuk berenang... jangan salah sangka... üèä‚Äç‚ôÄÔ∏è","Sensei kenapa lihat terus? Plana... Plana... ü´£","Airnya dingin... tapi Sensei lihat... jadi panas... üí¶","Jangan foto! ... Eh, Sensei? ... Boleh dikit... üì∏"],
    };
    const aronaOutfitMessages = ["Ehehe~ Outfit baru! Arona suka! üëó","Kamu suka outfit Arona yang ini, Sensei? üòä","Arona jadi lebih semangat belajar dengan outfit baru! ‚ú®","Cute? Arona selalu cute! Tapi makasih Sensei! üíï","Outfit baru! Arona makin cantik kan? üåü"];

    function changeOutfit(direction) {
      const bubble = document.getElementById("character-bubble");
      if (!bubble) return;
      if (outfits[currentMode].length <= 1) {
        bubble.textContent = currentMode === "arona" ? "Ini satu-satunya outfit Arona saat ini! üéÄ" : planaOutfitMessages.default[0];
        bubble.classList.add("show"); setTimeout(() => bubble.classList.remove("show"), 3000); return;
      }
      currentOutfit = (currentOutfit + direction + outfits[currentMode].length) % outfits[currentMode].length;
      if (characterImg) { characterImg.src = outfits[currentMode][currentOutfit]; safeSave(`${currentMode}Outfit`, currentOutfit); }
      if (currentMode === "arona") {
        bubble.textContent = aronaOutfitMessages[Math.floor(Math.random() * aronaOutfitMessages.length)];
      } else {
        const key = planaOutfitKeys[currentOutfit] || "default";
        const msgs = planaOutfitMessages[key];
        bubble.textContent = msgs[Math.floor(Math.random() * msgs.length)];
      }
      bubble.classList.add("show"); setTimeout(() => bubble.classList.remove("show"), 3000);
    }

    if (charContainer) {
      charContainer.addEventListener("mousedown", (e) => {
        isDragging = true; dragMoved = false; startX = e.clientX;
        charContainer.classList.add("dragging"); e.preventDefault();
      });
      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        if (Math.abs(dx) > 10) { dragMoved = true; charContainer.style.transform = `scale(1.05) translateX(${dx*0.3}px)`; charContainer.style.transition = "none"; }
      });
      document.addEventListener("mouseup", (e) => {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        if (Math.abs(dx) > 50) { changeOutfit(dx > 0 ? 1 : -1); }
        charContainer.style.transform = ""; charContainer.style.transition = "";
        charContainer.classList.remove("dragging");
        isDragging = false;
        if (!dragMoved) triggerCharacterReaction("greeting");
        dragMoved = false;
      });
      charContainer.addEventListener("touchstart", (e) => {
        isDragging = true; dragMoved = false; startX = e.touches[0].clientX;
        charContainer.classList.add("dragging"); e.preventDefault();
      }, { passive: false });
      document.addEventListener("touchmove", (e) => {
        if (!isDragging) return;
        const dx = e.touches[0].clientX - startX;
        if (Math.abs(dx) > 10) { dragMoved = true; charContainer.style.transform = `scale(1.05) translateX(${dx*0.3}px)`; charContainer.style.transition = "none"; }
      });
      document.addEventListener("touchend", (e) => {
        if (!isDragging) return;
        const dx = e.changedTouches[0].clientX - startX;
        if (Math.abs(dx) > 50) { changeOutfit(dx > 0 ? 1 : -1); }
        else if (!dragMoved) { triggerCharacterReaction("greeting"); }
        charContainer.style.transform = ""; charContainer.style.transition = "";
        charContainer.classList.remove("dragging"); isDragging = false; dragMoved = false;
      });
      charContainer.addEventListener("dragstart", e => e.preventDefault());
      charContainer.addEventListener("mouseenter", () => { if (!isDragging) charContainer.style.transform = "scale(1.05)"; });
      charContainer.addEventListener("mouseleave", () => { if (!isDragging) charContainer.style.transform = "scale(1)"; });
      charContainer.addEventListener("keydown", (e) => { if (e.key==="Enter"||e.key===" ") { e.preventDefault(); triggerCharacterReaction("greeting"); } });
    }

    // ============================================================
    // ANALYTICS MODAL
    // ============================================================
    document.getElementById("analytics-btn").addEventListener("click", showAnalytics);
    document.getElementById("close-analytics").addEventListener("click", () => document.getElementById("analytics-modal").classList.remove("show"));
    document.getElementById("analytics-modal").addEventListener("click", (e) => { if (e.target.id==="analytics-modal") document.getElementById("analytics-modal").classList.remove("show"); });

    // ============================================================
    // THEME TOGGLE
    // ============================================================
    const themeToggleBtn = document.getElementById("theme-toggle-btn");
    const sunIcon = document.getElementById("sun-icon");
    const moonIcon = document.getElementById("moon-icon");
    const body = document.body;
    const splashLogo = document.getElementById("splash-logo");
    const appTitle = document.getElementById("app-title");
    const backgroundOverlay = document.querySelector(".background-overlay");
    const splashScreen = document.getElementById("splash-screen");

    function createParticleEffect(el) {
      const r = el.getBoundingClientRect();
      const cx = r.left + r.width/2, cy = r.top + r.height/2;
      for (let i = 0; i < 12; i++) {
        const p = document.createElement("div");
        p.className = "particle";
        p.style.left = cx+"px"; p.style.top = cy+"px";
        p.style.setProperty("--tx", (Math.random()-0.5)*150+"px");
        document.body.appendChild(p);
        p.style.animation = "particle-float 1.2s ease-out forwards";
        setTimeout(() => { if (p.parentNode) p.remove(); }, 1200);
      }
    }

    function applyAronaThemeImmediately() {
      const img = document.getElementById("character-image");
      body.className = "theme-arona bg-pattern";
      if (splashScreen) splashScreen.className = "theme-arona";
      if (splashLogo) { splashLogo.textContent = "Arona Blue Archive"; splashLogo.className = "splash-logo theme-arona"; }
      if (sunIcon) sunIcon.classList.remove("hidden"); if (moonIcon) moonIcon.classList.add("hidden");
      if (img) img.src = "assets/images/arona.png";
      if (appTitle) appTitle.textContent = "Arona Study Companion";
      currentMode = "arona";
    }

    function applyPlanaThemeImmediately() {
      const img = document.getElementById("character-image");
      body.className = "theme-plana bg-pattern";
      if (splashScreen) splashScreen.className = "theme-plana";
      if (splashLogo) { splashLogo.textContent = "Plana Blue Archive"; splashLogo.className = "splash-logo theme-plana"; }
      if (sunIcon) sunIcon.classList.add("hidden"); if (moonIcon) moonIcon.classList.remove("hidden");
      if (img) img.src = "assets/images/plana.png";
      if (appTitle) appTitle.textContent = "Plana Study Companion";
      currentMode = "plana";
    }

    function switchTheme(toMode) {
      document.querySelectorAll(".fade-text").forEach(el => el.style.opacity = "0");
      setTimeout(() => {
        if (toMode === "arona") {
          body.classList.remove("theme-plana"); body.classList.add("theme-arona");
          if (sunIcon) sunIcon.classList.remove("hidden"); if (moonIcon) moonIcon.classList.add("hidden");
          document.getElementById("character-image").src = "assets/images/arona.png";
          appTitle.textContent = "Arona Study Companion";
          currentMode = "arona";
        } else {
          body.classList.remove("theme-arona"); body.classList.add("theme-plana");
          if (sunIcon) sunIcon.classList.add("hidden"); if (moonIcon) moonIcon.classList.remove("hidden");
          document.getElementById("character-image").src = "assets/images/plana.png";
          appTitle.textContent = "Plana Study Companion";
          currentMode = "plana";
        }
        safeSave("studyCompanionMode", toMode);
        currentOutfit = 0;
        const savedOutfit = safeLoad(`${currentMode}Outfit`);
        if (savedOutfit !== null) {
          currentOutfit = parseInt(savedOutfit);
          const img = document.getElementById("character-image");
          if (img && outfits[currentMode][currentOutfit]) img.src = outfits[currentMode][currentOutfit];
        }
        loadAchievements();
        triggerCharacterReaction("greeting");
        setTimeout(() => {
          document.querySelectorAll(".fade-text").forEach(el => el.style.opacity = "1");
        }, 400);
      }, 400);
    }

    themeToggleBtn.addEventListener("click", () => {
      createParticleEffect(themeToggleBtn);
      switchTheme(currentMode === "arona" ? "plana" : "arona");
    });

    // ============================================================
    // ONLINE / OFFLINE
    // ============================================================
    let isOnline = navigator.onLine;
    window.addEventListener("online", () => { isOnline = true; showNotification("Back Online", "Connection restored!", "success"); while(offlineQueue.length) offlineQueue.shift()(); });
    window.addEventListener("offline", () => { isOnline = false; showNotification("Offline Mode", "Some features limited", "info"); });

    // ============================================================
    // PWA
    // ============================================================
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try { const reg = await navigator.serviceWorker.register("/sw.js"); } catch(e) { console.log("SW failed:", e); }
      });
    }

    // ============================================================
    // AUTO SAVE
    // ============================================================
    function autoSaveProgress() {
      setInterval(() => {
        if (hasUnsavedChanges) { saveProgress(progress); hasUnsavedChanges = false; }
      }, 30000);
    }

    // ============================================================
    // IMAGE FALLBACK
    // ============================================================
    const charImageEl = document.getElementById("character-image");
    if (charImageEl) {
      charImageEl.addEventListener("error", function() {
        this.src = `data:image/svg+xml;base64,${btoa(`<svg width="320" height="384" viewBox="0 0 320 384" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="320" height="384" rx="16" fill="${currentMode==="arona"?"#38bdf8":"#c084fc"}"/><circle cx="160" cy="150" r="40" fill="white" fill-opacity="0.9"/><text x="160" y="260" text-anchor="middle" fill="white" font-family="Arial" font-size="24">${currentMode==="arona"?"Arona":"Plana"}</text></svg>`)}`;
      });
    }

    // ============================================================
    // INIT
    // ============================================================
    function initializeApp() {
      const savedMode = safeLoad("studyCompanionMode") || "arona";
      if (savedMode === "arona") applyAronaThemeImmediately();
      else applyPlanaThemeImmediately();

      progress = loadProgress();
      loadAchievements();
      loadStudyMetrics();
      loadTodos();
      renderTodoMini();
      updateAchievementsUI();
      updateDailyProgress(progress.dailySessions);
      updateStreakDisplay();

      playTrack(0);

      if (timerButtons[0]) {
        timerButtons[0].classList.add("bg-primary","text-white"); timerButtons[0].classList.remove("bg-primary-opacity"); timerButtons[0].setAttribute("aria-pressed","true");
      }

      updatePlaylistNumbers();
      updateStartButtonText();

      const savedOutfit = safeLoad(`${currentMode}Outfit`);
      if (savedOutfit !== null) {
        currentOutfit = parseInt(savedOutfit);
        const img = document.getElementById("character-image");
        if (img && outfits[currentMode][currentOutfit]) img.src = outfits[currentMode][currentOutfit];
      }

      autoSaveProgress();

      setTimeout(() => {
        if (splashScreen) {
          splashScreen.style.opacity = "0"; splashScreen.style.transform = "scale(1.1)";
          setTimeout(() => {
            splashScreen.style.display = "none";
            document.querySelectorAll(".page-transition").forEach(el => el.classList.add("page-loaded"));
            if ("Notification" in window && Notification.permission === "default") Notification.requestPermission();
            triggerCharacterReaction("greeting");
          }, 1000);
        }
      }, 2000);
    }

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", initializeApp);
    else initializeApp();
    </script>
  </body>
</html>