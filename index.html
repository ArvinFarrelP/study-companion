<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />
    <!-- PWA Head Tags (same as before) -->
    <link rel="icon" href="./favicon.ico" type="image/x-icon" />
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/images/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/images/favicon-16x16.png" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/images/icon-180x180.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="./assets/images/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="167x167" href="./assets/images/icon-167x167.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="./assets/images/icon-120x120.png" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#38bdf8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="msapplication-TileColor" content="#38bdf8" />
    <meta name="msapplication-TileImage" content="/assets/images/mstile-150x150.png" />
    <title>Study Companion</title>
    <meta name="description" content="Anime-style Pomodoro timer with focus companions, achievements, and productivity analytics. Stay focused with Arona, Plana, and Hina!" />
    <meta name="theme-color" content="#38bdf8" />
    <meta property="og:title" content="Study Companion - Anime Pomodoro Timer" />
    <meta property="og:description" content="Focus with Arona, Plana & Hina - Your anime study partner for better focus & productivity" />
    <meta property="og:image" content="/assets/images/social-preview.png" />
    <meta property="og:url" content="https://yourwebsite.com" />
    <meta name="twitter:card" content="summary_large_image" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      /* All your existing CSS styles remain exactly the same */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        height: 100%;
        overflow-x: hidden;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: "Inter", sans-serif;
        min-height: 100vh;
        background-attachment: fixed;
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
      }

      main {
        flex: 1 0 auto;
        width: 100%;
      }

      .timer-controls button:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }

      .music-controls button:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }

      .theme-toggle-btn:active {
        transform: scale(0.95) rotate(15deg);
        transition: transform 0.1s ease;
      }

      .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 8px;
        min-height: 20px;
      }

      .skeleton-circle {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 50%;
        width: 24px;
        height: 24px;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .site-footer {
        flex-shrink: 0;
        width: 100%;
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 24px 24px 0 0;
        transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        margin-top: auto;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        padding: 20px 0;
        cursor: grab;
        position: relative;
        transform-origin: center top;
      }

      .site-footer:active {
        cursor: grabbing;
        transform: scaleY(0.95);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .site-footer.pulled {
        transform: translateY(-40px) scaleY(1.05);
        border-radius: 20px;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .site-footer.released {
        transform: translateY(0) scaleY(1);
        transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .theme-arona .site-footer {
        background: rgba(255, 255, 255, 0.95);
        border-top-color: rgba(56, 189, 248, 0.3);
        color: #0c4a6e;
      }

      .theme-plana .site-footer {
        background: rgba(255, 255, 255, 0.95);
        border-top-color: rgba(192, 132, 252, 0.3);
        color: #4a044e;
      }

      .theme-hina .site-footer {
        background: rgba(255, 255, 255, 0.95);
        border-top-color: rgba(167, 139, 250, 0.3);
        color: #3b0764;
      }

      .footer-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
      }

      .footer-brand {
        text-align: center;
      }

      .footer-brand h3 {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 1.25rem;
      }

      .footer-brand p {
        opacity: 0.8;
        font-size: 0.875rem;
      }

      .donation-section {
        text-align: center;
        width: 100%;
      }

      .donation-title {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .donation-links {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 1rem;
        width: 100%;
      }

      .donation-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        min-width: 140px;
        min-height: 48px;
      }

      .theme-arona .donation-btn {
        background: rgba(56, 189, 248, 0.1);
        color: #0c4a6e;
        border-color: rgba(56, 189, 248, 0.3);
      }

      .theme-arona .donation-btn:hover {
        background: rgba(56, 189, 248, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(56, 189, 248, 0.2);
      }

      .theme-plana .donation-btn {
        background: rgba(192, 132, 252, 0.1);
        color: #4a044e;
        border-color: rgba(192, 132, 252, 0.3);
      }

      .theme-plana .donation-btn:hover {
        background: rgba(192, 132, 252, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(192, 132, 252, 0.2);
      }

      .theme-hina .donation-btn {
        background: rgba(167, 139, 250, 0.1);
        color: #3b0764;
        border-color: rgba(167, 139, 250, 0.3);
      }

      .theme-hina .donation-btn:hover {
        background: rgba(167, 139, 250, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(167, 139, 250, 0.2);
      }

      .donation-btn .heart {
        color: #ef4444;
        animation: heartbeat 1.5s ease-in-out infinite;
      }

      @keyframes heartbeat {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .donation-btn svg {
        width: 20px;
        height: 20px;
      }

      .footer-bottom {
        text-align: center;
        width: 100%;
        padding-top: 1rem;
        border-top: 1px solid;
        font-size: 0.875rem;
        opacity: 0.7;
      }

      .theme-arona .footer-bottom {
        border-top-color: rgba(56, 189, 248, 0.2);
      }

      .theme-plana .footer-bottom {
        border-top-color: rgba(192, 132, 252, 0.2);
      }

      .theme-hina .footer-bottom {
        border-top-color: rgba(167, 139, 250, 0.2);
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .sr-only:focus,
      .sr-only:focus-visible {
        position: static;
        width: auto;
        height: auto;
        padding: 1rem;
        margin: 0;
        overflow: visible;
        clip: auto;
        white-space: normal;
        background: white;
        border-radius: 4px;
        z-index: 10000;
        border: 2px solid currentColor;
      }

      button:focus-visible,
      input:focus-visible {
        outline: 2px solid currentColor;
        outline-offset: 2px;
        border-radius: 4px;
      }

      .glass:focus-within {
        outline: 2px solid rgba(56, 189, 248, 0.5);
        outline-offset: 2px;
      }

      @media (prefers-contrast: high) {
        .glass {
          border: 2px solid;
        }

        .theme-arona .glass {
          border-color: #0c4a6e;
        }

        .theme-plana .glass {
          border-color: #4a044e;
        }

        .theme-hina .glass {
          border-color: #3b0764;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }

        .float {
          animation: none;
        }

        .visualizer-bar {
          animation: none;
          height: 50% !important;
        }

        .donation-btn .heart {
          animation: none;
        }

        .timer-controls button:active {
          transform: none;
        }

        .skeleton,
        .skeleton-circle {
          animation: none;
        }
      }

      .theme-arona {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
        color: #0c4a6e;
      }

      .theme-arona .glass {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(56, 189, 248, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        color: #0c4a6e;
      }

      .theme-arona .glass p,
      .theme-arona .glass span,
      .theme-arona .glass h1,
      .theme-arona .glass h2,
      .theme-arona .glass h3,
      .theme-arona .glass h4,
      .theme-arona .glass div:not(.text-gray-400):not(.text-gray-500):not(.text-gray-600) {
        color: #0c4a6e;
      }

      .theme-arona .glow-box {
        box-shadow: 0 0 25px rgba(56, 189, 248, 0.3),
          inset 0 0 15px rgba(56, 189, 248, 0.1);
      }

      .theme-arona .character-glow {
        background: radial-gradient(circle, rgba(56, 189, 248, 0.3) 0%, transparent 70%);
      }

      .theme-arona .progress-fill {
        background: linear-gradient(90deg, #38bdf8, #0ea5e9);
      }

      .theme-arona .visualizer-bar {
        background-color: #38bdf8;
      }

      .theme-arona .text-primary {
        color: #38bdf8 !important;
      }

      .theme-arona .bg-primary {
        background-color: #38bdf8;
      }

      .theme-arona .bg-primary-opacity {
        background-color: rgba(56, 189, 248, 0.2);
      }

      .theme-arona .bg-pattern {
        background-image: radial-gradient(
            circle at 20% 30%,
            rgba(56, 189, 248, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(56, 189, 248, 0.1) 0%,
            transparent 50%
          );
      }

      .theme-plana {
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 50%, #ede9fe 100%);
        color: #4a044e;
      }

      .theme-plana .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(192, 132, 252, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        color: #4a044e;
      }

      .theme-plana .glass p,
      .theme-plana .glass span,
      .theme-plana .glass h1,
      .theme-plana .glass h2,
      .theme-plana .glass h3,
      .theme-plana .glass h4,
      .theme-plana .glass div:not(.text-gray-400):not(.text-gray-500):not(.text-gray-600) {
        color: #4a044e;
      }

      .theme-plana .glow-box {
        box-shadow: 0 0 25px rgba(192, 132, 252, 0.3),
          inset 0 0 15px rgba(192, 132, 252, 0.1);
      }

      .theme-plana .character-glow {
        background: radial-gradient(circle, rgba(192, 132, 252, 0.3) 0%, transparent 70%);
      }

      .theme-plana .progress-fill {
        background: linear-gradient(90deg, #c084fc, #a855f7);
      }

      .theme-plana .visualizer-bar {
        background-color: #c084fc;
      }

      .theme-plana .text-primary {
        color: #c084fc !important;
      }

      .theme-plana .bg-primary {
        background-color: #c084fc;
      }

      .theme-plana .bg-primary-opacity {
        background-color: rgba(192, 132, 252, 0.2);
      }

      .theme-plana .bg-pattern {
        background-image: radial-gradient(
            circle at 20% 30%,
            rgba(192, 132, 252, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(192, 132, 252, 0.1) 0%,
            transparent 50%
          );
      }

      .theme-hina {
        background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #e0e7ff 100%);
        color: #3b0764;
      }

      .theme-hina .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(167, 139, 250, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        color: #3b0764;
      }

      .theme-hina .glass p,
      .theme-hina .glass span,
      .theme-hina .glass h1,
      .theme-hina .glass h2,
      .theme-hina .glass h3,
      .theme-hina .glass h4,
      .theme-hina .glass div:not(.text-gray-400):not(.text-gray-500):not(.text-gray-600) {
        color: #3b0764;
      }

      .theme-hina .glow-box {
        box-shadow: 0 0 25px rgba(167, 139, 250, 0.3),
          inset 0 0 15px rgba(167, 139, 250, 0.1);
      }

      .theme-hina .character-glow {
        background: radial-gradient(circle, rgba(167, 139, 250, 0.3) 0%, transparent 70%);
      }

      .theme-hina .progress-fill {
        background: linear-gradient(90deg, #a78bfa, #7c3aed);
      }

      .theme-hina .visualizer-bar {
        background-color: #a78bfa;
      }

      .theme-hina .text-primary {
        color: #a78bfa !important;
      }

      .theme-hina .bg-primary {
        background-color: #a78bfa;
      }

      .theme-hina .bg-primary-opacity {
        background-color: rgba(167, 139, 250, 0.2);
      }

      .theme-hina .bg-pattern {
        background-image: radial-gradient(
            circle at 20% 30%,
            rgba(167, 139, 250, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(167, 139, 250, 0.1) 0%,
            transparent 50%
          );
      }

      .theme-arona .timer-controls button {
        color: #0c4a6e !important;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .theme-arona .timer-controls button.bg-primary {
        color: white !important;
        font-weight: 600;
      }

      .theme-arona .timer-controls button:hover {
        color: #0369a1 !important;
      }

      .theme-plana .timer-controls button {
        color: #4a044e !important;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .theme-plana .timer-controls button.bg-primary {
        color: white !important;
        font-weight: 600;
      }

      .theme-plana .timer-controls button:hover {
        color: #6b21a8 !important;
      }

      .theme-hina .timer-controls button {
        color: #3b0764 !important;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .theme-hina .timer-controls button.bg-primary {
        color: white !important;
        font-weight: 600;
      }

      .theme-hina .timer-controls button:hover {
        color: #5b21b6 !important;
      }

      .theme-arona #reset-timer {
        color: #0c4a6e !important;
        background-color: rgba(56, 189, 248, 0.15) !important;
        border: 1px solid rgba(56, 189, 248, 0.3) !important;
      }

      .theme-arona #reset-timer:hover {
        color: #0369a1 !important;
        background-color: rgba(56, 189, 248, 0.25) !important;
      }

      .theme-plana #reset-timer {
        color: #4a044e !important;
        background-color: rgba(192, 132, 252, 0.15) !important;
        border: 1px solid rgba(192, 132, 252, 0.3) !important;
      }

      .theme-plana #reset-timer:hover {
        color: #6b21a8 !important;
        background-color: rgba(192, 132, 252, 0.25) !important;
      }

      .theme-hina #reset-timer {
        color: #3b0764 !important;
        background-color: rgba(167, 139, 250, 0.15) !important;
        border: 1px solid rgba(167, 139, 250, 0.3) !important;
      }

      .theme-hina #reset-timer:hover {
        color: #5b21b6 !important;
        background-color: rgba(167, 139, 250, 0.25) !important;
      }

      .theme-arona .playlist-container .text-sm {
        color: #0c4a6e !important;
        font-weight: 600;
      }

      .theme-arona .playlist-container .text-xs.text-gray-400 {
        color: #475569 !important;
        font-weight: 500;
      }

      .theme-plana .playlist-container .text-sm {
        color: #4a044e !important;
        font-weight: 600;
      }

      .theme-plana .playlist-container .text-xs.text-gray-400 {
        color: #6b7280 !important;
        font-weight: 500;
      }

      .theme-hina .playlist-container .text-sm {
        color: #3b0764 !important;
        font-weight: 600;
      }

      .theme-hina .playlist-container .text-xs.text-gray-400 {
        color: #6b7280 !important;
        font-weight: 500;
      }

      .theme-arona .analytics-content {
        color: #0c4a6e;
      }

      .theme-arona .analytics-content .text-gray-600 {
        color: #475569 !important;
        font-weight: 500;
      }

      .theme-arona .analytics-content .bg-primary-opacity {
        background: rgba(56, 189, 248, 0.15);
        border: 1px solid rgba(56, 189, 248, 0.2);
      }

      .theme-arona #weekly-stats span {
        color: #0c4a6e;
        font-weight: 600;
      }

      .theme-arona #weekly-stats span.font-semibold {
        color: #0369a1;
        font-weight: 700;
      }

      .theme-plana .analytics-content {
        color: #4a044e;
      }

      .theme-plana .analytics-content .text-gray-600 {
        color: #6b7280 !important;
        font-weight: 500;
      }

      .theme-plana .analytics-content .bg-primary-opacity {
        background: rgba(192, 132, 252, 0.15);
        border: 1px solid rgba(192, 132, 252, 0.2);
      }

      .theme-plana #weekly-stats span {
        color: #4a044e;
        font-weight: 600;
      }

      .theme-plana #weekly-stats span.font-semibold {
        color: #7c3aed;
        font-weight: 700;
      }

      .theme-hina .analytics-content {
        color: #3b0764;
      }

      .theme-hina .analytics-content .text-gray-600 {
        color: #6b7280 !important;
        font-weight: 500;
      }

      .theme-hina .analytics-content .bg-primary-opacity {
        background: rgba(167, 139, 250, 0.15);
        border: 1px solid rgba(167, 139, 250, 0.2);
      }

      .theme-hina #weekly-stats span {
        color: #3b0764;
        font-weight: 600;
      }

      .theme-hina #weekly-stats span.font-semibold {
        color: #7c3aed;
        font-weight: 700;
      }

      .theme-arona .analytics-content .progress-bar {
        background: rgba(12, 74, 110, 0.25);
        height: 8px;
      }

      .theme-plana .analytics-content .progress-bar {
        background: rgba(74, 4, 78, 0.25);
        height: 8px;
      }

      .theme-hina .analytics-content .progress-bar {
        background: rgba(59, 7, 100, 0.25);
        height: 8px;
      }

      .theme-arona .glass {
        color: #0c4a6e;
      }

      .theme-plana .glass {
        color: #4a044e;
      }

      .theme-hina .glass {
        color: #3b0764;
      }

      .theme-arona #progress-title {
        color: #0c4a6e;
        font-weight: 700;
      }

      .theme-plana #progress-title {
        color: #4a044e;
        font-weight: 700;
      }

      .theme-hina #progress-title {
        color: #3b0764;
        font-weight: 700;
      }

      .theme-arona #analytics-btn {
        color: #0369a1;
        font-weight: 600;
      }

      .theme-plana #analytics-btn {
        color: #7c3aed;
        font-weight: 600;
      }

      .theme-hina #analytics-btn {
        color: #7c3aed;
        font-weight: 600;
      }

      .theme-arona #current-track-display {
        color: #0c4a6e !important;
        font-weight: 600;
      }

      .theme-arona #current-artist {
        color: #475569 !important;
        font-weight: 500;
      }

      .theme-plana #current-track-display {
        color: #4a044e !important;
        font-weight: 600;
      }

      .theme-plana #current-artist {
        color: #6b7280 !important;
        font-weight: 500;
      }

      .theme-hina #current-track-display {
        color: #3b0764 !important;
        font-weight: 600;
      }

      .theme-hina #current-artist {
        color: #6b7280 !important;
        font-weight: 500;
      }

      .glass {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .character-glow {
        position: absolute;
        width: 400px;
        height: 400px;
        filter: blur(60px);
        animation: pulse 3s ease-in-out infinite;
        pointer-events: none;
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.6;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .float {
        animation: float 4s ease-in-out infinite;
      }

      .bg-pattern {
        background-attachment: fixed;
        background-size: cover;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        overflow: hidden;
      }

      .theme-arona .progress-bar {
        background: rgba(12, 74, 110, 0.15);
      }

      .theme-plana .progress-bar {
        background: rgba(74, 4, 78, 0.15);
      }

      .theme-hina .progress-bar {
        background: rgba(59, 7, 100, 0.15);
      }

      .progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .visualizer-bar {
        animation: visualizer 1.5s ease-in-out infinite alternate;
      }

      @keyframes visualizer {
        0% {
          transform: scaleY(0.3);
        }
        100% {
          transform: scaleY(1);
        }
      }

      .theme-transition {
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .text-gray-300 {
        color: #64748b;
      }

      .theme-plana .text-gray-300 {
        color: #6b7280;
      }

      .theme-hina .text-gray-300 {
        color: #6b7280;
      }

      .text-gray-400 {
        color: #94a3b8;
      }

      .theme-plana .text-gray-400 {
        color: #9ca3af;
      }

      .theme-hina .text-gray-400 {
        color: #9ca3af;
      }

      .bg-gray-600 {
        background-color: #cbd5e1;
      }

      .bg-gray-700 {
        background-color: #e2e8f0;
      }

      .character-transform {
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .character-transform:hover {
        transform: scale(1.05);
      }

      .fade-text {
        transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        pointer-events: none;
        opacity: 0;
      }

      .theme-arona .particle {
        background: #38bdf8;
      }

      .theme-plana .particle {
        background: #c084fc;
      }

      .theme-hina .particle {
        background: #a78bfa;
      }

      @keyframes particle-float {
        0% {
          transform: translateY(0) translateX(0);
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) translateX(var(--tx, 0));
          opacity: 0;
        }
      }

      .character-fallback {
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .character-fallback:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      }

      .character-fallback:focus {
        outline: 2px solid currentColor;
        outline-offset: 2px;
      }

      .achievement-badge {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        border-radius: 16px;
        margin: 5px;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
        padding: 8px;
        border: 2px solid transparent;
      }

      .achievement-unlocked {
        background: linear-gradient(
          135deg,
          var(--primary-color, #38bdf8),
          var(--secondary-color, #0ea5e9)
        );
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transform: scale(1.05);
      }

      .achievement-locked {
        background: rgba(255, 255, 255, 0.5);
        border: 2px dashed rgba(0, 0, 0, 0.2);
        filter: grayscale(1);
        opacity: 0.7;
      }

      .achievement-icon {
        width: 48px;
        height: 48px;
        object-fit: contain;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        transition: transform 0.2s ease;
        margin-bottom: 4px;
      }

      .achievement-badge:hover .achievement-icon {
        transform: scale(1.1);
      }

      .achievement.locked .achievement-icon {
        filter: grayscale(100%);
        opacity: 0.4;
      }

      .achievement.unlocked .achievement-icon {
        filter: drop-shadow(0 0 6px rgba(80, 160, 255, 0.6));
      }

      .achievement-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 10;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .achievement-badge:hover .achievement-tooltip {
        opacity: 1;
      }

      .achievement-progress {
        font-size: 10px;
        margin-top: 2px;
        font-weight: 600;
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 6px;
        border-radius: 8px;
      }

      .achievement-rare {
        border: 2px solid gold;
        box-shadow: 0 0 15px gold;
      }

      .achievement-common {
        border: 2px solid silver;
      }

      .progress-ring {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: conic-gradient(
          var(--primary-color) 0% var(--progress),
          #e5e7eb var(--progress) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        position: relative;
      }

      .progress-ring::before {
        content: "";
        position: absolute;
        width: 50px;
        height: 50px;
        background: white;
        border-radius: 50%;
        z-index: 1;
      }

      .progress-ring span {
        position: relative;
        z-index: 2;
      }

      #splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 1s ease, transform 1s ease;
      }

      .theme-arona #splash-screen {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
      }

      .theme-plana #splash-screen {
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 50%, #ede9fe 100%);
      }

      .theme-hina #splash-screen {
        background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #e0e7ff 100%);
      }

      .splash-logo {
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 1rem;
        transition: all 0.8s ease;
      }

      .theme-arona .splash-logo {
        background: linear-gradient(135deg, #38bdf8, #0ea5e9);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .theme-plana .splash-logo {
        background: linear-gradient(135deg, #c084fc, #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .theme-hina .splash-logo {
        background: linear-gradient(135deg, #a78bfa, #7c3aed);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .splash-loader {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .theme-arona .splash-loader {
        border: 3px solid rgba(56, 189, 248, 0.3);
        border-top: 3px solid #38bdf8;
      }

      .theme-plana .splash-loader {
        border: 3px solid rgba(192, 132, 252, 0.3);
        border-top: 3px solid #c084fc;
      }

      .theme-hina .splash-loader {
        border: 3px solid rgba(167, 139, 250, 0.3);
        border-top: 3px solid #a78bfa;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .page-transition {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .page-loaded {
        opacity: 1;
        transform: translateY(0);
      }

      .background-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .theme-arona .background-overlay {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
      }

      .theme-plana .background-overlay {
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 50%, #ede9fe 100%);
      }

      .theme-hina .background-overlay {
        background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #e0e7ff 100%);
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        backdrop-filter: blur(12px);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 300px;
      }

      .theme-arona .notification {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(56, 189, 248, 0.3);
      }

      .theme-plana .notification {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(192, 132, 252, 0.3);
      }

      .theme-hina .notification {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(167, 139, 250, 0.3);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        border-left: 4px solid #10b981;
      }

      .notification.info {
        border-left: 4px solid;
      }

      .theme-arona .notification.info {
        border-left-color: #38bdf8;
      }

      .theme-plana .notification.info {
        border-left-color: #c084fc;
      }

      .theme-hina .notification.info {
        border-left-color: #a78bfa;
      }

      .session-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .session-completed {
        background-color: #10b981;
      }

      .session-current {
        animation: pulse 2s infinite;
      }

      .theme-arona .session-current {
        background-color: #38bdf8;
      }

      .theme-plana .session-current {
        background-color: #c084fc;
      }

      .theme-hina .session-current {
        background-color: #a78bfa;
      }

      .session-pending {
        background-color: #e5e7eb;
      }

      .theme-plana .session-pending {
        background-color: #e5e7eb;
      }

      .theme-hina .session-pending {
        background-color: #e5e7eb;
      }

      .session-counter {
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        backdrop-filter: blur(8px);
      }

      .theme-arona .session-counter {
        background: rgba(56, 189, 248, 0.2);
        border: 1px solid rgba(56, 189, 248, 0.3);
        color: #0c4a6e;
      }

      .theme-plana .session-counter {
        background: rgba(192, 132, 252, 0.2);
        border: 1px solid rgba(192, 132, 252, 0.3);
        color: #7c3aed;
      }

      .theme-hina .session-counter {
        background: rgba(167, 139, 250, 0.2);
        border: 1px solid rgba(167, 139, 250, 0.3);
        color: #3b0764;
      }

      .playlist-number {
        width: 1.75rem;
        height: 1.75rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .playlist-active {
        color: white;
      }

      .theme-arona .playlist-active {
        background: rgba(56, 189, 248, 0.2);
        color: #0c4a6e;
      }

      .theme-plana .playlist-active {
        background: rgba(192, 132, 252, 0.2);
        color: #7c3aed;
      }

      .theme-hina .playlist-active {
        background: rgba(167, 139, 250, 0.2);
        color: #3b0764;
      }

      .playlist-inactive {
        background: rgba(156, 163, 175, 0.1);
        color: #64748b;
      }

      .theme-plana .playlist-inactive {
        color: #6b7280;
      }

      .theme-hina .playlist-inactive {
        color: #6b7280;
      }

      /* Character bubble with photo styles - Glassmorphism Effect */
      #character-bubble {
        position: absolute;
        top: -60px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20;
        min-width: 220px;
        max-width: 280px;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        pointer-events: none;
        filter: drop-shadow(0 8px 20px rgba(0,0,0,0.15));
      }

      /* Memastikan semua foto dalam bubble lingkaran sempurna */
      #character-bubble img,
      .character-bubble img,
      .bubble-avatar {
          width: 40px !important;
          height: 40px !important;
          border-radius: 50% !important;
          object-fit: cover !important;      /* Memotong foto agar pas di lingkaran */
          object-position: center !important; /* Fokus ke tengah gambar */
          aspect-ratio: 1 / 1 !important;    /* Memaksa rasio 1:1 (lingkaran sempurna) */
          border: 2px solid;
          transition: all 0.3s ease;
          background-color: #f0f0f0; /* Warna background sementara */
      }

      /* Efek saat gambar loading */
      .bubble-avatar {
          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
          background-size: 200% 100%;
          animation: loading 1.5s infinite;
      }

      @keyframes loading {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
      }

      /* Hilangkan loading saat gambar sudah load */
      .bubble-avatar:not([src=""]) {
          animation: none;
          background: none;
      }

      /* Untuk mobile */
      @media (max-width: 768px) {
          #character-bubble img,
          .character-bubble img,
          .bubble-avatar {
              width: 32px !important;
              height: 32px !important;
          }
      }

      #character-bubble.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-5px);
      }

      /* Bubble content with glass effect - TERANG */
      #character-bubble > div {
        background: rgba(255, 255, 255, 0.95) !important; /* Lebih terang */
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        border-radius: 16px !important;
        padding: 10px !important;
      }

      /* Teks di bubble */
      #character-bubble > div span {
        color: #1e293b !important; /* Lebih gelap agar kontras */
        font-weight: 500;
      }

      /* Efek glow saat muncul */
      #character-bubble.show > div {
        animation: bubble-appear 0.3s ease-out;
      }

      @keyframes bubble-appear {
        0% {
          opacity: 0;
          transform: scale(0.8);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Panah bubble */
      #character-bubble::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 12px solid transparent;
        border-right: 12px solid transparent;
        border-top: 12px solid rgba(255, 255, 255, 0.95);
        filter: drop-shadow(0 4px 4px rgba(0,0,0,0.05));
      }

      /* Dark mode support - TETAP TERANG */
      @media (prefers-color-scheme: dark) {
        #character-bubble > div {
          background: rgba(255, 255, 255, 0.9) !important; /* Tetap terang meskipun dark mode */
          backdrop-filter: blur(8px);
          border: 1px solid rgba(255, 255, 255, 0.5);
        }
        #character-bubble > div span {
          color: #0f172a !important; /* Lebih gelap untuk kontras */
        }
        #character-bubble::after {
          border-top-color: rgba(255, 255, 255, 0.9);
        }
      }

      /* Mobile responsive */
      @media (max-width: 768px) {
        /* Perkecil streak badge di focus session */
        .streak-badge {
            padding: 0.4rem 0.8rem !important;  /* Lebih kecil */
            font-size: 0.8rem !important;       /* Lebih kecil */
        }
        
        #streak-emoji {
            font-size: 1rem !important;         /* Sama dengan teks */
        }
        
        #streak-number {
            font-size: 0.9rem !important;
        }
        #character-bubble {
          top: -50px;
          min-width: 180px;
          max-width: 220px;
        }
        
        #character-bubble > div {
          padding: 6px !important;
        }
        
        #character-bubble img {
          width: 32px !important;
          height: 32px !important;
        }
        
        #character-bubble span {
          font-size: 11px !important;
        }
      }

      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 100;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .theme-toggle-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        backdrop-filter: blur(12px);
        cursor: pointer;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
      }

      .theme-arona .theme-toggle-btn {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(56, 189, 248, 0.3);
        box-shadow: 0 0 25px rgba(56, 189, 248, 0.3),
          inset 0 0 15px rgba(56, 189, 248, 0.1);
      }

      .theme-plana .theme-toggle-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(192, 132, 252, 0.3);
        box-shadow: 0 0 25px rgba(192, 132, 252, 0.3),
          inset 0 0 15px rgba(192, 132, 252, 0.1);
      }

      .theme-hina .theme-toggle-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(167, 139, 250, 0.3);
        box-shadow: 0 0 25px rgba(167, 139, 250, 0.3),
          inset 0 0 15px rgba(167, 139, 250, 0.1);
      }

      .theme-toggle-btn:hover {
        transform: scale(1.1) rotate(15deg);
      }

      .theme-toggle-btn:focus {
        outline: 2px solid currentColor;
        outline-offset: 2px;
      }

      .analytics-modal, .share-modal, .todo-modal, .session-reflection-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .analytics-modal.show, .share-modal.show, .todo-modal.show, .session-reflection-modal.show {
        opacity: 1;
        pointer-events: all;
      }

      .analytics-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .analytics-modal.show .analytics-content {
        transform: scale(1);
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .share-modal.show .modal-content,
      .todo-modal.show .modal-content,
      .session-reflection-modal.show .modal-content {
        transform: scale(1);
      }

      .share-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.3s ease;
        width: 100%;
        margin-bottom: 0.5rem;
        min-height: 48px;
      }

      .share-btn:hover {
        transform: translateX(4px);
      }

      .theme-arona .share-btn {
        background: rgba(56, 189, 248, 0.1);
        color: #0c4a6e;
        border: 1px solid rgba(56, 189, 248, 0.3);
      }

      .theme-plana .share-btn {
        background: rgba(192, 132, 252, 0.1);
        color: #4a044e;
        border: 1px solid rgba(192, 132, 252, 0.3);
      }

      .theme-hina .share-btn {
        background: rgba(167, 139, 250, 0.1);
        color: #3b0764;
        border: 1px solid rgba(167, 139, 250, 0.3);
      }

      .share-btn-cancel {
        background: #f1f5f9 !important;
        color: #64748b !important;
        border: 1px solid #e2e8f0 !important;
        margin-top: 0.5rem;
      }

      .streak-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.5rem 1rem;
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
      }

      .theme-arona .streak-badge {
        background: rgba(251, 191, 36, 0.2);
        color: #92400e;
        border: 1px solid rgba(251, 191, 36, 0.4);
      }

      .theme-plana .streak-badge {
        background: rgba(251, 191, 36, 0.2);
        color: #92400e;
        border: 1px solid rgba(251, 191, 36, 0.4);
      }

      .theme-hina .streak-badge {
        background: rgba(251, 191, 36, 0.2);
        color: #92400e;
        border: 1px solid rgba(251, 191, 36, 0.4);
      }

      .todo-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 10px;
        margin-bottom: 0.4rem;
        transition: all 0.2s ease;
      }

      .theme-arona .todo-item {
        background: rgba(56, 189, 248, 0.06);
        border: 1px solid rgba(56, 189, 248, 0.15);
      }

      .theme-plana .todo-item {
        background: rgba(192, 132, 252, 0.06);
        border: 1px solid rgba(192, 132, 252, 0.15);
      }

      .theme-hina .todo-item {
        background: rgba(167, 139, 250, 0.06);
        border: 1px solid rgba(167, 139, 250, 0.15);
      }

      .todo-item.completed {
        opacity: 0.5;
      }

      .todo-item.completed .todo-text {
        text-decoration: line-through;
      }

      .todo-checkbox {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s ease;
      }

      .theme-arona .todo-checkbox {
        border-color: #38bdf8;
      }

      .theme-plana .todo-checkbox {
        border-color: #c084fc;
      }

      .theme-hina .todo-checkbox {
        border-color: #a78bfa;
      }

      .todo-checkbox.checked {
        color: white;
      }

      .theme-arona .todo-checkbox.checked {
        background: #38bdf8;
        border-color: #38bdf8;
      }

      .theme-plana .todo-checkbox.checked {
        background: #c084fc;
        border-color: #c084fc;
      }

      .theme-hina .todo-checkbox.checked {
        background: #a78bfa;
        border-color: #a78bfa;
      }

      .todo-text {
        font-size: 0.875rem;
        flex: 1;
      }

      .todo-delete {
        color: #94a3b8;
        cursor: pointer;
        font-size: 14px;
        padding: 2px 6px;
        border-radius: 4px;
        border: none;
        background: none;
        transition: color 0.2s;
      }

      .todo-delete:hover {
        color: #ef4444;
      }

      .todo-add-row {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
      }

      .todo-input {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        border: 1px solid;
        font-size: 0.875rem;
        outline: none;
      }

      .theme-arona .todo-input {
        border-color: rgba(56, 189, 248, 0.3);
        color: #0c4a6e;
      }

      .theme-plana .todo-input {
        border-color: rgba(192, 132, 252, 0.3);
        color: #4a044e;
      }

      .theme-hina .todo-input {
        border-color: rgba(167, 139, 250, 0.3);
        color: #3b0764;
      }

      .todo-add-btn {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        transition: opacity 0.2s;
        min-height: 44px;
      }

      .theme-arona .todo-add-btn {
        background: #38bdf8;
      }

      .theme-plana .todo-add-btn {
        background: #c084fc;
      }

      .theme-hina .todo-add-btn {
        background: #a78bfa;
      }

      .todo-add-btn:hover {
        opacity: 0.85;
      }

      .mood-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.3rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 2px solid transparent;
        cursor: pointer;
        background: none;
        transition: all 0.2s ease;
        font-size: 0.75rem;
        font-weight: 600;
        min-width: 70px;
        min-height: 70px;
      }

      .mood-btn:hover {
        transform: scale(1.05);
      }

      .mood-btn.selected {
        border-color: currentColor;
      }

      .theme-arona .mood-btn:hover, .theme-arona .mood-btn.selected {
        background: rgba(56, 189, 248, 0.1);
        border-color: #38bdf8;
        color: #0c4a6e;
      }

      .theme-plana .mood-btn:hover, .theme-plana .mood-btn.selected {
        background: rgba(192, 132, 252, 0.1);
        border-color: #c084fc;
        color: #4a044e;
      }

      .theme-hina .mood-btn:hover, .theme-hina .mood-btn.selected {
        background: rgba(167, 139, 250, 0.1);
        border-color: #a78bfa;
        color: #3b0764;
      }

      .mood-emoji {
        font-size: 2rem;
      }

      .reflection-textarea {
        width: 100%;
        min-height: 120px;
        padding: 0.75rem;
        border-radius: 10px;
        border: 1px solid;
        font-size: 0.875rem;
        font-family: inherit;
        resize: vertical;
        outline: none;
        transition: border-color 0.2s;
      }

      .theme-arona .reflection-textarea {
        border-color: rgba(56, 189, 248, 0.3);
        color: #0c4a6e;
      }

      .theme-arona .reflection-textarea:focus {
        border-color: #38bdf8;
      }

      .theme-plana .reflection-textarea {
        border-color: rgba(192, 132, 252, 0.3);
        color: #4a044e;
      }

      .theme-plana .reflection-textarea:focus {
        border-color: #c084fc;
      }

      .theme-hina .reflection-textarea {
        border-color: rgba(167, 139, 250, 0.3);
        color: #3b0764;
      }

      .theme-hina .reflection-textarea:focus {
        border-color: #a78bfa;
      }

      .reflection-entry {
        padding: 0.75rem;
        border-radius: 10px;
        margin-bottom: 0.75rem;
      }

      .theme-arona .reflection-entry {
        background: rgba(56, 189, 248, 0.06);
        border-left: 3px solid #38bdf8;
      }

      .theme-plana .reflection-entry {
        background: rgba(192, 132, 252, 0.06);
        border-left: 3px solid #c084fc;
      }

      .theme-hina .reflection-entry {
        background: rgba(167, 139, 250, 0.06);
        border-left: 3px solid #a78bfa;
      }

      .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        background: var(--confetti-color);
        opacity: 0;
        z-index: 9999;
      }

      .dragging {
        opacity: 0.8 !important;
        transition: none !important;
        cursor: grabbing !important;
      }

      #character-container {
        cursor: grab;
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
      }

      #character-container:active {
        cursor: grabbing;
      }

      #character-container img {
        pointer-events: none;
        -webkit-user-drag: none;
        user-drag: none;
      }

      .dragging {
        opacity: 0.7;
        transition: opacity 0.1s ease;
        cursor: grabbing;
      }

      /* Daily Progress Bar Styles */
      .daily-progress-container {
        width: 100%;
        margin-top: 0.5rem;
      }

      .daily-progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 20px;
        overflow: hidden;
      }

      .daily-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #34d399);
        border-radius: 20px;
        transition: width 0.3s ease;
      }

      .daily-progress-text {
        font-size: 0.75rem;
        margin-top: 4px;
        color: #64748b;
        text-align: center;
      }

      .theme-plana .daily-progress-fill {
        background: linear-gradient(90deg, #c084fc, #a855f7);
      }

      .theme-hina .daily-progress-fill {
        background: linear-gradient(90deg, #a78bfa, #7c3aed);
      }

      /* ===== TAMBAHKAN INI DI BAGIAN STREAK CALENDAR STYLES ===== */

      /* Animasi api sederhana */
      @keyframes flicker {
          0%, 100% { transform: scale(1); filter: drop-shadow(0 0 2px #ff6b00); }
          50% { transform: scale(1.2); filter: drop-shadow(0 0 8px #ff4500); }
      }

      #streak-display {
          display: inline-flex;
          align-items: center;
          gap: 4px;
          transition: all 0.3s ease;
      }

      .streak-fire {
          display: inline-block;
          animation: flicker 1.5s ease-in-out infinite;
          transform-origin: center;
      }

      /* Warna berbeda tiap streak */
      .streak-fire[data-streak="1-3"] { color: #ff9800; }
      .streak-fire[data-streak="4-6"] { color: #ff5722; animation-duration: 1s; }
      .streak-fire[data-streak="7-13"] { color: #f44336; animation-duration: 0.8s; }
      .streak-fire[data-streak="14+"] { 
          color: #ffd700; 
          animation-duration: 0.6s;
          text-shadow: 0 0 10px #ff4500;
      }

      /* Streak Calendar Styles */
      .streak-calendar {
        display: flex;
        justify-content: space-between;
        gap: 4px;
        margin-top: 8px;
      }

      .streak-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
      }

      .streak-day-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .streak-day-circle:hover {
        transform: scale(1.1);
      }

      .streak-day-label {
        font-size: 10px;
        margin-top: 4px;
        color: #64748b;
      }

      .streak-studied {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 2px 8px rgba(var(--primary-rgb), 0.3);
      }

      .streak-today {
        border: 2px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
      }

      .streak-missed {
        background: #e5e7eb;
        color: #9ca3af;
      }

      .streak-goal {
        font-size: 11px;
        text-align: center;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 12px;
        background: rgba(0,0,0,0.05);
      }

      .theme-arona {
        --primary-color: #38bdf8;
        --primary-rgb: 56, 189, 248;
      }

      .theme-plana {
        --primary-color: #c084fc;
        --primary-rgb: 192, 132, 252;
      }

      .theme-hina {
        --primary-color: #a78bfa;
        --primary-rgb: 167, 139, 250;
      }

      /* PERBAIKAN UTAMA UNTUK MOBILE */
      @media (max-width: 768px) {
        .flex-col.lg\:flex-row {
          flex-direction: column;
        }

        .character-container img {
          width: 200px;
          height: 250px;
        }

        .character-fallback {
          width: 200px !important;
          height: 250px !important;
        }

        .glass {
          padding: 1rem;
        }

        .glass.rounded-2xl.p-6.mt-6 {
          padding: 1.25rem;
          border-radius: 28px;
        }

        .text-3xl {
          font-size: 1.5rem;
        }

        .text-4xl {
          font-size: 2rem;
        }

        .text-4xl.timer-display {
          font-size: 3.5rem;
          font-weight: 700;
          line-height: 1.2;
          margin: 0.5rem 0;
        }

        .theme-toggle {
          top: 10px;
          right: 10px;
        }

        .achievement-badge {
          width: 70px;
          height: 70px;
        }

        .achievement-icon {
          width: 42px;
          height: 42px;
        }

        .analytics-content, .modal-content {
          padding: 1rem;
          margin: 1rem;
        }

        .footer-content {
          padding: 1rem;
          gap: 1rem;
        }

        .donation-links {
          flex-direction: column;
          align-items: center;
          gap: 0.75rem;
        }

        .donation-btn {
          width: 100%;
          max-width: 280px;
          justify-content: center;
          padding: 0.75rem;
          min-height: 48px;
        }

        .footer-brand h3 {
          font-size: 1.1rem;
        }

        .footer-brand p {
          font-size: 0.8rem;
        }

        .donation-title {
          font-size: 1rem;
          flex-wrap: wrap;
        }

        /* PERBAIKAN TIMER CONTROLS */
        .timer-controls button {
          min-height: 48px;
          padding: 12px 20px;
          font-size: 16px;
          font-weight: 600;
          border-radius: 14px;
        }

        .timer-controls {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 0.5rem;
          width: 100%;
        }

        .timer-controls button[data-time] {
          min-height: 48px;
          padding: 12px 8px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 12px;
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .timer-controls button[data-time]:active {
          transform: scale(0.96);
        }

        .timer-controls button[data-time].bg-primary {
          box-shadow: 0 4px 12px currentColor;
          animation: pulse-glow 2s infinite;
        }

        .flex.justify-center.gap-2.timer-controls {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
        }

        .flex.justify-center.gap-2.timer-controls button {
          flex: 1 1 auto;
          min-width: 100px;
          min-height: 48px;
          padding: 12px 16px;
          font-size: 15px;
          font-weight: 600;
          border-radius: 14px;
          letter-spacing: 0.3px;
        }

        #todo-btn {
          background: rgba(56, 189, 248, 0.15);
          border: 1px solid rgba(56, 189, 248, 0.3);
          backdrop-filter: blur(4px);
        }

        .theme-plana #todo-btn {
          background: rgba(192, 132, 252, 0.15);
          border-color: rgba(192, 132, 252, 0.3);
        }

        .theme-hina #todo-btn {
          background: rgba(167, 139, 250, 0.15);
          border-color: rgba(167, 139, 250, 0.3);
        }

        #current-cycle {
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
          font-weight: 700;
          border-radius: 30px;
        }

        .session-circle {
          width: 28px;
          height: 28px;
          border-width: 2px;
        }

        .music-controls button {
          min-width: 48px;
          min-height: 48px;
        }

        .playlist-container {
          max-height: 200px;
        }

        .character-interaction {
          max-width: 150px;
          font-size: 11px;
        }

        /* Streak calendar mobile */
        .streak-day-circle {
          width: 28px;
          height: 28px;
          font-size: 11px;
        }
      }

      @media (max-width: 480px) {
        .character-container img {
          width: 150px;
          height: 200px;
        }

        .character-fallback {
          width: 150px !important;
          height: 200px !important;
        }

        .timer-controls {
          gap: 0.4rem;
        }

        .timer-controls button {
          width: 100%;
        }

        .text-4xl.timer-display {
          font-size: 3rem;
        }

        .achievement-badge {
          width: 60px;
          height: 60px;
        }

        .achievement-icon {
          width: 36px;
          height: 36px;
        }

        .splash-logo {
          font-size: 2rem;
        }

        .footer-content {
          padding: 0.75rem;
        }

        .donation-btn {
          padding: 0.6rem 1rem;
          font-size: 0.875rem;
          min-width: 120px;
        }

        .footer-bottom {
          font-size: 0.75rem;
          padding-top: 0.75rem;
        }

        .streak-day-circle {
          width: 24px;
          height: 24px;
          font-size: 10px;
        }
      }

      /* Untuk layar sangat kecil */
      @media (max-width: 400px) {
        .timer-controls button[data-time] {
          min-height: 44px;
          font-size: 13px;
          padding: 8px 4px;
        }

        .flex.justify-center.gap-2.timer-controls button {
          min-width: 80px;
          min-height: 44px;
          padding: 8px 12px;
          font-size: 14px;
        }

        .text-4xl.timer-display {
          font-size: 2.5rem;
        }

        .flex.justify-between.items-center.mb-4 {
          padding: 0.4rem;
        }

        .streak-badge, #current-cycle {
          padding: 0.4rem 0.8rem;
          font-size: 0.8rem;
        }

        .session-circle {
          width: 22px;
          height: 22px;
        }
      }

      @media (min-width: 769px) and (max-width: 1024px) {
        .character-container img {
          width: 250px;
          height: 300px;
        }

        .character-fallback {
          width: 250px !important;
          height: 300px !important;
        }

        .main-content {
          max-width: 95%;
        }

        .donation-btn {
          min-width: 160px;
        }
      }

      @media (min-width: 1025px) {
        .footer-content {
          padding: 2rem;
        }
      }

      @media (hover: hover) {
        .timer-controls button:hover {
          transform: translateY(-2px);
        }
      }

      @keyframes pulse-glow {
        0%, 100% {
          box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }
        50% {
          box-shadow: 0 6px 16px rgba(56, 189, 248, 0.5);
        }
      }

      .theme-plana .timer-controls button[data-time].bg-primary {
        animation: pulse-glow-plana 2s infinite;
      }

      @keyframes pulse-glow-plana {
        0%, 100% {
          box-shadow: 0 4px 12px rgba(192, 132, 252, 0.3);
        }
        50% {
          box-shadow: 0 6px 16px rgba(192, 132, 252, 0.5);
        }
      }

      .theme-hina .timer-controls button[data-time].bg-primary {
        animation: pulse-glow-hina 2s infinite;
      }

      @keyframes pulse-glow-hina {
        0%, 100% {
          box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3);
        }
        50% {
          box-shadow: 0 6px 16px rgba(167, 139, 250, 0.5);
        }
      }

      button, 
      [role="button"],
      .achievement-badge {
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }

      button:active,
      [role="button"]:active,
      .achievement-badge:active {
        transform: scale(0.97);
        transition: transform 0.1s;
      }

      @media (prefers-color-scheme: dark) {
        .theme-arona {
          background: linear-gradient(135deg, #0c4a6e 0%, #075985 50%, #0369a1 100%);
          color: #f0f9ff;
        }

        .theme-plana {
          background: linear-gradient(135deg, #4a044e 0%, #6b21a8 50%, #7e22ce 100%);
          color: #faf5ff;
        }

        .theme-hina {
          background: linear-gradient(135deg, #3b0764 0%, #5b21b6 50%, #6d28d9 100%);
          color: #f5f3ff;
        }
      }
    </style>
  </head>
  <body
    class="theme-arona bg-pattern"
    aria-label="Study Companion with Anime Pomodoro Timer"
  >
    <a href="#main-content" class="sr-only"> Skip to main content </a>

    <div class="background-overlay" aria-hidden="true"></div>

    <div class="theme-toggle page-transition">
      <button
        id="theme-toggle-btn"
        class="theme-toggle-btn"
        aria-label="Switch theme between Arona, Plana, and Hina"
        aria-live="polite"
      >
        <svg
          id="sun-icon"
          class="w-6 h-6 text-yellow-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          />
        </svg>
        <svg
          id="moon-icon"
          class="w-6 h-6 text-purple-500 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          />
        </svg>
        <svg
          id="hina-icon"
          class="w-6 h-6 text-violet-500 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
          />
        </svg>
      </button>
    </div>

    <div
      id="notification"
      class="notification info"
      aria-live="polite"
      aria-atomic="true"
      role="alert"
      style="display: none"
    >
      <div class="flex items-center">
        <div class="mr-3" aria-hidden="true">
          <svg
            class="w-6 h-6 text-primary"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </div>
        <div>
          <h4 class="font-semibold text-primary" id="notification-title">
            Timer Complete!
          </h4>
          <p class="text-sm text-gray-600" id="notification-message">
            Time for a short break
          </p>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="share-modal" role="dialog" aria-modal="true" aria-labelledby="share-modal-title">
      <div class="modal-content glass">
        <h3 id="share-modal-title" class="text-lg font-bold text-primary mb-1"> Achievement Unlocked!</h3>
        <p id="share-modal-desc" class="text-sm text-gray-600 mb-4"></p>
        <button class="share-btn" id="share-native-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
          Share Achievement
        </button>
        <button class="share-btn" id="share-copy-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          Copy to Clipboard
        </button>
        <button class="share-btn share-btn-cancel" id="share-cancel-btn">Close</button>
      </div>
    </div>

    <!-- Session Reflection Modal (Mood + Journal) -->
    <div id="session-reflection-modal" class="session-reflection-modal" role="dialog" aria-modal="true" aria-labelledby="reflection-modal-title">
      <div class="modal-content glass">
        <div class="flex justify-between items-center mb-4">
          <h3 id="reflection-modal-title" class="text-lg font-bold text-primary"> Session Reflection</h3>
          <button id="close-reflection" class="text-gray-400 hover:text-primary" aria-label="Close reflection"></button>
        </div>
        
        <!-- Mood Section -->
        <div class="mb-4">
          <p class="text-sm font-medium text-gray-600 mb-2">How are you feeling after this session?</p>
          <div class="flex justify-center gap-2 flex-wrap" id="reflection-mood-buttons">
            <button class="mood-btn" data-mood="energized" data-label="Energized">
              <span class="mood-emoji"></span><span>Energized</span>
            </button>
            <button class="mood-btn" data-mood="happy" data-label="Happy">
              <span class="mood-emoji"></span><span>Happy</span>
            </button>
            <button class="mood-btn" data-mood="neutral" data-label="Neutral">
              <span class="mood-emoji"></span><span>Neutral</span>
            </button>
            <button class="mood-btn" data-mood="tired" data-label="Tired">
              <span class="mood-emoji"></span><span>Tired</span>
            </button>
            <button class="mood-btn" data-mood="stressed" data-label="Stressed">
              <span class="mood-emoji"></span><span>Stressed</span>
            </button>
          </div>
        </div>

        <!-- Journal Section -->
        <div class="mb-4">
          <p class="text-sm font-medium text-gray-600 mb-2">What did you learn or accomplish?</p>
          <textarea id="reflection-input" class="reflection-textarea" placeholder="Write your thoughts here... "></textarea>
        </div>

        <div class="flex gap-2 justify-end">
          <button id="reflection-skip-btn" class="px-4 py-2 rounded-lg text-sm text-gray-500 hover:bg-gray-100 transition border border-gray-200">Skip</button>
          <button id="reflection-save-btn" class="px-4 py-2 rounded-lg text-sm bg-primary text-white font-semibold hover:opacity-80 transition" disabled>Save Reflection</button>
        </div>
        
        <div id="reflection-entries" class="mt-4 max-h-32 overflow-y-auto"></div>
      </div>
    </div>

    <!-- To-Do Modal -->
    <div id="todo-modal" class="todo-modal" role="dialog" aria-modal="true" aria-labelledby="todo-modal-title">
      <div class="modal-content glass">
        <div class="flex justify-between items-center mb-4">
          <h3 id="todo-modal-title" class="text-lg font-bold text-primary"> Session Tasks</h3>
          <button id="close-todo" class="text-gray-400 hover:text-primary" aria-label="Close tasks"></button>
        </div>
        <p class="text-sm text-gray-500 mb-3">What do you want to accomplish this session?</p>
        <div id="todo-list"></div>
        <div class="todo-add-row">
          <input type="text" id="todo-input" class="todo-input" placeholder="Add a task..." maxlength="80" />
          <button id="todo-add-btn" class="todo-add-btn">+ Add</button>
        </div>
        <div class="flex justify-end mt-4">
          <button id="todo-close-btn" class="px-4 py-2 rounded-lg text-sm bg-primary text-white font-semibold hover:opacity-80 transition">Done</button>
        </div>
      </div>
    </div>

    <div
      id="analytics-modal"
      class="analytics-modal"
      role="dialog"
      aria-labelledby="analytics-title"
      aria-modal="true"
    >
      <div class="analytics-content glass">
        <div class="flex justify-between items-center mb-6">
          <h2 id="analytics-title" class="text-2xl font-bold text-primary">
            Study Analytics
          </h2>
          <button
            id="close-analytics"
            class="text-gray-500 hover:text-primary"
            aria-label="Close analytics modal"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="glass rounded-xl p-4">
            <h3 class="text-lg font-semibold text-primary mb-3">
              Weekly Progress
            </h3>
            <div class="space-y-2" id="weekly-stats">
            </div>
          </div>

          <div class="glass rounded-xl p-4">
            <h3 class="text-lg font-semibold text-primary mb-3">
              Productivity Insights
            </h3>
            <div id="productivity-insights">
            </div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 mb-6">
          <h3 class="text-lg font-semibold text-primary mb-3">Mood History</h3>
          <div id="mood-history-chart" class="flex gap-2 flex-wrap"></div>
        </div>

        <div class="glass rounded-xl p-4 mb-6">
          <h3 class="text-lg font-semibold text-primary mb-3">Journal Entries</h3>
          <div id="journal-history" class="max-h-48 overflow-y-auto"></div>
        </div>

        <div class="glass rounded-xl p-4">
          <h3 class="text-lg font-semibold text-primary mb-3">
            Achievement Progress
          </h3>
          <div
            class="grid grid-cols-2 md:grid-cols-3 gap-4"
            id="detailed-achievements"
          >
          </div>
        </div>
      </div>
    </div>

    <div
      id="splash-screen"
      class="theme-arona"
      aria-label="Loading application"
      aria-live="polite"
    >
      <div class="splash-logo" id="splash-logo">Arona Blue Archive</div>
      <div class="splash-loader" aria-hidden="true"></div>
      <p class="text-gray-400 mt-4">Loading your study companion...</p>
    </div>

    <main
      id="main-content"
      class="min-h-screen flex flex-col items-center justify-center p-6 theme-transition page-transition"
    >
      <header class="text-center mb-8">
        <h1
          class="text-3xl md:text-4xl font-bold text-primary mb-2 fade-text"
          id="app-title"
        >
          Arona Study Companion
        </h1>
        <p class="text-gray-400 fade-text">
          Your anime study partner for better focus
        </p>
      </header>

      <div
        class="flex flex-col lg:flex-row items-center justify-center gap-8 w-full max-w-6xl main-content"
      >
        <section
          aria-labelledby="character-section-title"
          class="flex flex-col items-center"
        >
          <h2 id="character-section-title" class="sr-only">
            Study Companion Character
          </h2>
          <div class="relative">
            <div class="character-glow" aria-hidden="true"></div>
            <div
              class="relative glass glow-box rounded-3xl p-6 float character-transform"
              id="character-container"
              role="button"
              tabindex="0"
              aria-label="Interact with character. Drag left or right to change outfit."
              aria-live="polite"
            >
              <div
                class="character-interaction"
                id="character-bubble"
                aria-live="polite"
              ></div>
              <img
                src="assets/images/arona.png"
                alt="Arona study companion character"
                class="w-80 h-96 object-contain rounded-2xl"
                id="character-image"
                loading="eager"
              />
            </div>
          </div>

          <section
            aria-labelledby="timer-title"
            class="glass rounded-2xl p-6 mt-6 glow-box w-full max-w-md"
          >
            <div class="flex justify-between items-center mb-4">
              <h3 id="timer-title" class="text-xl font-bold text-primary">
                Focus Session
              </h3>
              <div class="flex items-center gap-2">
                <span id="streak-display" class="streak-badge" title="Study streak">
    <span class="streak-fire" id="streak-emoji"></span>
    <span id="streak-number">0</span> days
</span>
                <span
                  class="session-counter"
                  id="current-cycle"
                  aria-label="Current session 1 of 6"
                >1/6</span
              >
              </div>
            </div>

            <div
              class="flex justify-center gap-2 mb-4"
              id="session-progress"
              aria-label="Session progress"
            >
            </div>

            <!-- Tombol durasi dengan grid -->
            <div class="grid grid-cols-3 gap-2 mb-4 timer-controls" role="group" aria-label="Timer duration options">
              <button class="px-4 py-2 bg-primary-opacity rounded-lg hover:bg-opacity-30 transition" data-time="25" aria-pressed="true">
                25 min
              </button>
              <button class="px-4 py-2 bg-primary-opacity rounded-lg hover:bg-opacity-30 transition" data-time="45" aria-pressed="false">
                45 min
              </button>
              <button class="px-4 py-2 bg-primary-opacity rounded-lg hover:bg-opacity-30 transition" data-time="60" aria-pressed="false">
                60 min
              </button>
            </div>

            <div class="text-center">
              <div
                class="text-4xl font-mono font-bold text-primary mb-2 timer-display"
                id="timer-display"
                aria-live="polite"
                aria-atomic="true"
              >
                25:00
              </div>
              
              <!-- Tombol kontrol dengan ukuran yang lebih baik -->
              <div class="flex justify-center gap-2 timer-controls" role="group" aria-label="Timer controls">
                <button class="px-4 py-2 bg-primary-opacity rounded-lg hover:bg-opacity-30 transition text-sm font-semibold" id="todo-btn" aria-label="Open task list">
                   Tasks
                </button>
                <button class="px-6 py-2 bg-primary rounded-lg hover:bg-opacity-80 transition text-white font-semibold" id="start-timer" aria-label="Start timer">
                  Start
                </button>
                <button class="px-6 py-2 bg-gray-600 rounded-lg hover:bg-gray-500 transition text-white font-semibold" id="reset-timer" aria-label="Reset timer">
                  Reset
                </button>
              </div>
            </div>

            <section
              aria-labelledby="progress-title"
              class="glass rounded-xl p-4 mt-4"
            >
              <div class="flex justify-between items-center mb-2">
                <h4 id="progress-title" class="text-primary font-semibold">
                  Today's Progress
                </h4>
                <button
                  id="analytics-btn"
                  class="text-xs text-primary hover:underline"
                  aria-label="View detailed analytics"
                >
                  View Analytics
                </button>
              </div>
              <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span
                  >Completed:
                  <span id="completed-sessions" aria-live="polite">0</span>
                  sessions</span
                >
                <span
                  >Time:
                  <span id="total-study-time" aria-live="polite">0</span>
                  min</span
                >
              </div>
              
              <!-- Daily Progress Bar (menggantikan 8 session circles) -->
              <div id="daily-progress-container" class="daily-progress-container">
                <div class="daily-progress-bar">
                  <div id="daily-progress-fill" class="daily-progress-fill" style="width: 0%"></div>
                </div>
                <div id="daily-progress-text" class="daily-progress-text">0/8 sessions completed</div>
              </div>

              <!-- STREAK CALENDAR - TAMBAHAN BARU -->
              <div class="mt-4 pt-3 border-t border-white/20">
                <div class="flex justify-between items-center mb-2">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold"> Streak Tracker</span>
                    <span class="text-xs bg-primary/20 px-2 py-1 rounded-full" id="best-streak">
                      Best: 0
                    </span>
                  </div>
                  <span class="text-xs text-primary" id="streak-message"></span>
                </div>
                
                <!-- Streak Calendar 7 hari -->
                <div id="streak-calendar" class="flex justify-between gap-1 mt-2">
                  <!-- Akan diisi JavaScript -->
                </div>
                
                <!-- Progress ke achievement berikutnya -->
                <div class="mt-2 text-xs text-gray-500 text-center" id="next-streak-goal">
                   Next: 7 days streak
                </div>
              </div>
            </section>

            <section
              aria-labelledby="achievements-title"
              class="glass rounded-xl p-4 mt-4"
            >
              <div class="flex justify-between items-center mb-2">
                <h4 id="achievements-title" class="text-primary font-semibold">
                  Achievements
                </h4>
                <span
                  class="text-xs text-gray-500"
                  id="achievement-progress"
                  aria-live="polite"
                  >0/7</span
                >
              </div>
              <div
                class="flex gap-2 justify-center flex-wrap"
                id="achievements-container"
                role="list"
                aria-label="Achievements list"
              >
              </div>
            </section>

            <section class="glass rounded-xl p-4 mt-4">
              <div class="flex justify-between items-center mb-2">
                <h4 class="text-primary font-semibold">Session Tasks</h4>
                <button id="open-todo-btn" class="text-xs text-primary hover:underline">Manage</button>
              </div>
              <div id="todo-mini" class="text-sm text-gray-500">No tasks yet. Add tasks to stay focused!</div>
            </section>
          </section>
        </section>

        <section
          aria-labelledby="music-player-title"
          class="glass rounded-3xl p-8 glow-box w-full max-w-md"
        >
          <h2 id="music-player-title" class="sr-only">Music Player</h2>

          <div class="text-center mb-8" aria-live="polite">
            <h3 class="text-2xl font-bold text-primary mb-2">Now Playing</h3>
            <p class="text-gray-300" id="current-track-display">Lo-fi Study Beats</p>
            <p class="text-gray-400 text-sm" id="current-artist">
              Chill Anime Mix
            </p>
          </div>

          <div class="mb-6">
            <div
              class="progress-bar"
              role="progressbar"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-label="Music progress"
              tabindex="0"
            >
              <div
                class="progress-fill"
                id="progress-fill"
                style="width: 0%"
              ></div>
            </div>
            <div class="flex justify-between text-xs text-gray-400 mt-2">
              <span id="current-time" aria-live="polite">0:00</span>
              <span id="total-time">0:00</span>
            </div>
          </div>

          <div
            class="flex justify-center items-end h-16 gap-1 mb-8"
            aria-hidden="true"
          >
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0s; height: 40%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.1s; height: 60%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.2s; height: 80%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.3s; height: 100%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.4s; height: 70%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.5s; height: 50%"
            ></div>
            <div
              class="w-2 visualizer-bar rounded-t"
              style="animation-delay: 0.6s; height: 30%"
            ></div>
          </div>

          <div
            class="flex justify-center items-center gap-6 mb-6 music-controls"
            role="group"
            aria-label="Music controls"
          >
            <button
              class="p-3 text-gray-400 hover:text-primary transition"
              id="prev-btn"
              aria-label="Previous track"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
            </button>

            <button
              class="p-4 bg-primary rounded-full hover:bg-opacity-80 transition"
              id="play-pause-btn"
              aria-label="Play music"
              aria-pressed="false"
            >
              <svg
                class="w-8 h-8 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                id="play-icon"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <svg
                class="w-8 h-8 text-white hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                id="pause-icon"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </button>

            <button
              class="p-3 text-gray-400 hover:text-primary transition"
              id="next-btn"
              aria-label="Next track"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>
          </div>

          <div class="mb-6">
            <div class="flex items-center gap-3">
              <svg
                class="w-5 h-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m-2.828-9.9a9 9 0 012.728-2.728"
                />
              </svg>
              <input
                type="range"
                min="0"
                max="100"
                value="70"
                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                id="volume-slider"
                aria-label="Volume control"
              />
            </div>
          </div>

          <div class="max-h-48 overflow-y-auto playlist-container">
            <h3 class="text-lg font-semibold text-primary mb-3">
              Study Playlist
            </h3>
            <div class="space-y-2" role="listbox" aria-label="Music playlist">
              <div
                class="flex items-center gap-3 p-2 rounded-lg bg-primary-opacity cursor-pointer"
                data-track="0"
                role="option"
                aria-selected="true"
              >
                <div class="playlist-number playlist-active">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-medium">Lo-fi Study Beats</p>
                  <p class="text-xs text-gray-400">Chill Anime Mix</p>
                </div>
                <span class="text-xs text-gray-400">01:00:29</span>
              </div>

              <div
                class="flex items-center gap-3 p-2 rounded-lg hover:bg-primary-opacity cursor-pointer"
                data-track="1"
                role="option"
                aria-selected="false"
              >
                <div class="playlist-number playlist-inactive">2</div>
                <div class="flex-1">
                  <p class="text-sm font-medium">Rainy Night Coding</p>
                  <p class="text-xs text-gray-400">Jazz Hop</p>
                </div>
                <span class="text-xs text-gray-400">01:02:14</span>
              </div>

              <div
                class="flex items-center gap-3 p-2 rounded-lg hover:bg-primary-opacity cursor-pointer"
                data-track="2"
                role="option"
                aria-selected="false"
              >
                <div class="playlist-number playlist-inactive">3</div>
                <div class="flex-1">
                  <p class="text-sm font-medium">Coffee Shop Vibes</p>
                  <p class="text-xs text-gray-400">Acoustic Lo-fi</p>
                </div>
                <span class="text-xs text-gray-400">00:32:22</span>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="site-footer theme-transition">
      <div class="footer-content">
        <div class="footer-brand">
          <h3>Study Companion</h3>
          <p>Your anime partner for better focus & productivity</p>
        </div>

        <div class="donation-section">
          <div class="donation-title">
            <span class="heart"></span>
            <span>Support CryvaStudio</span>
            <span class="heart"></span>
          </div>

          <div class="donation-links">
            <a
              href="https://paypal.me/ArvinFarrelP"
              target="_blank"
              rel="noopener noreferrer"
              class="donation-btn"
              aria-label="Support CryvaStudio on PayPal"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M20.067 8.478c.492.88.556 2.014.3 3.327-.74 3.806-3.276 5.12-6.514 5.12h-.5a.805.805 0 0 0-.794.68l-.04.22-.63 3.993-.032.17a.804.804 0 0 1-.794.68h-2.66c-.66 0-1.204-.578-1.12-1.237l1.12-7.16a.98.98 0 0 1 .974-.882h.722c4.306 0 7.128-1.177 8.11-5.049zM8.768 20.06H5.56a.84.84 0 0 1-.833-.945l1.323-8.382a.65.65 0 0 1 .643-.56h3.9c2.82 0 5.03-1.528 5.804-4.858.36-1.552.174-2.625-.468-3.358a1.503 1.503 0 0 0-1.226-.453H6.448a1.15 1.15 0 0 0-1.148 1.053l-2.268 14.363a.9.9 0 0 0 .892 1.038h3.83a.96.96 0 0 0 .95-.827l.025-.14.48-3.043.03-.16a.96.96 0 0 1 .949-.827h.58c3.524 0 5.95-1.842 6.544-5.403.202-1.238.01-2.322-.573-3.153l.932.372c-.456.864-.624 1.934-.386 3.267.744 3.823 3.276 5.12 6.514 5.12h.5a.805.805 0 0 1 .794.68l.04.22.63 3.993.032.17a.804.804 0 0 0 .794.68h2.66c.66 0 1.204-.578 1.12-1.237l-1.12-7.16a.98.98 0 0 0-.974-.882h-.722c-4.306 0-7.128-1.177-8.11-5.049z"
                />
              </svg>
              PayPal
            </a>

            <a
              href="https://saweria.co/CryvaStudio"
              target="_blank"
              rel="noopener noreferrer"
              class="donation-btn"
              aria-label="Support CryvaStudio on Saweria"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"
                />
              </svg>
              Saweria
            </a>
          </div>
        </div>

        <div class="footer-bottom">
          <p> 2025 CryvaStudio. Made with  for productive minds.</p>
        </div>
      </div>
    </footer>

    <audio id="audio-player" aria-label="Background music player">
    </audio>

    <script>
    // ============================================================
    // UTILITY: Consistent localStorage wrapper
    // ============================================================
    function safeSave(key, data) {
      try { localStorage.setItem(key, JSON.stringify(data)); return true; }
      catch (e) { console.error("LocalStorage error:", e); showNotification("Storage Error", "Failed to save progress"); return false; }
    }
    function safeLoad(key, fallback = null) {
      try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : fallback; }
      catch (e) { console.error("LocalStorage read error:", e); return fallback; }
    }

    // ============================================================
    // STATE
    // ============================================================
    let currentMode = "arona";
    let progress = {
      completedSessions: 0,
      totalStudyTime: 0,
      lastSession: null,
      dailySessions: Array(8).fill(false),
      studyHistory: [],
      streak: 0,
      bestStreak: 0, // Tambahan untuk best streak
      lastStudyDate: null
    };
    let hasUnsavedChanges = false;
    const offlineQueue = [];
    const studyMetrics = {
      focusSessions: [],
      breaks: [],
      productivityPatterns: [],
      weeklyReports: [],
      reflections: [] // Gabungan mood + journal
    };
    let pendingShareId = null;

    // To-Do state
    let todoItems = [];

    // ============================================================
    // ERROR HANDLING
    // ============================================================
    window.addEventListener("error", (e) => {
      console.error("Global error:", e.error);
      try { safeSave(`${currentMode}Progress`, progress); } catch(x) {}
    });
    window.addEventListener("unhandledrejection", (e) => { console.error("Unhandled rejection:", e.reason); e.preventDefault(); });

    // ============================================================
    // STREAK SYSTEM - ENHANCED VERSION
    // ============================================================
    function updateStreak() {
      const today = new Date().toDateString();
      const last = progress.lastStudyDate;
      
      // Simpan ke study history
      if (!progress.studyHistory) progress.studyHistory = [];
      if (!progress.studyHistory.includes(today)) {
          progress.studyHistory.push(today);
          // Keep only last 30 days
          if (progress.studyHistory.length > 30) progress.studyHistory.shift();
      }
      
      if (!last) { 
        progress.streak = 1; 
      }
      else if (last === today) { 
        /* same day, no change */ 
      }
      else {
        const yesterday = new Date(); 
        yesterday.setDate(yesterday.getDate() - 1);
        if (last === yesterday.toDateString()) { 
          progress.streak = (progress.streak || 0) + 1; 
        }
        else { 
          progress.streak = 1; 
        }
      }
      
      // Update best streak
      if (progress.streak > (progress.bestStreak || 0)) {
          progress.bestStreak = progress.streak;
      }
      
      progress.lastStudyDate = today;
      updateStreakDisplayEnhanced();
    }

    // Motivational messages berdasarkan streak
    function getStreakMessage(streak) {
      if (streak === 0) return "Start your streak today! ";
      if (streak === 1) return "Day 1! Keep it going tomorrow! ";
      if (streak === 2) return "Day 2  Nice! Keep the momentum! ";
      if (streak === 3) return "3 days in a row! Amazing! ";
      if (streak === 4) return "Day 4  You're doing great! ";
      if (streak === 5) return "5 days! Almost a full week! ";
      if (streak === 6) return "One more day to a full week! ";
      if (streak === 7) return " CONGRATS! 7-day streak! ";
      if (streak < 14) return `${streak} days streak! Incredible! `;
      if (streak < 21) return `${streak} days! You're unstoppable! `;
      if (streak < 30) return `${streak} days! Almost a month! `;
      return ` LEGEND! ${streak} days in a row! `;
    }

    // Streak Calendar dengan visual yang lebih menarik
    function renderStreakCalendar() {
        const calendarEl = document.getElementById('streak-calendar');
        if (!calendarEl) return;
        
        const today = new Date();
        const hariIndo = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        let html = '';
        
        // Tampilkan 7 hari terakhir
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toDateString();
            
            // Cek apakah tanggal ini pernah belajar
            const studied = progress.studyHistory ? 
                progress.studyHistory.includes(dateStr) : 
                (progress.lastStudyDate === dateStr);
            
            // Di bagian renderStreakCalendar, ganti logic warna jadi:
            let bgColor, textColor, borderStyle, opacity = '';
            if (studied) {
                bgColor = 'bg-primary';
                textColor = 'text-white';
                opacity = 'opacity-100';
            } else if (dateStr === today.toDateString()) {
                bgColor = 'bg-transparent';
                textColor = 'text-primary';
                borderStyle = 'border-2 border-primary';
                opacity = 'opacity-100';
            } else {
                bgColor = 'bg-white/20'; // Putih transparan
                textColor = 'text-gray-300';
                borderStyle = 'backdrop-blur-sm border border-white/10';
                opacity = 'opacity-60';
            }
            
            html += `
                <div class="flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold
                              ${bgColor} ${textColor} ${borderStyle} transition-all duration-300
                              hover:scale-110 cursor-pointer"
                         title="${hariIndo[date.getDay()]}, ${date.getDate()} ${date.toLocaleString('default', { month: 'short' })}">
                        ${date.getDate()}
                    </div>
                    <span class="text-[10px] mt-1 text-gray-400">${hariIndo[date.getDay()]}</span>
                </div>
            `;
        }
        
        calendarEl.innerHTML = html;
    }

    // Update best streak display
    function updateBestStreak() {
        const bestEl = document.getElementById('best-streak');
        if (bestEl) {
            bestEl.textContent = `Best: ${progress.bestStreak || 0}`;
        }
    }

    // Update next goal
    function updateNextGoal() {
        const streak = progress.streak || 0;
        let nextGoal = 7; // default
        
        if (streak < 3) nextGoal = 3;
        else if (streak < 7) nextGoal = 7;
        else if (streak < 14) nextGoal = 14;
        else if (streak < 21) nextGoal = 21;
        else if (streak < 30) nextGoal = 30;
        else nextGoal = streak + 7;
        
        const remaining = nextGoal - streak;
        const goalEl = document.getElementById('next-streak-goal');
        if (goalEl) {
            if (remaining > 0) {
                goalEl.innerHTML = ` ${remaining} days left to reach a ${nextGoal}-day streak!`;
            } else {
                goalEl.innerHTML = ` Congratulations! ${streak}-day streak achieved! `;
            }
        }
    }

    // Enhanced streak display function
function updateStreakDisplayEnhanced() {
    const el = document.getElementById("streak-display");
    if (!el) return;
    
    const s = progress.streak || 0;
    
    // Update angka streak
    document.getElementById('streak-number').textContent = s;
    
    // Update emoji dan warna
    const fireEl = document.getElementById('streak-emoji');
    if (s >= 30) {
        fireEl.textContent = '';
        fireEl.dataset.streak = '14+';
    } else if (s >= 14) {
        fireEl.textContent = '';
        fireEl.dataset.streak = '14+';
    } else if (s >= 7) {
        fireEl.textContent = '';
        fireEl.dataset.streak = '7-13';
    } else if (s >= 4) {
        fireEl.textContent = '';
        fireEl.dataset.streak = '4-6';
    } else if (s >= 1) {
        fireEl.textContent = '';
        fireEl.dataset.streak = '1-3';
    } else {
        fireEl.textContent = '';
        fireEl.dataset.streak = '1-3';
    }
    
    el.title = getStreakMessage(s);
    
    // Update komponen lain
    document.getElementById('streak-message').textContent = getStreakMessage(s);
    renderStreakCalendar();
    updateBestStreak();
    updateNextGoal();
}

    // ============================================================
    // SESSION REFLECTION (Mood + Journal)
    // ============================================================
    let selectedReflectionMood = null;

    function showReflectionModal() {
      const modal = document.getElementById("session-reflection-modal");
      selectedReflectionMood = null;
      document.querySelectorAll("#reflection-mood-buttons .mood-btn").forEach(b => b.classList.remove("selected"));
      document.getElementById("reflection-save-btn").disabled = true;
      document.getElementById("reflection-input").value = "";
      modal.classList.add("show");
      renderReflectionEntries();
    }

    function hideReflectionModal() { 
      document.getElementById("session-reflection-modal").classList.remove("show"); 
    }

    // Mood button listeners
    document.querySelectorAll("#reflection-mood-buttons .mood-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("#reflection-mood-buttons .mood-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedReflectionMood = btn.dataset.mood;
        checkReflectionSaveButton();
      });
    });

    // Journal input listener
    document.getElementById("reflection-input").addEventListener("input", checkReflectionSaveButton);

    function checkReflectionSaveButton() {
      const hasMood = selectedReflectionMood !== null;
      const hasText = document.getElementById("reflection-input").value.trim().length > 0;
      document.getElementById("reflection-save-btn").disabled = !(hasMood || hasText);
    }

    function renderReflectionEntries() {
      const container = document.getElementById("reflection-entries");
      if (!container) return;
      const recent = studyMetrics.reflections.slice(-3).reverse();
      if (recent.length === 0) { 
        container.innerHTML = '<p class="text-xs text-gray-400 text-center mt-2">No reflections yet.</p>'; 
        return; 
      }
      const moodEmoji = { energized: "", happy: "", neutral: "", tired: "", stressed: "" };
      container.innerHTML = recent.map(e => {
        const d = new Date(e.date);
        const dateStr = d.toLocaleDateString("id-ID", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" });
        const moodDisplay = e.mood ? `${moodEmoji[e.mood] || ""} ` : "";
        return `<div class="reflection-entry"><div class="text-xs text-gray-400 mb-1">${dateStr}</div><p class="text-sm">${moodDisplay}${e.text || "Mood recorded"}</p></div>`;
      }).join("");
    }

    document.getElementById("reflection-save-btn").addEventListener("click", () => {
      const text = document.getElementById("reflection-input").value.trim();
      
      // Create reflection entry
      const entry = { 
        date: new Date().toISOString(), 
        sessions: progress.completedSessions,
        mood: selectedReflectionMood || null,
        text: text || null
      };
      
      studyMetrics.reflections.push(entry);
      saveStudyMetrics();
      
      // Show appropriate message
      if (text && selectedReflectionMood) {
        showNotification("Reflection Saved ", "Your mood and notes have been recorded!", "success");
      } else if (selectedReflectionMood) {
        showNotification("Mood Logged", "Your mood has been recorded!", "info");
      } else if (text) {
        showNotification("Journal Saved", "Your notes have been saved!", "success");
      }
      
      hideReflectionModal();
    });

    document.getElementById("reflection-skip-btn").addEventListener("click", hideReflectionModal);
    document.getElementById("close-reflection").addEventListener("click", hideReflectionModal);
    document.getElementById("session-reflection-modal").addEventListener("click", (e) => { 
      if (e.target.id === "session-reflection-modal") hideReflectionModal(); 
    });

    // ============================================================
    // DAILY PROGRESS BAR (Replacement for 8 session circles)
    // ============================================================
    function updateDailyProgressBar() {
      const fill = document.getElementById("daily-progress-fill");
      const text = document.getElementById("daily-progress-text");
      if (!fill || !text) return;
      
      const completed = progress.dailySessions.filter(s => s).length;
      const percent = (completed / 8) * 100;
      
      fill.style.width = `${percent}%`;
      text.textContent = `${completed}/8 sessions completed today`;
    }

    // ============================================================
    // TO-DO LIST
    // ============================================================
    function loadTodos() {
      todoItems = safeLoad("todoItems", []);
    }

    function saveTodos() {
      safeSave("todoItems", todoItems);
      renderTodoMini();
    }

    function renderTodoList() {
      const container = document.getElementById("todo-list");
      if (!container) return;
      if (todoItems.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">No tasks yet. Add one above!</p>';
        return;
      }
      container.innerHTML = todoItems.map((item, i) => `
        <div class="todo-item ${item.done ? "completed" : ""}" data-idx="${i}">
          <button class="todo-checkbox ${item.done ? "checked" : ""}" onclick="toggleTodo(${i})" aria-label="${item.done ? "Uncheck" : "Check"} task">
            ${item.done ? "" : ""}
          </button>
          <span class="todo-text">${escapeHtml(item.text)}</span>
          <button class="todo-delete" onclick="deleteTodo(${i})" aria-label="Delete task"></button>
        </div>
      `).join("");
    }

    function renderTodoMini() {
      const mini = document.getElementById("todo-mini");
      if (!mini) return;
      if (todoItems.length === 0) { mini.textContent = "No tasks yet. Add tasks to stay focused!"; return; }
      const done = todoItems.filter(t => t.done).length;
      mini.innerHTML = `<span class="font-semibold text-primary">${done}/${todoItems.length}</span> tasks completed`;
    }

    window.toggleTodo = function(index) {
      todoItems[index].done = !todoItems[index].done;
      saveTodos();
      renderTodoList();
      if (todoItems[index].done) triggerCharacterReaction("session_complete");
    };

    window.deleteTodo = function(index) {
      todoItems.splice(index, 1);
      saveTodos();
      renderTodoList();
    };

    function escapeHtml(text) {
      const d = document.createElement("div");
      d.textContent = text;
      return d.innerHTML;
    }

    function showTodoModal() {
      document.getElementById("todo-modal").classList.add("show");
      renderTodoList();
    }

    function hideTodoModal() {
      document.getElementById("todo-modal").classList.remove("show");
      renderTodoMini();
    }

    document.getElementById("todo-add-btn")?.addEventListener("click", addTodoItem);
    document.getElementById("todo-input")?.addEventListener("keydown", (e) => { if (e.key === "Enter") addTodoItem(); });

    function addTodoItem() {
      const input = document.getElementById("todo-input");
      const text = input.value.trim();
      if (!text) return;
      todoItems.push({ text, done: false, created: new Date().toISOString() });
      saveTodos();
      renderTodoList();
      input.value = "";
      input.focus();
    }

    document.getElementById("todo-close-btn")?.addEventListener("click", hideTodoModal);
    document.getElementById("close-todo")?.addEventListener("click", hideTodoModal);
    document.getElementById("todo-modal")?.addEventListener("click", (e) => { if (e.target.id === "todo-modal") hideTodoModal(); });
    document.getElementById("todo-btn")?.addEventListener("click", showTodoModal);
    document.getElementById("open-todo-btn")?.addEventListener("click", showTodoModal);

    // ============================================================
    // SHARE MODAL
    // ============================================================
    function showShareModal(achievementId) {
      const achievement = achievements[achievementId];
      if (!achievement) return;
      pendingShareId = achievementId;
      document.getElementById("share-modal-desc").textContent = `${achievement.name}: ${achievement.description}`;
      document.getElementById("share-modal").classList.add("show");
    }

    function hideShareModal() {
      document.getElementById("share-modal").classList.remove("show");
      pendingShareId = null;
    }

    document.getElementById("share-native-btn")?.addEventListener("click", () => {
      if (pendingShareId) { doShare(pendingShareId); hideShareModal(); }
    });

    document.getElementById("share-copy-btn")?.addEventListener("click", () => {
      if (pendingShareId) {
        const a = achievements[pendingShareId];
        const text = `I just unlocked "${a.name}" on Study Companion!  ${a.description}`;
        fallbackShare(text);
        hideShareModal();
      }
    });

    document.getElementById("share-cancel-btn")?.addEventListener("click", hideShareModal);
    document.getElementById("share-modal")?.addEventListener("click", (e) => { if (e.target.id === "share-modal") hideShareModal(); });

    function doShare(achievementId) {
      const a = achievements[achievementId];
      const text = `I just unlocked "${a.name}" on Study Companion!  ${a.description}`;
      if (navigator.share) {
        navigator.share({ title: "Study Achievement Unlocked!", text, url: window.location.href }).catch(() => fallbackShare(text));
      } else { fallbackShare(text); }
    }

    function fallbackShare(text) {
      navigator.clipboard.writeText(text).then(() => {
        showNotification("Copied!", "Achievement text copied to clipboard", "success");
      }).catch(() => {
        const ta = document.createElement("textarea");
        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
        showNotification("Copied!", "Achievement text copied to clipboard", "success");
      });
    }

    // ============================================================
    // ANALYTICS
    // ============================================================
    function showAnalytics() {
      document.getElementById("analytics-modal").classList.add("show");
      updateWeeklyStats();
      updateProductivityInsights();
      updateDetailedAchievements();
      renderMoodHistory();
      renderJournalHistory();
    }

    function renderMoodHistory() {
      const container = document.getElementById("mood-history-chart");
      if (!container) return;
      
      // Extract moods from reflections
      const moods = studyMetrics.reflections.filter(r => r.mood).map(r => ({ mood: r.mood, date: r.date }));
      
      if (moods.length === 0) { 
        container.innerHTML = '<p class="text-sm text-gray-400">No mood data yet. Reflect after sessions!</p>'; 
        return; 
      }
      const moodEmoji = { energized: "", happy: "", neutral: "", tired: "", stressed: "" };
      const recent = moods.slice(-14);
      container.innerHTML = recent.map(e => {
        const d = new Date(e.date);
        return `<div class="text-center" title="${e.mood} - ${d.toLocaleDateString()}">
          <div style="font-size:1.5rem">${moodEmoji[e.mood] || ""}</div>
          <div style="font-size:0.6rem;opacity:0.6">${d.getDate()}/${d.getMonth()+1}</div>
        </div>`;
      }).join("");
    }

    function renderJournalHistory() {
      const container = document.getElementById("journal-history");
      if (!container) return;
      
      // Extract journal entries from reflections (only those with text)
      const journals = studyMetrics.reflections.filter(r => r.text).map(r => ({ text: r.text, date: r.date }));
      
      if (journals.length === 0) { 
        container.innerHTML = '<p class="text-sm text-gray-400">No journal entries yet.</p>'; 
        return; 
      }
      container.innerHTML = journals.slice(-5).reverse().map(e => {
        const d = new Date(e.date);
        const ds = d.toLocaleDateString("id-ID", { day: "numeric", month: "short", year: "numeric" });
        return `<div class="reflection-entry"><div class="text-xs text-gray-400 mb-1">${ds}</div><p class="text-sm">${e.text}</p></div>`;
      }).join("");
    }

    function updateWeeklyStats() {
      const el = document.getElementById("weekly-stats");
      if (!el) return;
      const d = getWeeklyData();
      el.innerHTML = `
        <div class="flex justify-between"><span>Sessions Completed:</span><span class="font-semibold">${d.sessions}</span></div>
        <div class="flex justify-between"><span>Total Study Time:</span><span class="font-semibold">${Math.floor(d.totalTime/60)}h ${d.totalTime%60}m</span></div>
        <div class="flex justify-between"><span>Average Session:</span><span class="font-semibold">${d.sessions>0?Math.floor(d.totalTime/d.sessions):0}m</span></div>
        <div class="flex justify-between"><span>Productivity Score:</span><span class="font-semibold">${calculateProductivityScore()}%</span></div>
        <div class="flex justify-between"><span>Current Streak:</span><span class="font-semibold"> ${progress.streak||0} days</span></div>
        <div class="flex justify-between"><span>Best Streak:</span><span class="font-semibold"> ${progress.bestStreak||0} days</span></div>
      `;
    }

    function updateProductivityInsights() {
      const el = document.getElementById("productivity-insights");
      if (!el) return;
      const d = getWeeklyData();
      let text = "";
      if (d.sessions === 0) text = "Start your first session to unlock insights!";
      else if (d.sessions < 3) text = "Try to maintain consistency  aim for 3+ sessions per week!";
      else if (d.totalTime < 180) text = "Great consistency! Consider longer sessions for deeper focus.";
      else text = "Excellent productivity! You're building strong study habits!";
      el.innerHTML = `
        <p class="text-sm text-gray-600 mb-3">${text}</p>
        <div class="bg-primary-opacity rounded-lg p-3">
          <div class="flex justify-between text-sm mb-1"><span>Weekly Goal Progress</span><span>${Math.min(100,Math.floor((d.sessions/7)*100))}%</span></div>
          <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100,Math.floor((d.sessions/7)*100))}%"></div></div>
        </div>
      `;
    }

    function updateDetailedAchievements() {
      const container = document.getElementById("detailed-achievements");
      if (!container) return;
      container.innerHTML = "";
      Object.values(achievements).forEach(a => {
        const el = document.createElement("div");
        el.className = "glass rounded-lg p-3 text-center";
        let progressHtml = "";
        if (a.requirement && !a.unlocked) {
          let pv = 0;
          if (a.id === "focus_master") pv = Math.min(progress.completedSessions, a.requirement);
          else if (a.id === "marathon_runner") pv = Math.min(Math.floor(progress.totalStudyTime/60), a.requirement);
          else if (a.id === "consistency_king") pv = Math.min(progress.dailySessions.filter(s=>s).length, a.requirement);
          else if (a.id === "streak_3" || a.id === "streak_7") pv = Math.min(progress.streak||0, a.requirement);
          const pct = (pv / a.requirement) * 100;
          progressHtml = `<div class="progress-ring mt-2 mx-auto" style="--progress:${pct}%"><span>${pv}/${a.requirement}</span></div>`;
        }
        el.innerHTML = `
          <div class="text-2xl mb-2"><img src="${a.icon}" alt="${a.name}" class="w-12 h-12 mx-auto object-contain"></div>
          <h4 class="font-semibold text-sm mb-1">${a.name}</h4>
          <p class="text-xs text-gray-600 mb-2">${a.description}</p>
          ${a.unlocked ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Unlocked</span>' : progressHtml}
        `;
        container.appendChild(el);
      });
    }

    function getWeeklyData() {
      return { sessions: progress.completedSessions, totalTime: progress.totalStudyTime, averageSession: progress.completedSessions > 0 ? Math.floor(progress.totalStudyTime/progress.completedSessions) : 0 };
    }

    function calculateProductivityScore() {
      const d = getWeeklyData();
      return Math.floor((Math.min(100,(d.sessions/7)*100) + Math.min(100,(d.totalTime/420)*100)) / 2);
    }

    // ============================================================
    // ACHIEVEMENTS
    // ============================================================
    const achievements = {
      first_session: { id:"first_session", name:"First Steps", description:"Complete your first focus session", icon:"assets/images/achievements/first_steps.png", unlocked:false, rarity:"common" },
      focus_master: { id:"focus_master", name:"Focus Master", description:"Complete 10 focus sessions", icon:"assets/images/achievements/focus_master.png", unlocked:false, requirement:10, rarity:"rare" },
      marathon_runner: { id:"marathon_runner", name:"Marathon Runner", description:"Study for 60+ minutes total", icon:"assets/images/achievements/marathon_runner.png", unlocked:false, requirement:60, rarity:"common" },
      consistency_king: { id:"consistency_king", name:"Consistency King", description:"Complete 5 sessions in one day", icon:"assets/images/achievements/consistency_king.png", unlocked:false, requirement:5, rarity:"rare" },
      early_bird: { id:"early_bird", name:"Early Bird", description:"Start your first session before 8 AM", icon:"assets/images/achievements/early_bird.png", unlocked:false, rarity:"common" },
      streak_3: { id:"streak_3", name:"Hat-Trick", description:"Study 3 days in a row", icon:"assets/images/achievements/hat_trick.png", unlocked:false, requirement:3, rarity:"common" },
      streak_7: { id:"streak_7", name:"Week Warrior", description:"Study 7 days in a row", icon:"assets/images/achievements/week_warrior.png", unlocked:false, requirement:7, rarity:"rare" },
    };

    function checkAchievements() {
      const checks = {
        first_session: () => progress.completedSessions >= 1,
        focus_master: () => progress.completedSessions >= achievements.focus_master.requirement,
        marathon_runner: () => progress.totalStudyTime >= achievements.marathon_runner.requirement * 60,
        consistency_king: () => progress.dailySessions.filter(s=>s).length >= achievements.consistency_king.requirement,
        early_bird: () => { const now = new Date(); const today = progress.lastSession && new Date(progress.lastSession).toDateString() === now.toDateString(); return today && now.getHours() < 8; },
        streak_3: () => (progress.streak || 0) >= 3,
        streak_7: () => (progress.streak || 0) >= 7,
      };
      Object.keys(checks).forEach(id => {
        if (!achievements[id].unlocked && checks[id]()) unlockAchievement(id);
      });
    }

    function unlockAchievement(id) {
      if (!achievements[id] || achievements[id].unlocked) return;
      achievements[id].unlocked = true;
      const a = achievements[id];
      showNotification(a.rarity === "rare" ? "Rare Achievement! " : "Achievement Unlocked! ", `${a.name}: ${a.description}`, "success");
      if (a.rarity === "rare") {
        createConfettiEffect();
        setTimeout(() => showShareModal(id), 500);
      }
      triggerCharacterReaction("achievement");
      saveAchievements();
      updateAchievementsUI();
      hasUnsavedChanges = true;
    }

    function updateAchievementsUI() {
      const container = document.getElementById("achievements-container");
      const progressEl = document.getElementById("achievement-progress");
      if (!container || !progressEl) return;
      container.innerHTML = "";
      const unlocked = Object.values(achievements).filter(a => a.unlocked).length;
      progressEl.textContent = `${unlocked}/${Object.keys(achievements).length}`;
      Object.values(achievements).forEach(a => {
        const badge = document.createElement("div");
        badge.className = `achievement-badge ${a.unlocked?"achievement-unlocked":"achievement-locked"} ${a.rarity==="rare"?"achievement-rare":"achievement-common"} ${a.unlocked?"achievement unlocked":"achievement locked"}`;
        if (a.unlocked) {
          badge.style.setProperty("--primary-color", currentMode==="arona"?"#38bdf8": currentMode==="plana"?"#c084fc":"#a78bfa");
          badge.style.setProperty("--secondary-color", currentMode==="arona"?"#0ea5e9": currentMode==="plana"?"#a855f7":"#7c3aed");
          badge.addEventListener("click", () => showShareModal(a.id));
        } else {
          badge.addEventListener("click", () => showNotification(a.name, `${a.description}  keep going!`, "info"));
        }
        const icon = document.createElement("img");
        icon.className = "achievement-icon"; icon.src = a.icon; icon.alt = a.name; icon.loading = "lazy";
        icon.addEventListener("error", function() {
          const emojis = { first_session:"", focus_master:"", marathon_runner:"", consistency_king:"", early_bird:"", streak_3:"", streak_7:"" };
          this.replaceWith(document.createTextNode(emojis[a.id]||""));
        });
        const tooltip = document.createElement("div");
        tooltip.className = "achievement-tooltip";
        tooltip.innerHTML = `<strong>${a.name}</strong><br>${a.description}${a.rarity==="rare"?"<br> Rare":""}${a.unlocked?"<br><small>Click to share</small>":""}`;
        badge.appendChild(icon); badge.appendChild(tooltip);
        if (a.requirement && !a.unlocked) {
          let pv = 0;
          if (a.id==="focus_master") pv = Math.min(progress.completedSessions, a.requirement);
          else if (a.id==="marathon_runner") pv = Math.min(Math.floor(progress.totalStudyTime/60), a.requirement);
          else if (a.id==="consistency_king") pv = Math.min(progress.dailySessions.filter(s=>s).length, a.requirement);
          else if (a.id==="streak_3"||a.id==="streak_7") pv = Math.min(progress.streak||0, a.requirement);
          const pt = document.createElement("div");
          pt.className = "achievement-progress"; pt.textContent = `${pv}/${a.requirement}`;
          badge.appendChild(pt);
        }
        container.appendChild(badge);
      });
    }

// ============================================================
// CHARACTER INTERACTIONS
// ============================================================
const characterInteractions = {
  arona: {
    greeting: [
      "Sensei! Arona has been waiting! Let's study together! ",
      "Welcome back, Sensei! Arona is ready to help you today! ",
      "Ara~ Sensei is here! Ready to focus? ",
      "Hehe~ Sensei! Lets make today productive! "
    ],

    outfit_greeting: {
      default: [
        "Arona is in her usual outfit today! Lets do our best! ",
        "Simple outfit, but full of energy! ",
        "Arona is always ready to support you, Sensei! "
      ],
      maid: [
        "Ehehe~ Maid Arona reporting for duty! ",
        "Gokigenyou, Sensei~ Arona will take care of everything! ",
        "Arona is your special maid today! ",
        "Maid Arona will help you stay focused! ",
        "Do you like this outfit, Sensei? Arona feels extra cute! "
      ]
    },

    outfit_change: [
      "Ehehe~ A new outfit! Arona loves it! ",
      "Do you like this one, Sensei? ",
      "Arona feels extra motivated now! ",
      "Cute? Arona is always cute! But thank you! ",
      "New outfit! Arona looks even better now, right? "
    ],

    session_start: [
      "Focus time! Lets do our best, Sensei! ",
      "Arona will support you! Dont give up! ",
      "Time to focus! Arona believes in you! ",
      "Pomodoro session started! Ganbatte, Sensei! "
    ],

    session_complete: [
      "Yatta! Great work, Sensei! ",
      "Session complete! You did amazing! ",
      "Arona will reward you with virtual pyroxenes! ",
      "Mission complete! Amazing work! "
    ],

    achievement: [
      "Wow! Achievement unlocked! You're amazing! ",
      "Arona is so happy to see your progress! ",
      "Incredible! Your hard work paid off! ",
      "Congratulations, Sensei! "
    ],

    break_time: [
      "Break time! Dont forget to drink water! ",
      "Short break~ Arona will wait for you! ",
      "Recharge your energy! ",
      "Tea break! Arona will guard your progress! "
    ],
  },

  plana: {
    greeting: [
      "Welcome, Sensei... let us find peace in studying together... ",
      "Hello, Sensei... is today filled with hope? ",
      "It's quiet today... perfect for focus... ",
      "Ive been waiting... let us begin... "
    ],

    outfit_greeting: {
      default: [
        "This is all Plana has... but it is enough... ",
        "A simple outfit... for a quiet journey... ",
        "Plana feels at ease like this... do you feel the same? "
      ],
      maid: [
        "Plana... will serve as your maid today... ",
        "M-maid Plana... is this acceptable...? ",
        "Plana chose this... just for you... ",
        "Plana will stay by your side... ",
        "This outfit... feels unfamiliar... but warm... "
      ]
    },

    outfit_change: [
      "This outfit... is different... ",
      "Plana hopes... you like it... ",
      "It was chosen... with care... ",
      "If it pleases you... Plana is happy... "
    ],

    session_start: [
      "Every moment of focus shapes your future... ",
      "Let us begin this small journey... ",
      "Your concentration shines beautifully... ",
      "Let us walk this path of knowledge... "
    ],

    session_complete: [
      "Small steps... lead to great things... ",
      "Your dedication is inspiring... ",
      "Todays effort will bloom... ",
      "Another step forward... well done... "
    ],

    achievement: [
      "This reflects your growth... ",
      "Every achievement tells a story... ",
      "Walk forward with confidence... ",
      "Your efforts have blossomed... "
    ],

    break_time: [
      "Time to rest... the world can wait... ",
      "Rest is part of the journey... ",
      "Take a breath... let your mind be still... ",
      "Even stars must rest... "
    ],
  },

  hina: {
    greeting: [
      "Hina... will stay with you today... ",
      "Welcome back, Sensei... Hina is ready... ",
      "Hina... wants to study together... ",
      "It's quiet here... perfect for focusing... "
    ],

    outfit_greeting: {
      dress: [
        "Hina... is wearing a dress today... just for you... ",
        "This dress... Hina chose it carefully... ",
        "It makes Hina feel... a little more confident... ",
        "Sensei... does it look nice?... Hina is a bit nervous... "
      ],
      maid: [
        "Hina... will serve you today... as your maid... ",
        "M-maid Hina... will do her best... ",
        "Hina chose this... for you... ",
        "Hina will stay by your side... "
      ]
    },

    outfit_change: [
      "Hina... will change outfits now... please don't look... ",
      "Does this suit you...? Hina... isn't sure... ",
      "Hina chose this... just for you... ",
      "Hina likes it... but feels a little shy... "
    ],

    session_start: [
      "Focus session started... Hina will stay with you... ",
      "Lets begin... Hina is right here... ",
      "Time to focus... Hina believes in you... ",
      "Hina will help you concentrate... "
    ],

    session_complete: [
      "Good job... Hina is happy... ",
      "Session complete... you did well... ",
      "Hina is proud of you... ",
      "Well done... Hina will support you... "
    ],

    achievement: [
      "Sensei... is amazing... Hina feels happy... ",
      "A new achievement... incredible... ",
      "Hina is glad to see your growth... ",
      "Sensei... is getting stronger... "
    ],

    break_time: [
      "Time to rest... Hina will wait here... ",
      "Break time... dont forget water... ",
      "Take a short rest... relax... ",
      "Hina will guard your desk... "
    ],
  },
};

    function triggerCharacterReaction(type) {
      const bubble = document.getElementById("character-bubble");
      if (!bubble) return;
      
      const quotes = characterInteractions[currentMode];
      if (!quotes || !quotes[type]) return;
      
      let messagePool = [];
      
      // Untuk semua karakter, gabungkan dengan outfit-specific greeting jika type = "greeting"
      if (type === "greeting" && quotes.outfit_greeting) {
        // Ambil greeting biasa
        messagePool = [...quotes.greeting];
        
        // Tambahkan outfit-specific greeting berdasarkan currentOutfit
        let outfitKey;
        if (currentMode === "arona") {
          outfitKey = aronaOutfitKeys[currentOutfit] || "default";
        } else if (currentMode === "plana") {
          outfitKey = planaOutfitKeys[currentOutfit] || "default";
        } else if (currentMode === "hina") {
          outfitKey = hinaOutfitKeys[currentOutfit] || "dress";
        }
        
        if (quotes.outfit_greeting[outfitKey]) {
          messagePool = [...messagePool, ...quotes.outfit_greeting[outfitKey]];
        }
      } else {
        messagePool = quotes[type];
      }
      
      // Pilih random message
      const selectedMessage = messagePool[Math.floor(Math.random() * messagePool.length)];
      
      // Tentukan foto yang akan ditampilkan di bubble
      let photoPath;
      if (currentMode === "arona") {
        photoPath = outfits.arona[currentOutfit] || "assets/images/arona.png";
      } else if (currentMode === "plana") {
        photoPath = outfits.plana[currentOutfit] || "assets/images/plana.png";
      } else if (currentMode === "hina") {
        photoPath = outfits.hina[currentOutfit] || "assets/images/hina_dress.jpg";
      }
      
      // Tentukan warna border berdasarkan mode
      let borderColor;
      if (currentMode === "arona") borderColor = "#38bdf8";
      else if (currentMode === "plana") borderColor = "#c084fc";
      else borderColor = "#a78bfa";
      
      // Buat bubble dengan foto
      // Buat bubble dengan foto - SUDAH DIPERBAIKI
      bubble.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; background: white; border-radius: 16px; padding: 6px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
              <img src="${photoPath}" 
                  class="bubble-avatar" 
                  style="border-color: ${borderColor};"
                  onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'20\' fill=\'%23${borderColor.replace('#', '')}\'/%3E%3Ctext x=\'20\' y=\'25\' text-anchor=\'middle\' fill=\'white\' font-size=\'12\'%3E${currentMode.charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E'">
              <span style="font-size: 13px; color: #333; font-weight: 500; max-width: 180px;">${selectedMessage}</span>
          </div>
      `;
      
      bubble.classList.add("show");
      setTimeout(() => bubble.classList.remove("show"), 5000);
    }

    // ============================================================
    // NOTIFICATION
    // ============================================================
    function showNotification(title, message, type = "info") {
      const n = document.getElementById("notification");
      const nt = document.getElementById("notification-title");
      const nm = document.getElementById("notification-message");
      if (!n || !nt || !nm) return;
      nt.textContent = title; nm.textContent = message;
      n.className = `notification ${type}`;
      n.style.display = "block";
      n.classList.add("show");
      clearTimeout(n._timeout);
      n._timeout = setTimeout(() => { n.classList.remove("show"); setTimeout(() => n.style.display="none", 500); }, 5000);
      if (type === "success") playCompletionSound();
    }

    function playCompletionSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.value = 800; osc.type = "sine";
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 1);
      } catch(e) {}
    }

    function createConfettiEffect() {
      const colors = currentMode==="arona" ? ["#38bdf8","#0ea5e9","#7dd3fc","#bae6fd"] : 
                     currentMode==="plana" ? ["#c084fc","#a855f7","#d8b4fe","#f3e8ff"] : 
                     ["#a78bfa","#7c3aed","#ddd6fe","#ede9fe"];
      for (let i = 0; i < 30; i++) { // Reduced from 50 to 30
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.setProperty("--confetti-color", colors[Math.floor(Math.random()*colors.length)]);
        c.style.left = Math.random()*100 + "vw"; c.style.top = "-10px";
        c.style.transform = `rotate(${Math.random()*360}deg)`;
        document.body.appendChild(c);
        c.animate([{transform:"translateY(0) rotate(0deg)",opacity:1},{transform:`translateY(${window.innerHeight}px) rotate(${Math.random()*360}deg)`,opacity:0}],{duration:2000+Math.random()*1000,easing:"cubic-bezier(0.1,0.8,0.3,1)"});
        setTimeout(() => { if (c.parentNode) c.remove(); }, 3000);
      }
    }

    // ============================================================
    // PROGRESS SAVE / LOAD
    // ============================================================
    function backupProgress(p) { safeSave("progress_backup", { data:p, timestamp:Date.now(), version:"1.1.0" }); }
    function restoreBackup() { const b = safeLoad("progress_backup"); return b?.data || null; }
    function saveStudyMetrics() { safeSave("studyMetrics", studyMetrics); }
    function loadStudyMetrics() { const m = safeLoad("studyMetrics"); if (m) Object.assign(studyMetrics, m); }

    function loadProgress() {
      let saved = safeLoad(`${currentMode}Progress`) || restoreBackup();
      if (saved) {
        progress = saved;
        if (!Array.isArray(progress.dailySessions)) progress.dailySessions = Array(8).fill(false);
        if (!Array.isArray(progress.studyHistory)) progress.studyHistory = [];
        if (typeof progress.bestStreak === "undefined") progress.bestStreak = 0;
        const today = new Date().toDateString();
        if (progress.lastSession && new Date(progress.lastSession).toDateString() !== today) {
          progress.dailySessions = Array(8).fill(false);
        }
        if (typeof progress.streak === "undefined") progress.streak = 0;
      }
      document.getElementById("completed-sessions").textContent = progress.completedSessions;
      document.getElementById("total-study-time").textContent = Math.floor(progress.totalStudyTime / 60);
      updateDailyProgressBar();
      updateStreakDisplayEnhanced();
      return progress;
    }

    function saveProgress(p) {
      backupProgress(p);
      safeSave(`${currentMode}Progress`, p);
      document.getElementById("completed-sessions").textContent = p.completedSessions;
      document.getElementById("total-study-time").textContent = Math.floor(p.totalStudyTime / 60);
      updateDailyProgressBar();
      hasUnsavedChanges = true;
    }

    function saveAchievements() { safeSave(`${currentMode}Achievements`, achievements); }
    function loadAchievements() {
      const saved = safeLoad(`${currentMode}Achievements`);
      if (saved) Object.keys(saved).forEach(k => { if (achievements[k]) achievements[k].unlocked = saved[k].unlocked; });
      updateAchievementsUI();
    }

    // ============================================================
    // AUDIO
    // ============================================================
    const audioPlayer = document.getElementById("audio-player");
    const playPauseBtn = document.getElementById("play-pause-btn");
    const playIcon = document.getElementById("play-icon");
    const pauseIcon = document.getElementById("pause-icon");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const volumeSlider = document.getElementById("volume-slider");
    const progressFill = document.getElementById("progress-fill");
    const currentTimeEl = document.getElementById("current-time");
    const totalTimeEl = document.getElementById("total-time");
    const currentTrackDisplay = document.getElementById("current-track-display");
    const currentArtistEl = document.getElementById("current-artist");

    const playlist = [
      { title:"Lo-fi Study Beats", artist:"Chill Anime Mix", src:"./assets/music/lofi-study.mp3", duration:"01:00:29" },
      { title:"Rainy Night Coding", artist:"Jazz Hop", src:"./assets/music/rainy-coding.mp3", duration:"01:02:14" },
      { title:"Coffee Shop Vibes", artist:"Acoustic Lo-fi", src:"./assets/music/coffee-vibes.mp3", duration:"00:32:22" },
    ];

    const audioFallbacks = {
      "lofi-study.mp3": ["https://cdn.pixabay.com/download/audio/2022/03/15/audio_d17187f128.mp3","https://assets.mixkit.co/music/preview/mixkit-chill-abstract-loop-229.mp3"],
      "rainy-coding.mp3": ["https://cdn.pixabay.com/download/audio/2022/11/16/audio_8c97a94dbf.mp3","https://assets.mixkit.co/music/preview/mixkit-rainy-jazz-229.mp3"],
      "coffee-vibes.mp3": ["https://cdn.pixabay.com/download/audio/2022/10/25/audio_1e779eb41f.mp3","https://assets.mixkit.co/music/preview/mixkit-coffee-shop-ambience-230.mp3"],
    };

    let currentTrackIndex = 0;
    let isMusicPlaying = false;
    let currentFallbackIndex = 0;

    const savedVolume = safeLoad("musicVolume");
    audioPlayer.volume = savedVolume !== null ? parseFloat(savedVolume) : 0.7;
    volumeSlider.value = audioPlayer.volume * 100;

    audioPlayer.addEventListener("error", function handleAudioError(e) {
      const track = playlist[currentTrackIndex];
      const filename = track.src.split("/").pop();
      const fallbacks = audioFallbacks[filename] || [];
      if (currentFallbackIndex < fallbacks.length) {
        this.src = fallbacks[currentFallbackIndex++];
        if (isMusicPlaying) this.play().catch(()=>{});
      } else {
        currentFallbackIndex = 0;
        setTimeout(() => playTrack((currentTrackIndex+1) % playlist.length), 2000);
      }
    });

    function updatePlaylistNumbers() {
      document.querySelectorAll("[data-track]").forEach(item => {
        const idx = parseInt(item.getAttribute("data-track"));
        const num = item.querySelector(".playlist-number");
        if (idx === currentTrackIndex) {
          num.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>';
          num.className = "playlist-number playlist-active";
          item.setAttribute("aria-selected","true");
        } else {
          num.textContent = idx+1; num.className = "playlist-number playlist-inactive";
          item.setAttribute("aria-selected","false");
        }
      });
    }

    playPauseBtn.addEventListener("click", () => {
      if (isMusicPlaying) {
        audioPlayer.pause(); isMusicPlaying = false;
        playIcon.classList.remove("hidden"); pauseIcon.classList.add("hidden");
        playPauseBtn.setAttribute("aria-label","Play music"); playPauseBtn.setAttribute("aria-pressed","false");
      } else {
        if (!audioPlayer.src) playTrack(currentTrackIndex);
        audioPlayer.play().then(() => {
          isMusicPlaying = true;
          playIcon.classList.add("hidden"); pauseIcon.classList.remove("hidden");
          playPauseBtn.setAttribute("aria-label","Pause music"); playPauseBtn.setAttribute("aria-pressed","true");
        }).catch(e => { showNotification("Music Error", "Cannot play audio. Please check your music files."); });
      }
    });

    volumeSlider.addEventListener("input", () => {
      audioPlayer.volume = volumeSlider.value / 100;
      safeSave("musicVolume", audioPlayer.volume);
    });

    audioPlayer.addEventListener("timeupdate", () => {
      if (audioPlayer.duration) {
        const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressFill.style.width = `${pct}%`;
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        totalTimeEl.textContent = formatTime(audioPlayer.duration);
      }
    });

    progressFill.parentElement.addEventListener("click", (e) => {
      if (audioPlayer.duration) {
        const r = e.target.getBoundingClientRect();
        audioPlayer.currentTime = ((e.clientX - r.left) / r.width) * audioPlayer.duration;
      }
    });

    document.querySelectorAll("[data-track]").forEach(item => {
      item.addEventListener("click", () => playTrack(parseInt(item.getAttribute("data-track"))));
    });

    prevBtn.addEventListener("click", () => playTrack((currentTrackIndex-1+playlist.length) % playlist.length));
    nextBtn.addEventListener("click", () => playTrack((currentTrackIndex+1) % playlist.length));
    audioPlayer.addEventListener("ended", () => playTrack((currentTrackIndex+1) % playlist.length));

    function playTrack(index) {
      currentTrackIndex = index;
      const track = playlist[index];
      if (currentTrackDisplay) currentTrackDisplay.textContent = track.title;
      if (currentArtistEl) currentArtistEl.textContent = track.artist;
      if (totalTimeEl) totalTimeEl.textContent = track.duration;
      currentFallbackIndex = 0;
      audioPlayer.src = track.src;
      updatePlaylistNumbers();
      document.querySelectorAll("[data-track]").forEach(item => {
        const isActive = parseInt(item.getAttribute("data-track")) === index;
        item.classList.toggle("bg-primary-opacity", isActive);
      });
      if (isMusicPlaying) audioPlayer.play().catch(() => { isMusicPlaying = false; });
    }

    function formatTime(s) {
      if (isNaN(s)) return "0:00";
      return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,"0")}`;
    }

    // ============================================================
    // TIMER
    // ============================================================
    const timerDisplay = document.getElementById("timer-display");
    const startTimerBtn = document.getElementById("start-timer");
    const resetTimerBtn = document.getElementById("reset-timer");
    const timerButtons = document.querySelectorAll("[data-time]");
    const timerTitle = document.getElementById("timer-title");
    const currentCycleEl = document.getElementById("current-cycle");
    const sessionProgressEl = document.getElementById("session-progress");

    const pomodoroCycles = [
      { type:"focus", duration:25*60, title:"Focus Session" },
      { type:"short-break", duration:5*60, title:"Short Break" },
      { type:"focus", duration:25*60, title:"Focus Session" },
      { type:"short-break", duration:5*60, title:"Short Break" },
      { type:"focus", duration:25*60, title:"Focus Session" },
      { type:"long-break", duration:15*60, title:"Long Break" },
    ];

    let timerInterval;
    let timeLeft = pomodoroCycles[0].duration;
    let isRunning = false;
    let currentCycleIndex = 0;
    let hasStarted = false;

    const liveRegion = document.createElement("div");
    liveRegion.setAttribute("aria-live","polite"); liveRegion.setAttribute("aria-atomic","true");
    liveRegion.className = "sr-only"; document.body.appendChild(liveRegion);
    function announceTimerChange(msg) { liveRegion.textContent = msg; setTimeout(() => liveRegion.textContent = "", 1000); }

    function initializeSessionProgress() {
      if (!sessionProgressEl) return;
      sessionProgressEl.innerHTML = "";
      pomodoroCycles.forEach((cycle, i) => {
        const c = document.createElement("div");
        c.className = `session-circle ${i===currentCycleIndex?"session-current":"session-pending"}`;
        c.title = `${cycle.title} (${Math.floor(cycle.duration/60)} min)`;
        sessionProgressEl.appendChild(c);
      });
    }
    initializeSessionProgress();

    function updateStartButtonText() {
      if (!startTimerBtn) return;
      if (!hasStarted && !isRunning) { startTimerBtn.textContent = "Start"; startTimerBtn.setAttribute("aria-label","Start timer"); }
      else if (isRunning) { startTimerBtn.textContent = "Pause"; startTimerBtn.setAttribute("aria-label","Pause timer"); }
      else { startTimerBtn.textContent = "Continue"; startTimerBtn.setAttribute("aria-label","Continue timer"); }
    }

    timerButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        clearInterval(timerInterval); isRunning = false; hasStarted = false;
        timeLeft = parseInt(btn.getAttribute("data-time")) * 60;
        updateTimerDisplay(); updateStartButtonText();
        timerButtons.forEach(b => { b.classList.remove("bg-primary","text-white"); b.classList.add("bg-primary-opacity"); b.setAttribute("aria-pressed","false"); });
        btn.classList.add("bg-primary","text-white"); btn.classList.remove("bg-primary-opacity"); btn.setAttribute("aria-pressed","true");
      });
    });

    startTimerBtn.addEventListener("click", () => {
      if (!isRunning) {
        actuallyStartTimer();
      } else {
        isRunning = false; updateStartButtonText(); clearInterval(timerInterval);
        announceTimerChange("Timer paused.");
      }
    });

    function actuallyStartTimer() {
      isRunning = true; hasStarted = true; updateStartButtonText();
      const isFocus = pomodoroCycles[currentCycleIndex].type === "focus";
      if (isFocus) {
        triggerCharacterReaction("session_start");
        studyMetrics.focusSessions.push({ startTime: new Date().toISOString(), duration: pomodoroCycles[currentCycleIndex].duration/60 });
        saveStudyMetrics();
      } else {
        triggerCharacterReaction("break_time");
        studyMetrics.breaks.push({ startTime: new Date().toISOString(), duration: pomodoroCycles[currentCycleIndex].duration/60 });
        saveStudyMetrics();
      }
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          clearInterval(timerInterval); isRunning = false; hasStarted = false; updateStartButtonText();
          if (pomodoroCycles[currentCycleIndex].type === "focus") {
            progress.completedSessions++;
            progress.totalStudyTime += pomodoroCycles[currentCycleIndex].duration;
            progress.lastSession = new Date().toISOString();
            const si = progress.completedSessions % 8;
            if (si < progress.dailySessions.length) progress.dailySessions[si] = true;
            if (studyMetrics.focusSessions.length > 0) studyMetrics.focusSessions[studyMetrics.focusSessions.length-1].endTime = new Date().toISOString();
            studyMetrics.productivityPatterns.push({ date: new Date().toISOString().split("T")[0], productivity: calculateProductivityScore(), sessions: progress.completedSessions });
            saveStudyMetrics();
            updateStreak();
            saveProgress(progress);
            checkAchievements();
            triggerCharacterReaction("session_complete");
            announceTimerChange("Focus session complete! Time for a break.");
            setTimeout(showReflectionModal, 800); // Show reflection modal instead of journal
          } else {
            triggerCharacterReaction("break_time");
            announceTimerChange("Break time over! Ready for next focus session.");
          }
          currentCycleIndex = (currentCycleIndex+1) % pomodoroCycles.length;
          timeLeft = pomodoroCycles[currentCycleIndex].duration;
          if (timerTitle) timerTitle.textContent = pomodoroCycles[currentCycleIndex].title;
          if (currentCycleEl) { currentCycleEl.textContent = `${currentCycleIndex+1}/${pomodoroCycles.length}`; currentCycleEl.setAttribute("aria-label",`Current session ${currentCycleIndex+1} of ${pomodoroCycles.length}`); }
          initializeSessionProgress(); updateTimerDisplay();
        }
      }, 1000);
    }

    resetTimerBtn.addEventListener("click", () => {
      clearInterval(timerInterval); isRunning = false; hasStarted = false; updateStartButtonText();
      currentCycleIndex = 0; timeLeft = pomodoroCycles[0].duration;
      if (timerTitle) timerTitle.textContent = pomodoroCycles[0].title;
      if (currentCycleEl) { currentCycleEl.textContent = `1/${pomodoroCycles.length}`; currentCycleEl.setAttribute("aria-label","Current session 1 of "+pomodoroCycles.length); }
      initializeSessionProgress(); updateTimerDisplay();
      announceTimerChange("Timer reset to beginning.");
      timerButtons.forEach(b => { b.classList.remove("bg-primary","text-white"); b.classList.add("bg-primary-opacity"); b.setAttribute("aria-pressed","false"); });
      timerButtons[0].classList.add("bg-primary","text-white"); timerButtons[0].classList.remove("bg-primary-opacity"); timerButtons[0].setAttribute("aria-pressed","true");
    });

    function updateTimerDisplay() {
      if (!timerDisplay) return;
      const m = Math.floor(timeLeft/60), s = timeLeft%60;
      timerDisplay.textContent = `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
      document.title = `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")} - ${timerTitle?timerTitle.textContent:"Focus Session"} | ${currentMode==="arona"?"Arona": currentMode==="plana"?"Plana":"Hina"}`;
    }

    // ============================================================
    // KEYBOARD SHORTCUTS
    // ============================================================
    document.addEventListener("keydown", (e) => {
      if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
      if (e.ctrlKey && e.key === " ") { e.preventDefault(); document.getElementById("play-pause-btn").click(); }
      if (e.key === "Escape") {
        document.querySelectorAll(".analytics-modal,.share-modal,.todo-modal,.session-reflection-modal").forEach(m => m.classList.remove("show"));
      }
      if (e.key === " " && !e.ctrlKey) { e.preventDefault(); document.getElementById("start-timer").click(); }
      if (e.key === "r" || e.key === "R") document.getElementById("reset-timer").click();
    });

    // ============================================================
    // CHARACTER DRAG
    // ============================================================
    const characterImg = document.getElementById("character-image");
    const charContainer = document.getElementById("character-container");
    let isDragging = false;
    let startX = 0;
    let currentOutfit = 0;
    let dragMoved = false;

    const outfits = {
        arona: ["assets/images/arona.png", "assets/images/arona_maid.png"], // HAPUS yukata, TAMBAH maid
        plana: ["assets/images/plana.png", "assets/images/plana_maid.png"], // HAPUS bunny & kimono, TAMBAH maid
        hina: ["assets/images/hina_dress.png", "assets/images/hina_maid.jpg"], // TETAP
    };

    const aronaOutfitKeys = ["default", "maid"];

    const aronaOutfitMessages = {
      default: [
        "Arona is in her usual outfit today! Let's do our best, Sensei! ",
        "Simple outfit, but full energy! Arona is ready! ",
        "Hehe~ Arona is always ready to support you, Sensei! "
      ],
      maid: [
        "Ehehe~ Maid Arona reporting for duty, Sensei! ",
        "Gokigenyou, Sensei~ Arona will take care of everything today! ",
        "Arona is your special maid today! Leave it to me! ",
        "Maid Arona will make sure you stay focused! ",
        "Do you like this outfit, Sensei? Arona feels extra cute! "
      ]
    };

    const planaOutfitKeys = ["default", "maid"];

    const planaOutfitMessages = {
      default: [
        "This is all Plana has... but it is enough... ",
        "A simple outfit... for a quiet journey of learning... ",
        "Plana feels at ease like this... do you feel the same, Sensei? "
      ],
      maid: [
        "Plana... will serve as your maid today... ",
        "M-maid Plana... is this acceptable, Sensei...? ",
        "Plana chose this... just for you... ",
        "Plana will stay by your side... and support your focus... ",
        "This outfit... feels unfamiliar... but warm... "
      ]
    };
    
    const hinaOutfitKeys = ["dress", "maid"];

    const hinaOutfitMessages = {
      dress: [
        "Hina... is wearing a dress today... just for you... ",
        "This dress... Hina chose it carefully... ",
        "It makes Hina feel... a little more confident... ",
        "Sensei... does it look nice?... Hina is a bit nervous... ",
        "This color... Hina likes it... it feels calm... "
      ],
      maid: [
        "Hina... will serve you today... as your maid... ",
        "M-maid Hina... will do her best... ",
        "Hina chose this... for you... ",
        "Hina will stay by your side... while you study... ",
        "This outfit... is a little embarrassing... but... Hina will try... "
      ]
    };

  function changeOutfit(direction) {
    const bubble = document.getElementById("character-bubble");
    if (!bubble) return;
    
    if (outfits[currentMode].length <= 1) {
      let selected;
    if (currentMode === "arona") {
        const outfitKey = aronaOutfitKeys[currentOutfit] || "default";
        const messages = aronaOutfitMessages[outfitKey];
        const selected = messages[Math.floor(Math.random() * messages.length)];
        const photoPath = outfits.arona[currentOutfit] || "assets/images/arona.png";
        
        //  GANTI DENGAN INI (style baru)
        bubble.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; background: white; border-radius: 16px; padding: 6px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <img src="${photoPath}" class="bubble-avatar" style="border-color: #38bdf8;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'20\' fill=\'%2338bdf8\'/%3E%3Ctext x=\'20\' y=\'25\' text-anchor=\'middle\' fill=\'white\' font-size=\'12\'%3EA%3C/text%3E%3C/svg%3E'">
                <span style="font-size: 13px; color: #333; font-weight: 500;">${selected}</span>
            </div>
        `;
    }
      
      bubble.classList.add("show"); 
      setTimeout(() => bubble.classList.remove("show"), 3000); 
      return;
    }
    
    currentOutfit = (currentOutfit + direction + outfits[currentMode].length) % outfits[currentMode].length;
    if (characterImg) { 
      characterImg.src = outfits[currentMode][currentOutfit]; 
      safeSave(`${currentMode}Outfit`, currentOutfit); 
    }
    
    if (currentMode === "arona") {
        const outfitKey = aronaOutfitKeys[currentOutfit] || "default";
        const messages = aronaOutfitMessages[outfitKey];
        const selected = messages[Math.floor(Math.random() * messages.length)];
        const photoPath = outfits.arona[currentOutfit] || "assets/images/arona.png";
        
        //  GANTI DENGAN INI (style baru)
        bubble.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; background: white; border-radius: 16px; padding: 6px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <img src="${photoPath}" class="bubble-avatar" style="border-color: #38bdf8;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'20\' fill=\'%2338bdf8\'/%3E%3Ctext x=\'20\' y=\'25\' text-anchor=\'middle\' fill=\'white\' font-size=\'12\'%3EA%3C/text%3E%3C/svg%3E'">
                <span style="font-size: 13px; color: #333; font-weight: 500;">${selected}</span>
            </div>
        `;

    } else if (currentMode === "plana") {
      const key = planaOutfitKeys[currentOutfit] || "default";
      const msgs = planaOutfitMessages[key];
      const selected = msgs[Math.floor(Math.random() * msgs.length)];
      const photoPath = outfits.plana[currentOutfit] || "assets/images/plana.png";
      
      bubble.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; background: white; border-radius: 16px; padding: 6px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
              <img src="${photoPath}" class="bubble-avatar" style="border-color: #c084fc;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'20\' fill=\'%23c084fc\'/%3E%3Ctext x=\'20\' y=\'25\' text-anchor=\'middle\' fill=\'white\' font-size=\'12\'%3EP%3C/text%3E%3C/svg%3E'">
              <span style="font-size: 13px; color: #333; font-weight: 500;">${selected}</span>
          </div>
      `;
      
    } else if (currentMode === "hina") {
      const key = hinaOutfitKeys[currentOutfit] || "dress";
      const msgs = hinaOutfitMessages[key];
      const selected = msgs[Math.floor(Math.random() * msgs.length)];
      const photoPath = outfits.hina[currentOutfit] || "assets/images/hina_dress.jpg";
      
      bubble.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; background: white; border-radius: 16px; padding: 6px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
              <img src="${photoPath}" class="bubble-avatar" style="border-color: #a78bfa;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'20\' fill=\'%23a78bfa\'/%3E%3Ctext x=\'20\' y=\'25\' text-anchor=\'middle\' fill=\'white\' font-size=\'12\'%3EH%3C/text%3E%3C/svg%3E'">
              <span style="font-size: 13px; color: #333; font-weight: 500;">${selected}</span>
          </div>
      `;
    }
    
    bubble.classList.add("show"); 
    setTimeout(() => bubble.classList.remove("show"), 3000);
  }

    if (charContainer) {
      charContainer.addEventListener("mousedown", (e) => {
        isDragging = true; dragMoved = false; startX = e.clientX;
        charContainer.classList.add("dragging"); e.preventDefault();
      });
      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        if (Math.abs(dx) > 10) { dragMoved = true; charContainer.style.transform = `scale(1.05) translateX(${dx*0.3}px)`; charContainer.style.transition = "none"; }
      });
      document.addEventListener("mouseup", (e) => {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        if (Math.abs(dx) > 50) { changeOutfit(dx > 0 ? 1 : -1); }
        charContainer.style.transform = ""; charContainer.style.transition = "";
        charContainer.classList.remove("dragging");
        isDragging = false;
        if (!dragMoved) triggerCharacterReaction("greeting");
        dragMoved = false;
      });
      charContainer.addEventListener("touchstart", (e) => {
        isDragging = true; dragMoved = false; startX = e.touches[0].clientX;
        charContainer.classList.add("dragging"); e.preventDefault();
      }, { passive: false });
      document.addEventListener("touchmove", (e) => {
        if (!isDragging) return;
        const dx = e.touches[0].clientX - startX;
        if (Math.abs(dx) > 10) { dragMoved = true; charContainer.style.transform = `scale(1.05) translateX(${dx*0.3}px)`; charContainer.style.transition = "none"; }
      });
      document.addEventListener("touchend", (e) => {
        if (!isDragging) return;
        const dx = e.changedTouches[0].clientX - startX;
        if (Math.abs(dx) > 50) { changeOutfit(dx > 0 ? 1 : -1); }
        else if (!dragMoved) { triggerCharacterReaction("greeting"); }
        charContainer.style.transform = ""; charContainer.style.transition = "";
        charContainer.classList.remove("dragging"); isDragging = false; dragMoved = false;
      });
      charContainer.addEventListener("dragstart", e => e.preventDefault());
      charContainer.addEventListener("mouseenter", () => { if (!isDragging) charContainer.style.transform = "scale(1.05)"; });
      charContainer.addEventListener("mouseleave", () => { if (!isDragging) charContainer.style.transform = "scale(1)"; });
      charContainer.addEventListener("keydown", (e) => { if (e.key==="Enter"||e.key===" ") { e.preventDefault(); triggerCharacterReaction("greeting"); } });
    }

    // ============================================================
    // ANALYTICS MODAL
    // ============================================================
    document.getElementById("analytics-btn").addEventListener("click", showAnalytics);
    document.getElementById("close-analytics").addEventListener("click", () => document.getElementById("analytics-modal").classList.remove("show"));
    document.getElementById("analytics-modal").addEventListener("click", (e) => { if (e.target.id==="analytics-modal") document.getElementById("analytics-modal").classList.remove("show"); });

    // ============================================================
    // THEME TOGGLE
    // ============================================================
    const themeToggleBtn = document.getElementById("theme-toggle-btn");
    const sunIcon = document.getElementById("sun-icon");
    const moonIcon = document.getElementById("moon-icon");
    const hinaIcon = document.getElementById("hina-icon");
    const body = document.body;
    const splashLogo = document.getElementById("splash-logo");
    const appTitle = document.getElementById("app-title");
    const splashScreen = document.getElementById("splash-screen");

    function createParticleEffect(el) {
      const r = el.getBoundingClientRect();
      const cx = r.left + r.width/2, cy = r.top + r.height/2;
      for (let i = 0; i < 12; i++) {
        const p = document.createElement("div");
        p.className = "particle";
        p.style.left = cx+"px"; p.style.top = cy+"px";
        p.style.setProperty("--tx", (Math.random()-0.5)*150+"px");
        document.body.appendChild(p);
        p.style.animation = "particle-float 1.2s ease-out forwards";
        setTimeout(() => { if (p.parentNode) p.remove(); }, 1200);
      }
    }

    function applyAronaThemeImmediately() {
      const img = document.getElementById("character-image");
      body.className = "theme-arona bg-pattern";
      if (splashScreen) splashScreen.className = "theme-arona";
      if (splashLogo) { splashLogo.textContent = "Arona Blue Archive"; splashLogo.className = "splash-logo theme-arona"; }
      if (sunIcon) sunIcon.classList.remove("hidden"); 
      if (moonIcon) moonIcon.classList.add("hidden");
      if (hinaIcon) hinaIcon.classList.add("hidden");
      if (img) img.src = "assets/images/arona.png";
      if (appTitle) appTitle.textContent = "Arona Study Companion";
      currentMode = "arona";
    }

    function applyPlanaThemeImmediately() {
      const img = document.getElementById("character-image");
      body.className = "theme-plana bg-pattern";
      if (splashScreen) splashScreen.className = "theme-plana";
      if (splashLogo) { splashLogo.textContent = "Plana Blue Archive"; splashLogo.className = "splash-logo theme-plana"; }
      if (sunIcon) sunIcon.classList.add("hidden"); 
      if (moonIcon) moonIcon.classList.remove("hidden");
      if (hinaIcon) hinaIcon.classList.add("hidden");
      if (img) img.src = "assets/images/plana.png";
      if (appTitle) appTitle.textContent = "Plana Study Companion";
      currentMode = "plana";
    }

    function applyHinaThemeImmediately() {
      const img = document.getElementById("character-image");
      body.className = "theme-hina bg-pattern";
      if (splashScreen) splashScreen.className = "theme-hina";
      if (splashLogo) { splashLogo.textContent = "Hina Blue Archive"; splashLogo.className = "splash-logo theme-hina"; }
      if (sunIcon) sunIcon.classList.add("hidden");
      if (moonIcon) moonIcon.classList.add("hidden");
      if (hinaIcon) hinaIcon.classList.remove("hidden");
      if (img) img.src = "assets/images/hina_dress.jpg"; // UBAH KE DRESS
      if (appTitle) appTitle.textContent = "Hina Study Companion";
      currentMode = "hina";
    }

    function switchTheme(toMode) {
      document.querySelectorAll(".fade-text").forEach(el => el.style.opacity = "0");
      setTimeout(() => {
        if (toMode === "arona") {
          body.classList.remove("theme-plana", "theme-hina"); body.classList.add("theme-arona");
          if (sunIcon) sunIcon.classList.remove("hidden"); 
          if (moonIcon) moonIcon.classList.add("hidden");
          if (hinaIcon) hinaIcon.classList.add("hidden");
          document.getElementById("character-image").src = "assets/images/arona.png";
          appTitle.textContent = "Arona Study Companion";
          currentMode = "arona";
        } else if (toMode === "plana") {
          body.classList.remove("theme-arona", "theme-hina"); body.classList.add("theme-plana");
          if (sunIcon) sunIcon.classList.add("hidden"); 
          if (moonIcon) moonIcon.classList.remove("hidden");
          if (hinaIcon) hinaIcon.classList.add("hidden");
          document.getElementById("character-image").src = "assets/images/plana.png";
          appTitle.textContent = "Plana Study Companion";
          currentMode = "plana";
        } else {
          body.classList.remove("theme-arona", "theme-plana"); body.classList.add("theme-hina");
          if (sunIcon) sunIcon.classList.add("hidden");
          if (moonIcon) moonIcon.classList.add("hidden");
          if (hinaIcon) hinaIcon.classList.remove("hidden");
          document.getElementById("character-image").src = "assets/images/hina_dress.jpg"; // UBAH KE DRESS
          appTitle.textContent = "Hina Study Companion";
          currentMode = "hina";
        }
        safeSave("studyCompanionMode", toMode);
        currentOutfit = 0;
        const savedOutfit = safeLoad(`${currentMode}Outfit`);
        if (savedOutfit !== null) {
          currentOutfit = parseInt(savedOutfit);
          const img = document.getElementById("character-image");
          if (img && outfits[currentMode][currentOutfit]) img.src = outfits[currentMode][currentOutfit];
        }
        loadAchievements();
        triggerCharacterReaction("greeting");
        setTimeout(() => {
          document.querySelectorAll(".fade-text").forEach(el => el.style.opacity = "1");
        }, 400);
      }, 400);
    }

    themeToggleBtn.addEventListener("click", () => {
      createParticleEffect(themeToggleBtn);
      if (currentMode === "arona") switchTheme("plana");
      else if (currentMode === "plana") switchTheme("hina");
      else switchTheme("arona");
    });

    // ============================================================
    // ONLINE / OFFLINE
    // ============================================================
    let isOnline = navigator.onLine;
    window.addEventListener("online", () => { isOnline = true; showNotification("Back Online", "Connection restored!", "success"); while(offlineQueue.length) offlineQueue.shift()(); });
    window.addEventListener("offline", () => { isOnline = false; showNotification("Offline Mode", "Some features limited", "info"); });

    // ============================================================
    // PWA
    // ============================================================
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try { const reg = await navigator.serviceWorker.register("/sw.js"); } catch(e) { console.log("SW failed:", e); }
      });
    }

    // ============================================================
    // AUTO SAVE
    // ============================================================
    function autoSaveProgress() {
      setInterval(() => {
        if (hasUnsavedChanges) { saveProgress(progress); hasUnsavedChanges = false; }
      }, 30000);
    }

    // ============================================================
    // IMAGE FALLBACK
    // ============================================================
    const charImageEl = document.getElementById("character-image");
    if (charImageEl) {
      charImageEl.addEventListener("error", function() {
        const svgString = `<svg width="320" height="384" viewBox="0 0 320 384" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="320" height="384" rx="16" fill="${currentMode === "arona" ? "#38bdf8" : currentMode === "plana" ? "#c084fc" : "#a78bfa"}"/>
          <circle cx="160" cy="150" r="40" fill="white" fill-opacity="0.9"/>
          <text x="160" y="260" text-anchor="middle" fill="white" font-family="Arial" font-size="24">
            ${currentMode === "arona" ? "Arona" : currentMode === "plana" ? "Plana" : "Hina"}
          </text>
        </svg>`;
        const encodedSvg = btoa(unescape(encodeURIComponent(svgString)));
        this.src = `data:image/svg+xml;base64,${encodedSvg}`;
      });
    }

    // ============================================================
    // INIT
    // ============================================================
    function initializeApp() {
      const savedMode = safeLoad("studyCompanionMode") || "arona";
      if (savedMode === "arona") applyAronaThemeImmediately();
      else if (savedMode === "plana") applyPlanaThemeImmediately();
      else applyHinaThemeImmediately();

      progress = loadProgress();
      loadAchievements();
      loadStudyMetrics();
      loadTodos();
      renderTodoMini();
      updateAchievementsUI();
      updateDailyProgressBar();
      updateStreakDisplayEnhanced();

      playTrack(0);

      if (timerButtons[0]) {
        timerButtons[0].classList.add("bg-primary","text-white"); timerButtons[0].classList.remove("bg-primary-opacity"); timerButtons[0].setAttribute("aria-pressed","true");
      }

      updatePlaylistNumbers();
      updateStartButtonText();

      const savedOutfit = safeLoad(`${currentMode}Outfit`);
      if (savedOutfit !== null) {
        currentOutfit = parseInt(savedOutfit);
        const img = document.getElementById("character-image");
        if (img && outfits[currentMode][currentOutfit]) img.src = outfits[currentMode][currentOutfit];
      }

      autoSaveProgress();

      setTimeout(() => {
        if (splashScreen) {
          splashScreen.style.opacity = "0"; splashScreen.style.transform = "scale(1.1)";
          setTimeout(() => {
            splashScreen.style.display = "none";
            document.querySelectorAll(".page-transition").forEach(el => el.classList.add("page-loaded"));
            if ("Notification" in window && Notification.permission === "default") Notification.requestPermission();
            triggerCharacterReaction("greeting");
          }, 1000);
        }
      }, 2000);
    }

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", initializeApp);
    else initializeApp();
    </script>
  </body>
</html>